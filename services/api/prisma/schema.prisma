generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model annotation_comments {
  id           String           @id @default(uuid())
  highlight_id String
  user_id      String
  text         String
  status       AnnotationStatus @default(ACTIVE)
  deleted_at   DateTime?
  created_at   DateTime         @default(now())
  updated_at   DateTime         @updatedAt

  highlights highlights @relation(fields: [highlight_id], references: [id], onDelete: Cascade)
  users      users      @relation(fields: [user_id], references: [id])

  @@index([highlight_id])
  @@index([status])
  @@index([user_id])
}

model annotation_shares {
  annotation_id String
  context_type  ShareContextType
  context_id    String

  mode AnnotationShareMode @default(VIEW)

  created_by String?
  created_at DateTime @default(now())

  annotations annotations @relation(fields: [annotation_id], references: [id], onDelete: Cascade)

  @@id([annotation_id, context_type, context_id])
  @@index([context_type, context_id])
}

model annotations {
  id                String               @id @default(uuid())
  content_id        String
  user_id           String? // ✅ Issue #7: Nullable to preserve audit trail
  type              AnnotationType
  start_offset      Int
  end_offset        Int
  selected_text     String?
  text              String?
  color             String?
  visibility        AnnotationVisibility
  group_id          String?
  parent_id         String?
  is_favorite       Boolean              @default(false)
  created_at        DateTime             @default(now())
  updated_at        DateTime             @updatedAt
  contents          contents             @relation(fields: [content_id], references: [id], onDelete: Cascade)
  study_groups      study_groups?        @relation(fields: [group_id], references: [id], onDelete: Cascade)
  annotations       annotations?         @relation("annotationsToannotations", fields: [parent_id], references: [id], onDelete: Cascade)
  other_annotations annotations[]        @relation("annotationsToannotations")
  users             users?               @relation(fields: [user_id], references: [id], onDelete: SetNull) // ✅ Issue #7: Preserve annotations
  annotation_shares annotation_shares[]

  @@index([content_id])
  @@index([group_id])
  @@index([user_id])
}

model app_configs {
  id          String       @id @default(uuid())
  key         String       @unique
  value       String
  type        ConfigType
  category    String
  environment Environment?
  description String?
  metadata    Json?
  created_by  String?
  updated_by  String?
  created_at  DateTime     @default(now())
  updated_at  DateTime     @updatedAt

  @@index([category])
  @@index([environment])
  @@index([key])
}

model assessment_answers {
  id                    String  @id @default(uuid())
  assessment_attempt_id String
  question_id           String
  user_answer           Json
  is_correct            Boolean
  time_spent_seconds    Int?

  assessment_attempts  assessment_attempts  @relation(fields: [assessment_attempt_id], references: [id])
  assessment_questions assessment_questions @relation(fields: [question_id], references: [id])
}

model assessment_attempts {
  id             String    @id @default(uuid())
  assessment_id  String
  user_id        String
  institution_id String?
  started_at     DateTime  @default(now())
  finished_at    DateTime?
  score_raw      Float?
  score_percent  Float?

  assessment_answers assessment_answers[]
  assessments        assessments          @relation(fields: [assessment_id], references: [id])
  users              users                @relation(fields: [user_id], references: [id])
  institutions       institutions?        @relation(fields: [institution_id], references: [id])

  @@index([institution_id])
}

model assessment_questions {
  id             String       @id @default(uuid())
  assessment_id  String
  question_type  QuestionType
  question_text  String
  options        Json?
  correct_answer Json
  skills         String[]     @default([])

  assessment_answers assessment_answers[]
  assessments        assessments          @relation(fields: [assessment_id], references: [id])
}

model assessments {
  id                     String   @id @default(uuid())
  content_id             String
  content_version_id     String?
  institution_id         String?
  schooling_level_target String
  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt

  assessment_attempts  assessment_attempts[]
  assessment_questions assessment_questions[]
  contents             contents               @relation(fields: [content_id], references: [id])
  content_versions     content_versions?      @relation(fields: [content_version_id], references: [id])
  institutions         institutions?          @relation(fields: [institution_id], references: [id])
}

model audit_logs {
  id            String   @id
  actor_user_id String?
  actor_role    String?
  action        String
  resource_type String
  resource_id   String?
  request_id    String?
  ip            String?
  user_agent    String?
  before_json   Json?
  after_json    Json?
  reason        String?
  created_at    DateTime @default(now())

  @@index([action])
  @@index([actor_user_id])
  @@index([created_at])
  @@index([request_id])
  @@index([resource_type])
}

model background_jobs {
  id           String    @id
  job_name     String
  status       JobStatus
  started_at   DateTime
  completed_at DateTime?
  duration     Int?
  error        String?
  metadata     Json?

  @@index([job_name, status])
  @@index([started_at])
}

model badges {
  id          String        @id
  code        String        @unique
  name        String
  description String
  image_url   String?
  user_badges user_badges[]
}

model billing_events {
  id                String    @id
  provider_code     String
  provider_event_id String    @unique
  event_type        String
  payload           Json
  processed_at      DateTime?
  created_at        DateTime  @default(now())

  @@index([processed_at])
  @@index([provider_code])
}

model class_plan_weeks {
  id                     String     @id
  classroom_id           String
  week_start             DateTime
  created_by_educator_id String
  title                  String?
  notes                  String?
  items_json             Json
  tool_words_json        Json?
  checkpoints_json       Json?
  created_at             DateTime   @default(now())
  updated_at             DateTime
  classrooms             classrooms @relation(fields: [classroom_id], references: [id], onDelete: Cascade)
  users                  users      @relation(fields: [created_by_educator_id], references: [id])

  @@unique([classroom_id, week_start])
}

model class_policies {
  id                      String           @id
  classroom_id            String           @unique
  timebox_default_min     Int              @default(15)
  weekly_units_target     Int              @default(3)
  tool_words_gate_enabled Boolean          @default(true)
  daily_review_cap        Int              @default(10)
  privacy_mode            ClassPrivacyMode @default(AGGREGATED_ONLY)
  intervention_mode       InterventionMode @default(PROMPT_COACH)
  created_at              DateTime         @default(now())
  updated_at              DateTime
  classrooms              classrooms       @relation(fields: [classroom_id], references: [id], onDelete: Cascade)
}

model classrooms {
  id                String             @id
  institution_id    String?
  owner_educator_id String
  name              String
  grade_level       String?
  created_at        DateTime           @default(now())
  updated_at        DateTime
  class_plan_weeks  class_plan_weeks[]
  class_policies    class_policies?
  institutions      institutions?      @relation(fields: [institution_id], references: [id])

  users       users         @relation(fields: [owner_educator_id], references: [id])
  enrollments enrollments[]
}

model co_reading_sessions {
  id                 String          @id @default(uuid())
  family_id          String
  educator_user_id   String
  learner_user_id    String
  reading_session_id String          @unique
  thread_id_learner  String
  thread_id_educator String
  type               CoSessionType   @default(CO_READING)
  timebox_min        Int
  status             CoReadingStatus @default(ACTIVE)
  started_at         DateTime        @default(now())
  ended_at           DateTime?

  users_educator   users            @relation("co_reading_sessions_educator_user_idTousers", fields: [educator_user_id], references: [id])
  families         families         @relation(fields: [family_id], references: [id], onDelete: Cascade)
  users_learner    users            @relation("co_reading_sessions_learner_user_idTousers", fields: [learner_user_id], references: [id])
  reading_sessions reading_sessions @relation(fields: [reading_session_id], references: [id], onDelete: Cascade)
}

model comment_threads {
  id String @id @default(uuid())

  context_type ShareContextType
  context_id   String

  target_type CommentTargetType
  target_id   String

  created_at DateTime @default(now())

  comments comments[]

  @@unique([context_type, context_id, target_type, target_id])
  @@index([context_type, context_id])
}

model comments {
  id String @id @default(uuid())

  thread_id String
  author_id String

  body String

  created_at DateTime @default(now())

  deleted_at    DateTime?
  deleted_by    String?
  delete_reason String?

  thread comment_threads @relation(fields: [thread_id], references: [id], onDelete: Cascade)
  author users           @relation(fields: [author_id], references: [id], onDelete: Cascade)

  @@index([thread_id, created_at])
}

model concept_difficulty {
  id              String   @id
  topic           String
  subject         String
  total_attempts  Int      @default(0)
  avg_score       Float
  success_rate    Float
  common_mistakes String[]
  created_at      DateTime @default(now())
  updated_at      DateTime

  @@unique([topic, subject])
}

model content_chunks {
  id             String   @id @default(uuid())
  content_id     String
  chunk_index    Int
  page_number    Int?
  text           String
  token_estimate Int?
  created_at     DateTime @default(now())
  contents       contents @relation(fields: [content_id], references: [id], onDelete: Cascade)

  section_transfer_metadata section_transfer_metadata[]
  transfer_attempts         transfer_attempts[]
  decision_logs             decision_logs[]
  topic_edge_evidence       topic_edge_evidence[] // GRAPH SCRIPT 01

  @@unique([content_id, chunk_index])
  @@index([content_id])
  @@index([page_number])
}

model content_extractions {
  id                 String           @id @default(uuid())
  content_id         String           @unique
  status             ExtractionStatus @default(PENDING)
  extracted_text_ref String?
  metadata_json      Json?
  created_at         DateTime         @default(now())
  updated_at         DateTime         @updatedAt
  contents           contents         @relation(fields: [content_id], references: [id], onDelete: Cascade)
}

model content_pedagogical_data {
  id                  String   @id @default(uuid())
  content_id          String   @unique
  vocabulary_triage   Json?
  socratic_questions  Json?
  quiz_questions      Json?
  taboo_cards         Json?
  boss_fight_config   Json?
  free_recall_prompts Json?
  processing_version  String   @default("v1.0")
  processed_at        DateTime @default(now())
  updated_at          DateTime @updatedAt
  contents            contents @relation(fields: [content_id], references: [id], onDelete: Cascade)

  @@index([content_id])
}

model content_shares {
  content_id   String
  context_type ShareContextType
  context_id   String

  permission SharePermission @default(VIEW)

  created_by String?
  created_at DateTime @default(now())

  contents contents @relation(fields: [content_id], references: [id], onDelete: Cascade)

  @@id([content_id, context_type, context_id])
  @@index([context_type, context_id])
}

model content_versions {
  id                     String   @id @default(uuid())
  content_id             String
  target_language        Language
  schooling_level_target String
  simplified_text        String
  summary                String?
  vocabulary_glossary    Json?
  created_at             DateTime @default(now())

  assessments        assessments[]
  contents           contents             @relation(fields: [content_id], references: [id])
  reading_sessions   reading_sessions[]
  user_library_items user_library_items[]
}

model contents {
  id                String      @id
  institution_id    String?
  type              ContentType
  source_id         String?
  title             String
  original_language Language
  raw_text          String
  metadata          Json?
  created_by        String?
  created_at        DateTime    @default(now())
  updated_at        DateTime    @updatedAt
  scope_type        ScopeType   @default(USER)

  file_id        String?
  language_guess String?
  owner_user_id  String?
  scope_id       String?
  source_url     String?
  duration       Int?

  // Content Mode (Sprint 1)
  mode        ContentMode?
  mode_source String? // 'PRODUCER' | 'USER' | 'HEURISTIC'
  mode_set_by String? // userId ou 'SYSTEM'
  mode_set_at DateTime?

  annotations              annotations[]
  assessments              assessments[]
  content_chunks           content_chunks[]
  content_extractions      content_extractions?
  content_pedagogical_data content_pedagogical_data?
  content_versions         content_versions[]
  users_created_by         users?                    @relation("contents_created_byTousers", fields: [created_by], references: [id])
  files                    files?                    @relation(fields: [file_id], references: [id])
  institutions             institutions?             @relation(fields: [institution_id], references: [id])
  users_owner              users?                    @relation("contents_owner_user_idTousers", fields: [owner_user_id], references: [id])
  cornell_notes            cornell_notes[]
  content_shares           content_shares[]
  game_results             game_results[]

  group_sessions            group_sessions[]
  highlights                highlights[]
  learning_assets           learning_assets[]
  lessons                   lessons[]
  vocab_items               vocab_items[]
  reading_sessions          reading_sessions[]
  user_library_items        user_library_items[]
  user_vocabularies         user_vocabularies[]
  telemetry_events          telemetry_events[]
  reading_progress          reading_progress[]
  bookmarks                 bookmarks[]
  decision_logs             decision_logs[]
  section_transfer_metadata section_transfer_metadata[]
  transfer_attempts         transfer_attempts[]
  pkm_notes                 pkm_notes[]
  topic_graphs              topic_graphs[] // GRAPH SCRIPT 01
  topic_edge_evidence       topic_edge_evidence[] // GRAPH SCRIPT 01

  @@index([owner_user_id])
  @@index([title])
  @@index([mode])
}

model cornell_notes {
  id           String   @id @default(uuid())
  content_id   String
  created_at   DateTime @default(now())
  cues_json    Json     @default("[]")
  notes_json   Json     @default("[]")
  summary_text String   @default("")
  updated_at   DateTime @default(now()) @updatedAt
  user_id      String

  contents            contents              @relation(fields: [content_id], references: [id], onDelete: Cascade)
  users               users                 @relation(fields: [user_id], references: [id])
  topic_edge_evidence topic_edge_evidence[] // GRAPH SCRIPT 01

  @@unique([content_id, user_id])
  @@index([content_id])
  @@index([user_id])
}

model courses {
  id          String    @id
  title       String
  description String?
  created_at  DateTime  @default(now())
  updated_at  DateTime
  lessons     lessons[]
}

model daily_activities {
  id                  String        @id
  user_id             String
  institution_id      String?
  date                DateTime      @db.Date
  minutes_studied     Int           @default(0)
  sessions_count      Int           @default(0)
  contents_read       Int           @default(0)
  annotations_created Int           @default(0)
  minutes_spent       Int           @default(0)
  lessons_completed   Int           @default(0)
  goal_met            Boolean       @default(false)
  created_at          DateTime      @default(now())
  users               users         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  institutions        institutions? @relation(fields: [institution_id], references: [id])

  @@unique([user_id, date, institution_id])
  @@index([user_id, date])
  @@index([institution_id])
}

model daily_goals {
  id             String        @id
  user_id        String
  institution_id String?
  goal_type      DailyGoalType
  goal_value     Int
  created_at     DateTime      @default(now())
  updated_at     DateTime
  users          users         @relation(fields: [user_id], references: [id])
  institutions   institutions? @relation(fields: [institution_id], references: [id])

  @@index([user_id])
  @@index([institution_id])
}

model enrollments {
  id              String           @id
  classroom_id    String
  learner_user_id String
  status          EnrollmentStatus @default(ACTIVE)
  nickname        String?
  enrolled_at     DateTime         @default(now())
  classrooms      classrooms       @relation(fields: [classroom_id], references: [id], onDelete: Cascade)
  users           users            @relation(fields: [learner_user_id], references: [id])

  @@unique([classroom_id, learner_user_id])
}

model entitlement_overrides {
  id         String    @id
  scope_type ScopeType
  scope_id   String
  overrides  Json
  reason     String
  updated_by String
  created_at DateTime  @default(now())
  updated_at DateTime

  @@unique([scope_type, scope_id])
}

model entitlement_snapshots {
  id         String               @id @default(uuid())
  user_id    String? // ✅ Issue #7: Nullable to preserve audit trail
  scope_type EntitlementScopeType
  scope_id   String

  source    String
  plan_type PlanType
  limits    Json
  features  Json     @default("{}")

  effective_at DateTime  @default(now())
  expires_at   DateTime?
  updated_at   DateTime  @updatedAt

  users users? @relation(fields: [user_id], references: [id], onDelete: SetNull) // ✅ Issue #7: Preserve entitlement history

  @@unique([user_id, scope_type, scope_id])
  @@index([user_id, scope_type])
}

model error_logs {
  id          String   @id
  message     String
  stack       String?
  endpoint    String?
  method      String?
  status_code Int?
  user_id     String?
  request_id  String?
  metadata    Json?
  timestamp   DateTime @default(now())
  resolved    Boolean  @default(false)

  @@index([endpoint])
  @@index([resolved])
  @@index([timestamp])
}

model extension_device_auth {
  id               String   @id
  device_code      String   @unique
  user_code        String   @unique
  status           String   @default("PENDING")
  client_id        String   @default("browser-extension")
  requested_scopes Json     @default("[]")
  user_id          String?
  expires_at       DateTime
  created_at       DateTime @default(now())
  updated_at       DateTime
  users            users?   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([device_code])
  @@index([status, expires_at])
  @@index([user_code])
}

model extension_grants {
  id               String    @id
  user_id          String
  client_id        String    @default("browser-extension")
  scopes           Json      @default("[]")
  access_token_jti String?
  refresh_token    String?   @unique
  revoked_at       DateTime?
  last_used_at     DateTime?
  created_at       DateTime  @default(now())
  users            users     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([access_token_jti])
  @@index([refresh_token])
  @@index([user_id])
}

model families {
  id            String  @id @default(uuid())
  name          String?
  join_code            String?   @unique
  join_code_expires_at DateTime? // ✅ Issue #9
  join_code_created_at DateTime? // ✅ Issue #9
  owner_user_id        String    @map("owner_id")

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  users_owner         users                 @relation("families_owner_user_idTousers", fields: [owner_user_id], references: [id])
  family_members      family_members[]
  co_reading_sessions co_reading_sessions[]
  family_policies     family_policies[]
  provider_usage      provider_usage[]
  subscriptions       subscriptions[]
  study_groups        study_groups[] // Issue #3: Explicit FK

  @@map("families")
}

model family_members {
  id            String              @id @default(uuid())
  family_id     String
  user_id       String
  role          FamilyRole
  learning_role FamilyLearningRole?
  status        FamilyMemberStatus  @default(INVITED)
  display_name  String?
  joined_at     DateTime            @default(now())

  families families @relation(fields: [family_id], references: [id], onDelete: Cascade)
  users    users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([family_id, user_id])
  @@index([family_id, role])
}

model family_policies {
  id                          String      @id
  family_id                   String
  learner_user_id             String
  timebox_default_min         Int         @default(15)
  daily_min_minutes           Int         @default(15)
  daily_review_cap            Int         @default(20)
  co_reading_days             Int[]
  co_reading_time             String?
  tool_words_gate_enabled     Boolean     @default(true)
  privacy_mode                PrivacyMode @default(AGGREGATED_ONLY)
  scaffolding_level_default   Int         @default(2)
  fading_enabled              Boolean     @default(true)
  llm_budget_daily_tokens     Int         @default(5000)
  llm_hard_rate_limit_per_min Int         @default(10)
  decision_policy_json        Json        @default("{}")
  created_at                  DateTime    @default(now())
  updated_at                  DateTime
  families                    families    @relation(fields: [family_id], references: [id], onDelete: Cascade)
  users                       users       @relation(fields: [learner_user_id], references: [id], onDelete: Cascade)

  @@unique([family_id, learner_user_id])
}

model feature_flags {
  id          String       @id
  key         String       @unique
  name        String
  description String?
  enabled     Boolean      @default(false)
  environment Environment?
  scope_type  ScopeType?
  scope_id    String?
  created_by  String?
  created_at  DateTime     @default(now())
  updated_at  DateTime

  @@index([enabled])
  @@index([key])
}

model files {
  id               String     @id
  storageProvider  String
  storageKey       String
  mimeType         String
  sizeBytes        BigInt
  checksumSha256   String?
  originalFilename String?
  createdAt        DateTime   @default(now())
  contents         contents[]

  @@index([storageProvider, storageKey])
}

model game_progress {
  id             String        @id
  user_id        String
  institution_id String?
  game_id        String
  stars          Int           @default(0)
  bestScore      Float         @default(0)
  total_plays    Int           @default(0)
  streak         Int           @default(0)
  last_played    DateTime?
  created_at     DateTime      @default(now())
  updated_at     DateTime
  users          users         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  institutions   institutions? @relation(fields: [institution_id], references: [id])

  @@unique([user_id, game_id, institution_id])
  @@index([game_id])
  @@index([user_id])
  @@index([institution_id])
}

model game_results {
  id             String        @id
  user_id        String
  institution_id String?
  content_id     String
  game_type      String
  score          Float
  metadata       Json?
  played_at      DateTime      @default(now())
  contents       contents      @relation(fields: [content_id], references: [id], onDelete: Cascade)
  users          users         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  institutions   institutions? @relation(fields: [institution_id], references: [id])

  @@index([game_type])
  @@index([played_at])
  @@index([user_id, content_id])
  @@index([content_id])
  @@index([user_id])
  @@index([institution_id])
}

model gradebook_exports {
  id           String   @id
  classroom_id String
  created_by   String
  range        Json
  format       String   @default("CSV")
  file_ref     String
  created_at   DateTime @default(now())

  @@index([classroom_id, created_at])
}

model group_chat_messages {
  id             String         @id
  session_id     String
  round_id       String
  user_id        String
  message        String
  created_at     DateTime       @default(now())
  group_rounds   group_rounds   @relation(fields: [round_id], references: [id], onDelete: Cascade)
  group_sessions group_sessions @relation(fields: [session_id], references: [id], onDelete: Cascade)
  users          users          @relation(fields: [user_id], references: [id])

  @@index([created_at])
  @@index([session_id, round_id])
}

model group_events {
  id             String         @id
  session_id     String
  round_id       String?
  user_id        String?
  event_type     String
  payload_json   Json
  created_at     DateTime       @default(now())
  group_rounds   group_rounds?  @relation(fields: [round_id], references: [id])
  group_sessions group_sessions @relation(fields: [session_id], references: [id], onDelete: Cascade)

  @@index([event_type])
  @@index([round_id])
  @@index([session_id])
}

model group_rounds {
  id                  String                @id
  session_id          String
  round_index         Int
  round_type          String                @default("PI")
  prompt_json         Json
  timing_json         Json
  status              RoundStatus           @default(CREATED)
  created_at          DateTime              @default(now())
  group_chat_messages group_chat_messages[]
  group_events        group_events[]
  group_sessions      group_sessions        @relation(fields: [session_id], references: [id], onDelete: Cascade)
  shared_cards        shared_cards?

  @@unique([session_id, round_index])
  @@index([session_id])
}

model group_session_members {
  session_id        String
  user_id           String
  assigned_role     SessionRole
  attendance_status String         @default("JOINED")
  group_sessions    group_sessions @relation(fields: [session_id], references: [id], onDelete: Cascade)
  users             users          @relation(fields: [user_id], references: [id])

  @@id([session_id, user_id])
}

model group_sessions {
  id                    String                  @id
  group_id              String
  content_id            String
  mode                  GroupSessionMode        @default(PI_SPRINT)
  layer                 String                  @default("L1")
  status                GroupSessionStatus      @default(CREATED)
  starts_at             DateTime?
  ends_at               DateTime?
  created_at            DateTime                @default(now())
  group_chat_messages   group_chat_messages[]
  group_events          group_events[]
  group_rounds          group_rounds[]
  group_session_members group_session_members[]
  contents              contents                @relation(fields: [content_id], references: [id])
  study_groups          study_groups            @relation(fields: [group_id], references: [id], onDelete: Cascade)
  shared_cards          shared_cards[]

  @@index([group_id])
  @@index([status])
}

model highlights {
  id                  String                @id @default(uuid())
  content_id          String
  user_id             String
  kind                HighlightKind
  target_type         ContentType
  page_number         Int?
  anchor_json         Json
  color_key           String                @default("yellow")
  comment_text        String?
  tags_json           Json                  @default("[]")
  created_at          DateTime              @default(now())
  updated_at          DateTime              @default(now())
  timestamp_ms        Int?
  duration_ms         Int?
  visibility          AnnotationVisibility  @default(PRIVATE)
  visibility_scope    VisibilityScope?
  context_type        ContextType?
  context_id          String?
  learner_id          String?
  status              AnnotationStatus      @default(ACTIVE)
  type                AnnotationType?
  deleted_at          DateTime?
  annotation_comments annotation_comments[]
  contents            contents              @relation(fields: [content_id], references: [id], onDelete: Cascade)
  users               users                 @relation(fields: [user_id], references: [id])
  topic_edge_evidence topic_edge_evidence[] // GRAPH SCRIPT 01

  @@index([content_id])
  @@index([context_id])
  @@index([context_type])
  @@index([status])
  @@index([user_id])
  @@index([visibility])
}

model institution_domains {
  id             String       @id
  institution_id String
  domain         String       @unique
  auto_approve   Boolean      @default(false)
  default_role   String       @default("STUDENT")
  created_at     DateTime     @default(now())
  institutions   institutions @relation(fields: [institution_id], references: [id], onDelete: Cascade)

  @@index([domain])
}

model institution_invites {
  id             String       @id
  institution_id String
  email          String
  role           String       @default("STUDENT")
  token          String       @unique
  expires_at     DateTime
  used_at        DateTime?
  invited_by     String
  created_at     DateTime     @default(now())
  institutions   institutions @relation(fields: [institution_id], references: [id], onDelete: Cascade)
  users          users        @relation(fields: [invited_by], references: [id])

  @@index([email])
  @@index([institution_id, email])
  @@index([token])
}

model institution_members {
  id             String          @id @default(uuid())
  institution_id String
  user_id        String // ✅ Security Fix Issue #6: Removed @unique to allow multi-tenant
  role           InstitutionRole
  status         MemberStatus    @default(ACTIVE)
  joined_at      DateTime        @default(now())
  left_at        DateTime?

  institutions institutions @relation(fields: [institution_id], references: [id], onDelete: Cascade)
  users        users        @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([institution_id, user_id]) // ✅ Composite unique: user can be in multiple institutions
  @@index([institution_id, status])
  @@index([user_id]) // ✅ Added for findFirst performance
}

model institution_policies {
  id                          String   @id @default(uuid())
  institution_id              String   @unique
  allow_advanced_ai           Boolean  @default(false)
  allow_text_extraction       Boolean  @default(false)
  allow_external_sharing      Boolean  @default(false)
  student_unenrollment_mode   String   @default("TEACHER_OR_ADMIN_ONLY")
  transfer_enabled            Boolean  @default(true)
  scaffolding_level_default   Int      @default(2)
  fading_enabled              Boolean  @default(true)
  llm_budget_daily_tokens     Int      @default(15000)
  llm_hard_rate_limit_per_min Int      @default(30)
  decision_policy_json        Json     @default("{}")
  created_at                  DateTime @default(now())
  updated_at                  DateTime @updatedAt

  institutions institutions @relation(fields: [institution_id], references: [id], onDelete: Cascade)
}

model institutions {
  id                String          @id @default(uuid())
  name              String
  type              InstitutionType
  kind              InstitutionKind @default(EDUCATION)
  city              String?
  state             String?
  country           String?
  max_members       Int?
  requires_approval Boolean         @default(false)
  slug              String?         @unique
  sso_enabled       Boolean         @default(false)
  created_at        DateTime        @default(now())
  updated_at        DateTime        @updatedAt

  assessments               assessments[]
  contents                  contents[]
  domains                   institution_domains[]
  invites                   institution_invites[]
  institution_members       institution_members[]
  institution_policies      institution_policies?
  users_active              users[]
  org_subscription_policies org_subscription_policies?
  pending_user_approvals    pending_user_approvals[]
  provider_usage            provider_usage[]
  sso_configurations        sso_configurations?
  subscriptions             subscriptions[]
  teacher_verifications     teacher_verifications[]
  classrooms                classrooms[]
  assessment_attempts       assessment_attempts[]
  game_results              game_results[]
  game_progress             game_progress[]
  daily_activities          daily_activities[]
  daily_goals               daily_goals[]
  streaks                   streaks[]
  user_badges               user_badges[]
  user_vocabularies         user_vocabularies[]
  reading_sessions          reading_sessions[]
  hourly_activity_cache     hourly_activity_cache[]
  study_groups              study_groups[] // Issue #3: Explicit FK

  @@index([slug])
}

model integration_secrets {
  id              String       @id
  key             String       @unique
  name            String
  provider        String?
  encrypted_value String
  encrypted_dek   String
  iv              String
  auth_tag        String
  key_id          String       @default("v1")
  environment     Environment?
  last_rotated_at DateTime?
  created_by      String?
  created_at      DateTime     @default(now())
  updated_at      DateTime

  @@index([key])
  @@index([provider])
}

model layer_eligibility {
  user_id     String   @id
  eligible_l2 Boolean  @default(false)
  eligible_l3 Boolean  @default(false)
  reason_json Json?
  updated_at  DateTime
  users       users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model learner_profiles {
  user_id                String         @id
  education_level        EducationLevel @default(ADULTO_LEIGO)
  reading_level_score    Int?
  listening_level_score  Int?
  writing_level_score    Int?
  daily_time_budget_min  Int            @default(30)
  daily_review_cap       Int            @default(20)
  scaffolding_state_json Json           @default("{}")
  mastery_state_json     Json           @default("{}")
  created_at             DateTime       @default(now())
  updated_at             DateTime
  users                  users          @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model learning_assets {
  id                  String          @id
  content_id          String
  layer               AssetLayer
  modality            SessionModality
  body_ref            String?
  glossary_json       Json?
  cues_json           Json?
  checkpoints_json    Json?
  quiz_post_json      Json?
  difficulty_estimate Int?
  length_estimate     Int?
  prompt_version      String
  created_at          DateTime        @default(now())
  updated_at          DateTime
  contents            contents        @relation(fields: [content_id], references: [id], onDelete: Cascade)

  @@unique([content_id, layer, modality, prompt_version])
  @@index([content_id, layer])
  @@index([prompt_version])
}

// REMOVED: legacy_cornell_notes table (Phase 1 cleanup)
// Data migrated to cornell_notes. See migration: drop_legacy_cornell_notes

model lesson_progress {
  id           String       @id
  user_id      String
  lesson_id    String
  status       LessonStatus @default(AVAILABLE)
  progress_pct Int          @default(0)
  updated_at   DateTime
  lessons      lessons      @relation(fields: [lesson_id], references: [id])

  @@unique([user_id, lesson_id])
}

model lessons {
  id                String            @id
  course_id         String
  title             String
  order_index       Int
  estimated_minutes Int
  created_at        DateTime          @default(now())
  updated_at        DateTime
  content_id        String?
  lesson_progress   lesson_progress[]
  contents          contents?         @relation(fields: [content_id], references: [id])
  courses           courses           @relation(fields: [course_id], references: [id])
}

model org_subscription_policies {
  id                   String       @id
  institution_id       String       @unique
  baseline_seats       Int          @default(0)
  allow_overage        Boolean      @default(true)
  grace_days           Int          @default(30)
  true_up_day_of_month Int          @default(1)
  created_at           DateTime     @default(now())
  updated_at           DateTime
  institutions         institutions @relation(fields: [institution_id], references: [id], onDelete: Cascade)
}

model pending_user_approvals {
  id                 String         @id
  institution_id     String
  email              String
  name               String
  temp_password_hash String
  requested_role     String         @default("STUDENT")
  status             ApprovalStatus @default(PENDING)
  reviewed_by        String?
  reviewed_at        DateTime?
  rejection_reason   String?
  created_at         DateTime       @default(now())
  institutions       institutions   @relation(fields: [institution_id], references: [id], onDelete: Cascade)
  users              users?         @relation(fields: [reviewed_by], references: [id])

  @@index([email])
  @@index([institution_id, status])
}

model plans {
  id               String          @id
  code             String          @unique
  name             String
  description      String?
  is_active        Boolean         @default(true)
  entitlements     Json
  monthly_price    Float?
  yearly_price     Float?
  created_at       DateTime        @default(now())
  updated_at       DateTime
  billing_period   BillingPeriod?
  currency         String          @default("BRL")
  price_cents      Int             @default(0)
  seat_price_cents Int?
  type             PlanType        @default(FREE)
  subscriptions    subscriptions[]

  @@index([code])
  @@index([is_active])
}

model provider_usage {
  id                String        @id
  provider          String
  operation         String
  tokens            Int?
  latency           Int?
  status_code       Int?
  user_id           String?
  metadata          Json?
  timestamp         DateTime      @default(now())
  completion_tokens Int?
  cost_usd          Float?
  family_id         String?
  feature           String        @default("unknown")
  group_id          String?
  institution_id    String?
  model             String?
  prompt_tokens     Int?
  total_tokens      Int?
  families          families?     @relation(fields: [family_id], references: [id])
  study_groups      study_groups? @relation(fields: [group_id], references: [id])
  institutions      institutions? @relation(fields: [institution_id], references: [id])
  users             users?        @relation(fields: [user_id], references: [id])

  @@index([family_id, timestamp])
  @@index([institution_id, timestamp])
  @@index([timestamp])
  @@index([user_id, timestamp])
}

model question_analytics {
  id              String    @id
  item_id         String    @unique
  total_attempts  Int       @default(0)
  success_rate    Float
  avg_score       Float
  avg_time        Int
  avg_self_rating Float?
  common_mistakes Json
  is_difficult    Boolean   @default(false)
  updated_at      DateTime
  item_bank       item_bank @relation(fields: [item_id], references: [id], onDelete: Cascade)
}

// model question_bank removed (Phase 3.2 Unification)

model question_results {
  id              String    @id
  user_id         String
  item_id         String
  game_session_id String?
  score           Int
  time_taken      Int
  is_correct      Boolean
  self_rating     Int?
  user_answer     Json?
  mistakes        Json?
  created_at      DateTime  @default(now())
  item_bank       item_bank @relation(fields: [item_id], references: [id], onDelete: Cascade)
  users           users     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([item_id])
  @@index([user_id, created_at])
}

model question_translations {
  id               String    @id
  item_id          String
  target_language  String
  question         Json
  answer           Json
  subject          String
  topic            String
  is_ai_translated Boolean   @default(true)
  is_reviewed      Boolean   @default(false)
  reviewed_by      String?
  created_at       DateTime  @default(now())
  updated_at       DateTime
  item_bank        item_bank @relation(fields: [item_id], references: [id], onDelete: Cascade)

  @@unique([item_id, target_language])
  @@index([target_language])
}

model reading_sessions {
  id                 String           @id @default(uuid())
  user_id            String
  content_id         String
  content_version_id String?
  started_at         DateTime         @default(now())
  finished_at        DateTime?
  phase              SessionPhase?    @default(PRE)
  modality           SessionModality? @default(READING)
  asset_layer        String?          @default("L1")
  goal_statement     String?
  prediction_text    String?
  target_words_json  Json?
  analytics_json     Json? // SCRIPT 07: Aggregated KPIs (deep_reading_index, ui_load_index, etc.)
  aggregated_at      DateTime? // SCRIPT 07: Last aggregation timestamp

  co_reading_sessions co_reading_sessions?
  contents            contents             @relation(fields: [content_id], references: [id])
  content_versions    content_versions?    @relation(fields: [content_version_id], references: [id])
  users               users                @relation(fields: [user_id], references: [id])
  institutions        institutions?        @relation(fields: [institution_id], references: [id])
  institution_id      String?
  vocab_attempts      vocab_attempts[]
  session_events      session_events[]
  session_outcomes    session_outcomes?

  @@index([user_id, started_at(sort: Desc)], map: "user_sessions_list")
  @@index([user_id, phase, started_at], map: "user_sessions_phase")
  @@index([institution_id])
}

model seat_allocation_events {
  id             String   @id
  institution_id String
  delta          Int
  reason         String
  created_at     DateTime @default(now())

  @@index([institution_id, created_at])
}

model session_events {
  id                 String            @id @default(uuid())
  reading_session_id String?
  event_type         EventType
  payload_json       Json
  created_at         DateTime          @default(now())
  reading_sessions   reading_sessions? @relation(fields: [reading_session_id], references: [id], onDelete: Cascade)

  @@index([event_type])
  @@index([reading_session_id])
}

model session_outcomes {
  reading_session_id  String           @id
  comprehension_score Int              @default(0)
  production_score    Int              @default(0)
  frustration_index   Int              @default(0)
  computed_at         DateTime         @default(now())
  reading_sessions    reading_sessions @relation(fields: [reading_session_id], references: [id], onDelete: Cascade)
}

model shared_cards {
  id                 String         @id
  session_id         String
  round_id           String         @unique
  created_by_user_id String
  card_json          Json
  created_at         DateTime       @default(now())
  group_rounds       group_rounds   @relation(fields: [round_id], references: [id], onDelete: Cascade)
  group_sessions     group_sessions @relation(fields: [session_id], references: [id], onDelete: Cascade)

  @@index([session_id])
}

model sso_configurations {
  id              String       @id
  institution_id  String       @unique
  provider        SSOProvider
  enabled         Boolean      @default(false)
  entity_id       String?
  sso_url         String?
  certificate     String?
  client_id       String?
  client_secret   String?
  auth_url        String?
  token_url       String?
  user_info_url   String?
  email_attribute String?      @default("email")
  name_attribute  String?      @default("name")
  role_attribute  String?
  role_mapping    Json?
  created_at      DateTime     @default(now())
  updated_at      DateTime
  institutions    institutions @relation(fields: [institution_id], references: [id], onDelete: Cascade)
}

model streaks {
  user_id            String        @id
  current_streak     Int           @default(0)
  best_streak        Int           @default(0)
  last_goal_met_date DateTime?     @db.Date
  freeze_tokens      Int           @default(1)
  updated_at         DateTime
  users              users         @relation(fields: [user_id], references: [id])
  institutions       institutions? @relation(fields: [institution_id], references: [id])
  institution_id     String?

  @@index([institution_id])
}

model study_group_members {
  group_id     String
  user_id      String
  role         GroupRole
  status       GroupMemberStatus @default(ACTIVE)
  joined_at    DateTime          @default(now())
  study_groups study_groups      @relation(fields: [group_id], references: [id], onDelete: Cascade)
  users        users             @relation(fields: [user_id], references: [id])

  @@id([group_id, user_id])
  @@index([user_id])
}

model study_groups {
  id            String   @id @default(uuid())
  owner_user_id String
  name          String
  created_at    DateTime @default(now())

  // Explicit Foreign Keys (Security Fix - Issue #3)
  // Replaces generic scope_type/scope_id pattern
  institution_id   String?
  family_id        String?
  personal_user_id String? // Renamed from user_id to avoid conflict with owner_user_id

  // Legacy fields (deprecated, will be removed after migration)
  scope_type ScopeType? @map("scope_type_legacy")
  scope_id   String?    @map("scope_id_legacy")

  // Relations
  annotations         annotations[]
  group_sessions      group_sessions[]
  provider_usage      provider_usage[]
  study_group_members study_group_members[]
  users_owner         users                 @relation(fields: [owner_user_id], references: [id])
  institutions        institutions?         @relation(fields: [institution_id], references: [id], onDelete: Cascade)
  families            families?             @relation(fields: [family_id], references: [id], onDelete: Cascade)
  users_personal      users?                @relation("study_groups_personal", fields: [personal_user_id], references: [id], onDelete: Cascade)

  @@index([owner_user_id])
  @@index([institution_id])
  @@index([family_id])
  @@index([personal_user_id])
}

model study_sessions {
  id                String    @id
  user_id           String
  start_time        DateTime
  end_time          DateTime?
  duration_minutes  Int?
  net_focus_minutes Int?
  focus_score       Float?
  interruptions     Int       @default(0)
  activity_type     String
  content_id        String?
  source_id         String?
  accuracy_rate     Float?
  engagement_score  Float?
  created_at        DateTime  @default(now())
  users             users     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, activity_type])
  @@index([user_id, start_time])
}

model subscriptions {
  id                       String             @id
  scope_type               ScopeType
  scope_id                 String
  plan_id                  String
  status                   SubscriptionStatus
  source                   SubscriptionSource
  current_period_start     DateTime?
  current_period_end       DateTime?
  cancel_at_period_end     Boolean            @default(false)
  provider_code            String?
  provider_customer_id     String?
  provider_subscription_id String?            @unique
  provider_price_id        String?
  created_at               DateTime           @default(now())
  updated_at               DateTime
  canceled_at              DateTime?
  ended_at                 DateTime?
  family_id                String?
  grace_until              DateTime?
  institution_id           String?
  metadata                 Json?
  provider                 PaymentProvider?
  user_id                  String?
  families                 families?          @relation(fields: [family_id], references: [id])
  institutions             institutions?      @relation(fields: [institution_id], references: [id])
  plans                    plans              @relation(fields: [plan_id], references: [id])
  users                    users?             @relation(fields: [user_id], references: [id])
  invoices                 invoices[]

  @@unique([scope_type, scope_id, status], map: "subscriptions_scope_status_unique")
  @@index([family_id])
  @@index([institution_id])
  @@index([plan_id])
  @@index([scope_type, scope_id])
  @@index([status])
  @@index([user_id])
}

model invoices {
  id                  String        @id @default(uuid())
  subscription_id     String
  amount              Float
  currency            String        @default("BRL")
  period_start        DateTime
  period_end          DateTime
  status              String        @default("OPEN")
  provider_invoice_id String?       @unique
  metadata            Json?
  created_at          DateTime      @default(now())
  updated_at          DateTime      @updatedAt
  subscriptions       subscriptions @relation(fields: [subscription_id], references: [id], onDelete: Cascade)

  @@index([subscription_id])
  @@index([status])
}

model payment_methods {
  id                String   @id @default(uuid())
  user_id           String
  provider          String   @default("stripe")
  last4             String
  exp_month         Int
  exp_year          Int
  is_default        Boolean  @default(false)
  encrypted_details String
  metadata          Json?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  users             users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
}

model system_metrics {
  id        String   @id
  metric    String
  value     Float
  tags      Json?
  timestamp DateTime @default(now())
  bucket    String

  @@index([bucket])
  @@index([metric, timestamp])
}

model teacher_verifications {
  id             String                    @id @default(uuid())
  user_id        String                    @unique
  institution_id String
  status         TeacherVerificationStatus @default(PENDING)
  verified_by    String?
  verified_at    DateTime?
  created_at     DateTime                  @default(now())
  updated_at     DateTime                  @updatedAt

  users          users        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  institutions   institutions @relation(fields: [institution_id], references: [id], onDelete: Cascade)
  users_verifier users?       @relation("VerifiedBy", fields: [verified_by], references: [id])

  @@index([institution_id, status])
}

model usage_events {
  id              String      @id
  environment     Environment
  occurred_at     DateTime
  scope_type      ScopeType
  scope_id        String
  provider_code   String?
  endpoint        String?
  metric          String
  quantity        Float
  approx_cost_usd Float?
  request_id      String?
  user_id         String?
  metadata        Json?
  created_at      DateTime    @default(now())
  users           users?      @relation(fields: [user_id], references: [id])

  @@index([metric])
  @@index([occurred_at])
  @@index([scope_type, scope_id, metric, occurred_at])
}

model user_badges {
  id             String        @id
  user_id        String
  badge_id       String
  awarded_at     DateTime      @default(now())
  badges         badges        @relation(fields: [badge_id], references: [id])
  users          users         @relation(fields: [user_id], references: [id])
  institutions   institutions? @relation(fields: [institution_id], references: [id])
  institution_id String?

  @@unique([user_id, badge_id])
  @@index([institution_id])
}

model user_identities {
  id            String    @id @default(uuid())
  user_id       String
  provider      String
  provider_id   String
  email         String?
  password_hash String?
  metadata      Json?
  last_login_at DateTime?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  users users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([provider, provider_id])
  @@index([user_id])
  @@index([email])
}

model user_library_items {
  id                 String            @id
  user_id            String
  content_id         String
  content_version_id String?
  status             LibraryStatus     @default(SAVED)
  last_accessed_at   DateTime          @default(now())
  created_at         DateTime          @default(now())
  contents           contents          @relation(fields: [content_id], references: [id])
  content_versions   content_versions? @relation(fields: [content_version_id], references: [id])
  users              users             @relation(fields: [user_id], references: [id])
}

model user_topic_mastery {
  id                  String   @id
  user_id             String
  topic               String
  subject             String
  mastery_level       Float    @default(0)
  questions_attempted Int      @default(0)
  questions_correct   Int      @default(0)
  streak              Int      @default(0)
  time_spent          Int      @default(0)
  last_activity_at    DateTime @default(now())
  created_at          DateTime @default(now())
  updated_at          DateTime
  users               users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, topic, subject])
  @@index([topic])
  @@index([user_id])
}

model user_vocabularies {
  id              String           @id
  user_id         String
  word            String
  language        Language
  mastery_score   Int              @default(0)
  last_seen_at    DateTime         @default(now())
  srs_stage       SrsStage         @default(NEW)
  due_at          DateTime         @default(now())
  lapses_count    Int              @default(0)
  mastery_form    Int              @default(0)
  mastery_meaning Int              @default(0)
  mastery_use     Int              @default(0)
  content_id      String?
  meaning_note    String?
  example_note    String?
  created_at      DateTime         @default(now())
  updated_at      DateTime
  contents        contents?        @relation(fields: [content_id], references: [id])
  users           users            @relation(fields: [user_id], references: [id])
  vocab_attempts  vocab_attempts[]
  institution_id  String?
  institutions    institutions?    @relation(fields: [institution_id], references: [id])

  @@unique([user_id, word, language])
  @@index([srs_stage])
  @@index([user_id, due_at])
  @@index([institution_id])
}

model telemetry_events {
  id String @id @default(cuid())

  // Event Info
  event_type        String // 'session_started', 'section_viewed', etc.
  event_version     String  @default("1.0.0")
  ui_policy_version String?

  // Context
  user_id    String
  session_id String
  content_id String?
  mode       ContentMode?

  // Payload (JSON)
  data Json

  // Metadata
  created_at DateTime @default(now())

  // Relations
  user    users?    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  content contents? @relation(fields: [content_id], references: [id], onDelete: Cascade)

  @@index([user_id, created_at])
  @@index([session_id])
  @@index([event_type, created_at])
  @@index([content_id, created_at])
  @@index([user_id, event_type, created_at])
  @@index([session_id, event_type])
}

model users {
  id                  String      @id @default(uuid())
  name                String
  email               String      @unique
  system_role         SystemRole?
  last_context_role   ContextRole @default(OWNER)
  last_institution_id String?

  // @deprecated - Use learner_profiles.education_level instead
  schooling_level        String?
  age                    Int?
  sex                    String?
  preferred_languages    Json      @default("[]")
  created_at             DateTime  @default(now())
  updated_at             DateTime  @updatedAt
  last_login_at          DateTime?
  status                 String    @default("ACTIVE")
  avatar_url             String?
  bio                    String?
  settings               Json?     @default("{}")
  address                String?
  birthday               DateTime?
  password_reset_token   String?   @unique
  password_reset_expires DateTime?

  institutions          institutions?          @relation(fields: [last_institution_id], references: [id])
  institution_members   institution_members[] // ✅ Issue #6: Changed to array for multi-tenant support
  teacher_verifications teacher_verifications?

  annotation_comments          annotation_comments[]
  annotations                  annotations[]
  assessment_attempts          assessment_attempts[]
  class_plan_weeks             class_plan_weeks[]
  classrooms                   classrooms[]
  co_reading_sessions_educator co_reading_sessions[]    @relation("co_reading_sessions_educator_user_idTousers")
  co_reading_sessions_learner  co_reading_sessions[]    @relation("co_reading_sessions_learner_user_idTousers")
  contents_created_by          contents[]               @relation("contents_created_byTousers")
  contents_owner               contents[]               @relation("contents_owner_user_idTousers")
  cornell_notes                cornell_notes[]
  daily_activities             daily_activities[]
  daily_goals                  daily_goals[]
  enrollments                  enrollments[]
  entitlement_snapshots        entitlement_snapshots[]
  extension_device_auth        extension_device_auth[]
  extension_grants             extension_grants[]
  families_owned               families[]               @relation("families_owner_user_idTousers")
  family_members               family_members[]
  family_policies              family_policies[]
  game_progress                game_progress[]
  game_results                 game_results[]
  group_chat_messages          group_chat_messages[]
  group_session_members        group_session_members[]
  highlights                   highlights[]
  institution_invites          institution_invites[]
  layer_eligibility            layer_eligibility?
  learner_profiles             learner_profiles?
  pending_user_approvals       pending_user_approvals[]
  provider_usage               provider_usage[]
  question_results             question_results[]
  reading_sessions             reading_sessions[]
  streaks                      streaks?
  study_group_members          study_group_members[]
  study_groups                 study_groups[]
  study_sessions               study_sessions[]
  subscriptions                subscriptions[]
  teacher_verified             teacher_verifications[]  @relation("VerifiedBy")
  payment_methods              payment_methods[]
  usage_events                 usage_events[]
  user_badges                  user_badges[]
  user_identities              user_identities[]
  user_library_items           user_library_items[]

  user_topic_mastery    user_topic_mastery[]
  user_vocabularies     user_vocabularies[]
  comments              comments[]
  telemetry_events      telemetry_events[]
  reading_progress      reading_progress[]
  bookmarks             bookmarks[]
  transfer_attempts     transfer_attempts[]
  decision_logs         decision_logs[]
  pkm_notes             pkm_notes[]
  topic_edge_votes      topic_edge_votes[] // GRAPH SCRIPT 01
  hourly_activity_cache hourly_activity_cache[]
  vocab_items           vocab_items[]
  study_groups_personal study_groups[]          @relation("study_groups_personal") // Issue #3: Personal groups
}

model vocab_attempts {
  id                String            @id
  vocab_id          String
  session_id        String?
  dimension         VocabDimension
  result            AttemptResult
  created_at        DateTime          @default(now())
  reading_sessions  reading_sessions? @relation(fields: [session_id], references: [id])
  user_vocabularies user_vocabularies @relation(fields: [vocab_id], references: [id], onDelete: Cascade)

  @@index([created_at])
  @@index([vocab_id])
}

model reading_progress {
  user_id    String
  content_id String

  last_page       Int     @default(0)
  last_scroll_pct Float   @default(0)
  device_info     String?

  updated_at DateTime @updatedAt

  users    users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  contents contents @relation(fields: [content_id], references: [id], onDelete: Cascade)

  @@id([user_id, content_id])
}

model pkm_notes {
  id              String        @id @default(uuid())
  user_id         String
  content_id      String?
  session_id      String?
  mission_id      String?
  topic_node_id   String? // Link to knowledge graph node
  title           String
  body_md         String
  tags_json       Json          @default("[]")
  backlinks_json  Json          @default("{}")
  source_metadata Json          @default("{}")
  status          PkmNoteStatus @default(GENERATED)
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt

  users       users        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  contents    contents?    @relation(fields: [content_id], references: [id], onDelete: SetNull)
  topic_nodes topic_nodes? @relation(fields: [topic_node_id], references: [id], onDelete: SetNull)

  @@index([user_id])
  @@index([content_id])
  @@index([session_id])
  @@index([mission_id])
  @@index([topic_node_id])
  @@index([status])
  @@index([created_at])
}

model bookmarks {
  id         String @id @default(uuid())
  user_id    String
  content_id String

  page_number Int
  scroll_pct  Float?
  label       String?
  color       String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  users    users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  contents contents @relation(fields: [content_id], references: [id], onDelete: Cascade)

  @@index([user_id, content_id])
}

model glossary_cache {
  term       String   @id
  definition Json
  created_at DateTime @default(now())

  @@index([term])
}

model section_transfer_metadata {
  id             String    @id @default(uuid())
  content_id     String
  chunk_id       String?
  chunk_index    Int?
  page_number    Int?
  anchor_json    Json?
  version        String    @default("1.0.0")
  concept_json   Json      @default("{}")
  tier2_json     Json      @default("[]")
  analogies_json Json      @default("[]")
  domains_json   Json      @default("[]")
  tools_json     Json      @default("{}")
  created_by     String?
  scope_type     ScopeType @default(USER)
  family_id      String?
  institution_id String?
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt

  contents       contents        @relation(fields: [content_id], references: [id], onDelete: Cascade)
  content_chunks content_chunks? @relation(fields: [chunk_id], references: [id], onDelete: SetNull)

  @@index([content_id])
  @@index([chunk_id])
  @@index([scope_type, family_id, institution_id])
}

model transfer_missions {
  id              String              @id @default(uuid())
  type            TransferMissionType
  title           String
  description     String?
  prompt_template String
  rubric_json     Json                @default("{}")
  difficulty      Int                 @default(1)
  tags_json       Json                @default("[]")
  scope_type      ScopeType           @default(GLOBAL)
  family_id       String?
  institution_id  String?
  created_by      String?
  created_at      DateTime            @default(now())
  updated_at      DateTime            @updatedAt
  is_active       Boolean             @default(true)

  transfer_attempts transfer_attempts[]

  @@index([type])
  @@index([scope_type, family_id, institution_id])
}

model transfer_attempts {
  id            String          @id @default(uuid())
  mission_id    String
  user_id       String
  content_id    String?
  chunk_id      String?
  response_text String?
  score         Int?
  status        String          @default("PENDING")
  feedback_json Json            @default("{}")
  channel       DecisionChannel @default(DETERMINISTIC)
  created_at    DateTime        @default(now())
  updated_at    DateTime        @updatedAt

  transfer_missions transfer_missions @relation(fields: [mission_id], references: [id], onDelete: Cascade)
  users             users             @relation(fields: [user_id], references: [id], onDelete: Cascade)
  contents          contents?         @relation(fields: [content_id], references: [id], onDelete: SetNull)
  content_chunks    content_chunks?   @relation(fields: [chunk_id], references: [id], onDelete: SetNull)

  @@index([user_id, created_at])
  @@index([mission_id, created_at])
  @@index([status])
}

model decision_logs {
  id                String          @id @default(uuid())
  user_id           String? // ✅ Issue #7: Nullable to preserve audit trail
  session_id        String
  content_id        String?
  chunk_id          String?
  reason            DecisionReason
  channel           DecisionChannel
  ui_policy_version String?
  input_facts_json  Json            @default("{}")
  output_action     String
  created_at        DateTime        @default(now())

  // v2 fields for improved auditability
  candidate_action        DecisionAction?
  final_action            DecisionAction?
  suppressed              Boolean          @default(false)
  suppress_reasons_json   Json             @default("[]")
  channel_before          DecisionChannel?
  channel_after           DecisionChannel?
  budget_remaining_tokens Int?
  cooldown_until          DateTime?
  policy_snapshot_json    Json             @default("{}")

  users          users?          @relation(fields: [user_id], references: [id], onDelete: SetNull) // ✅ Issue #7: Preserve decision logs
  contents       contents?       @relation(fields: [content_id], references: [id], onDelete: SetNull)
  content_chunks content_chunks? @relation(fields: [chunk_id], references: [id], onDelete: SetNull)

  @@index([user_id, created_at])
  @@index([session_id, created_at])
  @@index([reason, created_at])
  @@index([created_at])
  @@index([user_id, content_id])
  @@index([session_id])
  @@index([content_id])
}

enum AnnotationShareMode {
  VIEW
  COMMENT
}

enum AnnotationStatus {
  ACTIVE
  DELETED
}

enum AnnotationType {
  EVIDENCE
  VOCABULARY
  MAIN_IDEA
  DOUBT
  SYNTHESIS
  COMMENT
  // Legacy types
  HIGHLIGHT
  NOTE
}

enum AnnotationVisibility {
  PRIVATE
  GROUP
  PUBLIC
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AssetLayer {
  L1
  L2
  L3
}

enum AttemptResult {
  FAIL
  HARD
  OK
  EASY
}

enum BillingPeriod {
  MONTHLY
  ANNUAL
}

enum ClassPrivacyMode {
  AGGREGATED_ONLY
  AGGREGATED_PLUS_HELP_REQUESTS
  AGGREGATED_PLUS_FLAGS
}

enum CoReadingStatus {
  ACTIVE
  COMPLETED
  ABANDONED
}

enum CoSessionType {
  CO_READING
  TEACH_BACK
}

enum CommentTargetType {
  CONTENT
  ANNOTATION
  SUBMISSION
}

enum ConfigType {
  STRING
  NUMBER
  BOOLEAN
  JSON
  SECRET_REF
}

enum ContentOwnerType {
  USER
  INSTITUTION
  CLASSROOM
}

enum ContentType {
  NEWS
  ARXIV
  SCHOOL_MATERIAL
  PDF
  IMAGE
  DOCX
  ARTICLE
  WEB_CLIP
  VIDEO
  AUDIO
  TEXT
}

enum ContextRole {
  OWNER
  INSTITUTION_EDUCATION_ADMIN
  TEACHER
  STUDENT
  INSTITUTION_ENTERPRISE_ADMIN
  EMPLOYEE
}

enum ContextType {
  INSTITUTION
  GROUP_STUDY
  FAMILY
}

enum DailyGoalType {
  MINUTES
  LESSONS
}

enum EducationLevel {
  FUNDAMENTAL_1
  FUNDAMENTAL_2
  MEDIO
  SUPERIOR
  ADULTO_LEIGO
}

enum EnrollmentStatus {
  ACTIVE
  PENDING
  REMOVED
}

enum Environment {
  DEV
  STAGING
  PROD
}

enum EventType {
  MARK_UNKNOWN_WORD
  MARK_KEY_IDEA
  CHECKPOINT_RESPONSE
  QUIZ_RESPONSE
  PRODUCTION_SUBMIT
  CLASS_ALERT_RAISED
  CLASS_POLICY_SET
  CLASS_WEEKLY_PLAN_CREATED
  FAMILY_POLICY_SET
  CO_SESSION_STARTED
  CO_SESSION_PHASE_CHANGED
  EDUCATOR_INTERVENTION_CHOSEN
  FAMILY_ALERT_RAISED
  CO_SESSION_FINISHED
  ANNOTATION_FAVORITE_TOGGLED
  ANNOTATION_REPLY_CREATED
  PROMPT_SENT
  PROMPT_RECEIVED
}

enum ExtractionStatus {
  PENDING
  RUNNING
  DONE
  FAILED
}

enum FamilyMemberStatus {
  INVITED
  ACTIVE
  REMOVED
}

enum FamilyRole {
  OWNER
  GUARDIAN
  CHILD
}

enum GroupMemberStatus {
  ACTIVE
  INVITED
  REMOVED
}

enum GroupRole {
  OWNER
  MOD
  MEMBER
}

enum GroupSessionMode {
  PI_SPRINT
  JIGSAW_MICRO
  TBL_LITE
}

enum GroupSessionStatus {
  CREATED
  RUNNING
  POST
  FINISHED
}

enum HighlightKind {
  TEXT
  AREA
}

enum InstitutionKind {
  EDUCATION
  ENTERPRISE
}

enum InstitutionRole {
  INSTITUTION_EDUCATION_ADMIN
  TEACHER
  STUDENT
  INSTITUTION_ENTERPRISE_ADMIN
  EMPLOYEE
}

enum InstitutionType {
  SCHOOL
  UNIVERSITY
  COURSE
  OTHER
}

enum InterventionMode {
  PROMPT_COACH
  PROMPT_COACH_PLUS_1ON1
}

enum JobStatus {
  RUNNING
  COMPLETED
  FAILED
}

enum Language {
  PT_BR
  EN
  KO
}

enum LessonStatus {
  LOCKED
  AVAILABLE
  IN_PROGRESS
  COMPLETED
}

enum LibraryStatus {
  SAVED
  IN_PROGRESS
  COMPLETED
}

enum MemberStatus {
  ACTIVE
  SUSPENDED
  LEFT
}

enum OrgUserStatus {
  PROVISIONED
  ACTIVE_LICENSED
  SUSPENDED
  DEPROVISIONED
}

enum PaymentProvider {
  STRIPE
  MANUAL_INVOICE
  OTHER
}

enum PlanType {
  FREE
  INDIVIDUAL_PREMIUM
  FAMILY
  INSTITUTION
}

enum PrivacyMode {
  AGGREGATED_ONLY
  AGGREGATED_PLUS_TRIGGERS
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
}

enum RoundStatus {
  CREATED
  VOTING
  DISCUSSING
  REVOTING
  EXPLAINING
  DONE
}

enum SSOProvider {
  SAML
  GOOGLE_WORKSPACE
  MICROSOFT_ENTRA
  OKTA
  CUSTOM_OIDC
}

enum ScopeType {
  GLOBAL
  INSTITUTION
  USER
  FAMILY
}

enum SessionModality {
  READING
  LISTENING
  WRITING
}

enum SessionPhase {
  PRE
  DURING
  POST
  FINISHED
}

enum SessionRole {
  FACILITATOR
  TIMEKEEPER
  CLARIFIER
  CONNECTOR
  SCRIBE
}

enum ShareContextType {
  CLASSROOM
  FAMILY
  STUDY_GROUP
}

enum SharePermission {
  VIEW
  COMMENT
  ASSIGN
}

enum SrsStage {
  NEW
  D1
  D3
  D7
  D14
  D30
  D60
  MASTERED
}

enum SubscriptionSource {
  INTERNAL
  PAYMENT_PROVIDER
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  GRACE_PERIOD
  EXPIRED
  SUSPENDED
}

enum SystemRole {
  ADMIN
  SUPPORT
  OPS
}

// TODO: [TECH DEBT] Consolidate TargetType into ContentType
// Enum TargetType removed/merged into ContentType (Phase 2)

enum TeacherVerificationStatus {
  PENDING
  VERIFIED
  REVOKED
}

enum VisibilityScope {
  CLASS_PROJECT
  ONLY_EDUCATORS
  RESPONSIBLES_OF_LEARNER
  GROUP_MEMBERS
}

enum VocabDimension {
  FORM
  MEANING
  USE
}

enum EntitlementScopeType {
  USER
  FAMILY
  INSTITUTION
}

enum FamilyLearningRole {
  EDUCATOR
  LEARNER
  PEER
}

enum ContentMode {
  NARRATIVE
  DIDACTIC
  TECHNICAL
  NEWS
  SCIENTIFIC
  LANGUAGE
}

enum TransferMissionType {
  HUGGING
  BRIDGING
  PRODUCTIVE_FAILURE
  ICEBERG
  CONNECTION_CIRCLE
  ANALOGY
  TIER2
  MORPHOLOGY
  METACOGNITION
  PKM
}

enum DecisionChannel {
  DETERMINISTIC
  CACHED_LLM
  LLM
  TOOL_RAG
  HUMAN_IN_LOOP
}

enum DecisionReason {
  USER_EXPLICIT_ASK
  DOUBT_SPIKE
  VOCAB_MARKED
  CHECKPOINT_FAIL
  POST_SUMMARY
  LOW_FLOW
  LOW_MASTERY // SCRIPT 08: Productive Failure trigger
  HIGH_SWITCH_COST
  SRS_DUE
  TEACHER_TRIGGER
  PARENT_TRIGGER
  NO_TRIGGER
}

enum DecisionAction {
  NO_OP
  ASK_PROMPT
  ASSIGN_MISSION
  GUIDED_SYNTHESIS
  CALL_AGENT
  CALL_AI_SERVICE_EXTRACT
}

enum SuppressReason {
  POLICY_DISABLED
  BUDGET_EXCEEDED
  RATE_LIMITED
  COOLDOWN_ACTIVE
  PHASE_DURING_INVISIBLE
  LOW_FLOW_SILENCE
  SAFETY_GUARD
  MISSING_INPUTS
  DEGRADED_CAPABILITY
}

enum PkmNoteStatus {
  GENERATED // Created by system, pending user save
  SAVED // Confirmed/Saved by user
  ARCHIVED // Soft deleted or hidden
}

// ========== GRAPH SCRIPT 01: Knowledge Graph Enums ==========

enum GraphType {
  BASELINE // Pre-processing graph (deterministic from content)
  LEARNER // User-specific graph (built during reading)
  CURATED // Merged/curated graph (optional)
}

enum GraphScopeType {
  USER
  FAMILY
  INSTITUTION
  STUDY_GROUP
  GLOBAL
}

enum GraphSource {
  PREPROCESS // Generated during content preprocessing
  DETERMINISTIC // Rule-based extraction
  USER // User-created
  TEACHER // Teacher-created
  LLM // AI-generated
}

enum EdgeType {
  PREREQUISITE // A is prerequisite for B
  SUPPORTS // A supports B
  EXPLAINS // A explains B
  CAUSES // A causes B
  CONTRASTS // A contrasts with B
  ANALOGY // A is analogous to B
  PART_OF // A is part of B
  APPLIES_IN // A applies in domain B
  EXAMPLE_OF // A is example of B
  MENTIONS // A mentions B
  COVERS // A covers B
  LINKS_TO // A links to B
}

enum EvidenceType {
  CHUNK // Evidence from content chunk
  PAGE_AREA // Evidence from page region
  TIMESTAMP // Evidence from timestamp
  HIGHLIGHT // Evidence from user highlight
  CORNELL_CUE // Evidence from Cornell note cue
  CORNELL_SUMMARY // Evidence from Cornell summary
}

// ========== GRAPH SCRIPT 01: Knowledge Graph Models ==========

model topic_graphs {
  id               String         @id @default(uuid())
  type             GraphType
  scope_type       GraphScopeType
  scope_id         String? // userId | familyId | institutionId | studyGroupId | null if GLOBAL
  content_id       String? // graph can be per content (baseline/learner) OR global (registry)
  title            String?
  version          String         @default("1.0.0")
  policy_version   String? // snapshot of policy (DecisionService/UI policy)
  created_by       String? // userId
  last_compared_at DateTime? // GRAPH SCRIPT 19.9: Comparison Optimization
  created_at       DateTime       @default(now())
  updated_at       DateTime       @updatedAt

  contents    contents?     @relation(fields: [content_id], references: [id], onDelete: SetNull)
  topic_nodes topic_nodes[]
  topic_edges topic_edges[]

  @@index([type, scope_type, scope_id])
  @@index([content_id, type])
}

model topic_nodes {
  id                 String      @id @default(uuid())
  graph_id           String
  canonical_label    String
  slug               String
  aliases_json       Json        @default("[]") // synonyms/variations
  domain_tags_json   Json        @default("[]") // ex: "biology", "finance", "rhetoric"
  tier2_json         Json        @default("[]") // bridge terms associated
  attributes_json    Json        @default("{}") // optional: short definition, examples
  confidence         Float       @default(0.5)
  source             GraphSource @default(DETERMINISTIC)
  last_reinforced_at DateTime? // GRAPH SCRIPT 19.10: Temporal Decay
  created_at         DateTime    @default(now())
  updated_at         DateTime    @updatedAt

  topic_graphs topic_graphs  @relation(fields: [graph_id], references: [id], onDelete: Cascade)
  edges_from   topic_edges[] @relation("edge_from")
  edges_to     topic_edges[] @relation("edge_to")
  pkm_notes    pkm_notes[] // Collaborative annotations linked to this node

  @@unique([graph_id, slug])
  @@index([graph_id, canonical_label])
  @@index([last_reinforced_at]) // GRAPH SCRIPT 19.10: Decay query optimization
}

model topic_edges {
  id             String      @id @default(uuid())
  graph_id       String
  from_node_id   String
  to_node_id     String
  edge_type      EdgeType
  direction      String? // "A_TO_B" | "BIDIR" | null (when non-directional)
  rationale_json Json        @default("{}") // structure: {claim, mapping?, constraints?, notes?}
  confidence     Float       @default(0.5)
  source         GraphSource @default(DETERMINISTIC)
  created_at     DateTime    @default(now())
  updated_at     DateTime    @updatedAt

  topic_graphs        topic_graphs          @relation(fields: [graph_id], references: [id], onDelete: Cascade)
  from_node           topic_nodes           @relation("edge_from", fields: [from_node_id], references: [id], onDelete: Cascade)
  to_node             topic_nodes           @relation("edge_to", fields: [to_node_id], references: [id], onDelete: Cascade)
  topic_edge_evidence topic_edge_evidence[]
  topic_edge_votes    topic_edge_votes[]

  @@index([graph_id, edge_type])
  @@index([from_node_id, to_node_id])
}

model topic_edge_evidence {
  id              String       @id @default(uuid())
  edge_id         String
  evidence_type   EvidenceType
  content_id      String?
  chunk_id        String?
  chunk_index     Int?
  page_number     Int?
  timestamp_ms    Int?
  anchor_json     Json?
  highlight_id    String?
  cornell_note_id String?
  excerpt         String? // small excerpt allowed (avoid storing long texts)
  created_at      DateTime     @default(now())

  topic_edges    topic_edges     @relation(fields: [edge_id], references: [id], onDelete: Cascade)
  contents       contents?       @relation(fields: [content_id], references: [id], onDelete: SetNull)
  content_chunks content_chunks? @relation(fields: [chunk_id], references: [id], onDelete: SetNull)
  highlights     highlights?     @relation(fields: [highlight_id], references: [id], onDelete: SetNull)
  cornell_notes  cornell_notes?  @relation(fields: [cornell_note_id], references: [id], onDelete: SetNull)

  @@index([edge_id])
  @@index([content_id])
  @@index([chunk_id, page_number, timestamp_ms])
}

model topic_edge_votes {
  id         String   @id @default(uuid())
  edge_id    String
  user_id    String
  vote       Int // -1 disagree, +1 agree
  comment    String?
  created_at DateTime @default(now())

  topic_edges topic_edges @relation(fields: [edge_id], references: [id], onDelete: Cascade)
  users       users       @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([edge_id, user_id])
  @@index([edge_id])
}

model graph_diffs {
  id                String   @id @default(uuid())
  user_id           String
  content_id        String
  baseline_graph_id String
  learner_graph_id  String
  diff_json         Json     @default("{}")
  summary_json      Json     @default("{}")
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  @@index([user_id, content_id])
}

// ========== GRAPH SCRIPT 08: Deterministic Source Builder ==========

enum DeterministicSourceScope {
  GLOBAL
  INSTITUTION
  STUDY_GROUP
  FAMILY
  USER
}

enum DeterministicSourceStatus {
  CANDIDATE
  ACTIVE
  DEPRECATED
}

model topic_registry {
  id               String                    @id @default(uuid())
  scope_type       DeterministicSourceScope
  scope_id         String?
  canonical_label  String
  slug             String
  aliases_json     Json                      @default("[]")
  domain_tags_json Json                      @default("[]")
  tier2_json       Json                      @default("[]")
  stats_json       Json                      @default("{}")
  status           DeterministicSourceStatus @default(CANDIDATE)
  confidence       Float                     @default(0.5)
  created_at       DateTime                  @default(now())
  updated_at       DateTime                  @updatedAt

  topic_aliases topic_aliases[]

  @@unique([scope_type, scope_id, slug])
  @@index([scope_type, scope_id, canonical_label])
}

model topic_aliases {
  id          String   @id @default(uuid())
  registry_id String
  alias       String
  normalized  String
  weight      Float    @default(0.5)
  source      String?
  created_at  DateTime @default(now())

  topic_registry topic_registry @relation(fields: [registry_id], references: [id], onDelete: Cascade)

  @@unique([registry_id, normalized])
  @@index([normalized])
}

model edge_priors {
  id               String                    @id @default(uuid())
  scope_type       DeterministicSourceScope
  scope_id         String?
  from_slug        String
  to_slug          String
  edge_type        EdgeType
  direction        String?
  prior_weight     Float                     @default(0.3)
  evidence_count   Int                       @default(0)
  vote_score       Int                       @default(0)
  performance_json Json                      @default("{}")
  rationale_json   Json                      @default("{}")
  status           DeterministicSourceStatus @default(CANDIDATE)
  updated_at       DateTime                  @updatedAt
  created_at       DateTime                  @default(now())

  @@unique([scope_type, scope_id, from_slug, to_slug, edge_type])
  @@index([scope_type, scope_id, edge_type])
}

model deterministic_build_runs {
  id           String                   @id @default(uuid())
  scope_type   DeterministicSourceScope
  scope_id     String?
  content_id   String?
  mode         String?
  dry_run      Boolean                  @default(false)
  started_at   DateTime                 @default(now())
  finished_at  DateTime?
  summary_json Json                     @default("{}")
  created_by   String?

  @@index([scope_type, scope_id])
  @@index([content_id])
}

// ========== GRAPH SCRIPT 09: Decision Weighting Layer (DWL) ==========

model determinism_scores {
  id         String         @id @default(uuid())
  scope_type GraphScopeType
  scope_id   String?
  content_id String

  // Section reference (at least one should exist for granular scoring)
  chunk_id     String?
  chunk_index  Int?
  page_number  Int?
  timestamp_ms Int?

  // DCS and weights
  dcs   Float @default(0.0) // Determinism Confidence Score [0..1]
  w_det Float @default(0.0) // Weight deterministic = dcs
  w_llm Float @default(1.0) // Weight LLM = 1 - dcs

  // Component breakdown for observability
  components_json Json @default("{}") // {coverage, matchQuality, evidenceStrength, stability, curation, docSupport}

  computed_at DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@index([scope_type, scope_id, content_id])
  @@index([content_id, chunk_id, page_number, timestamp_ms])
}

model decision_weight_events {
  id               String  @id @default(uuid())
  session_id       String?
  user_id          String?
  content_id       String?
  section_ref_json Json    @default("{}") // {chunkId, pageNumber, timestampMs}

  dcs   Float
  w_det Float
  w_llm Float

  action     String // NO_OP/ASK_PROMPT/CALL_AGENT/CALL_AI_SERVICE
  suppressed Boolean @default(false) // LLM call suppressed by high DCS
  reason     String?

  created_at DateTime @default(now())

  @@index([session_id])
  @@index([content_id])
}

model hourly_activity_cache {
  id             String        @id @default(uuid())
  user_id        String
  period         String
  time_slot      String
  minutes        Int           @default(0)
  last_updated   DateTime      @default(now())
  institutions   institutions? @relation(fields: [institution_id], references: [id])
  institution_id String?

  users users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, period, time_slot, institution_id])
  @@index([user_id, period])
  @@index([institution_id])
}

// ============================================================
// SRS (Spaced Repetition System) - Vocabulary Management
// ============================================================

model vocab_items {
  id         String  @id @default(uuid())
  user_id    String
  content_id String // Conteúdo onde a palavra foi encontrada pela PRIMEIRA vez
  word       String // Palavra marcada
  context    String? // Exemplo de uso (frase completa)

  // SRS Fields
  srs_stage        SrsStage  @default(NEW)
  due_at           DateTime // Próxima revisão agendada
  last_reviewed_at DateTime? // Data da última revisão realizada (para analytics)

  // Metrics
  mastery_score Int @default(0) // 0-100 para tracking de proficiência
  lapse_count   Int @default(0) // Quantas vezes falhou (para identificar "leechs")

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  users    users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  contents contents @relation(fields: [content_id], references: [id])

  // Indexes & Constraints
  @@unique([user_id, word]) // Garante que cada usuário tenha apenas um registro por palavra
  @@index([user_id, due_at]) // Otimiza busca de "o que revisar hoje"
  @@index([word]) // Otimiza análise global de vocabulário
}

// ============================================================
// ITEM BANK - Question Bank Unification (Phase 3.2)
// ============================================================

enum ItemType {
  MULTIPLE_CHOICE
  OPEN_ENDED
  TRUE_FALSE
  FILL_IN_THE_BLANK
  MATCHING
  ORDERING
}

enum BloomTaxonomy {
  REMEMBER
  UNDERSTAND
  APPLY
  ANALYZE
  EVALUATE
  CREATE
}

enum ItemVisibility {
  PRIVATE // Only creator can access
  INSTITUTION // All members of the institution
  PUBLIC // All users across all institutions
}

model item_bank {
  id             String   @id @default(uuid())
  type           ItemType
  text           String
  options        Json? // Options for MC, etc.
  correct_answer Json? // Validation logic
  explanation    String? // Feedback

  // Categorization
  language    Language
  difficulty  Float? // 0.0 - 1.0 (normalized)
  bloom_level BloomTaxonomy?

  // Metadata
  tags     String[]
  metadata Json?

  // Isolation & Visibility (Security Fix - Issue #1)
  scope_type ScopeType      @default(GLOBAL)
  scope_id   String? // institution_id, family_id, or user_id
  visibility ItemVisibility @default(PRIVATE)

  // Audit
  created_by String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Legacy/Migration tracking
  legacy_id String?

  question_analytics    question_analytics?
  question_results      question_results[]
  question_translations question_translations[]

  @@index([language, difficulty])
  @@index([type])
  @@index([scope_type, scope_id, language]) // Multi-tenant queries
  @@index([visibility, language]) // Public item discovery
  @@index([created_by]) // Creator lookup
}

model graph_comparison_outcomes {
  id          String   @id @default(uuid())
  user_id     String
  had_changes Boolean
  recorded_at DateTime @default(now())

  @@index([user_id])
  @@index([recorded_at(sort: Desc)])
  @@index([user_id, recorded_at(sort: Desc)])
}
