generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Institution {
  id               String                 @id @default(uuid())
  name             String
  type             InstitutionType
  city             String?
  state            String?
  country          String?
  createdAt        DateTime               @default(now()) @map("created_at")
  updatedAt        DateTime               @updatedAt @map("updated_at")
  maxMembers       Int?
  requiresApproval Boolean                @default(false) @map("requires_approval")
  slug             String?                @unique
  ssoEnabled       Boolean                @default(false) @map("sso_enabled")
  kind             InstitutionKind        @default(EDUCATION)
  assessments      Assessment[]
  classes          Class[]
  contents         Content[]
  domains          InstitutionDomain[]
  invites          InstitutionInvite[]
  members          InstitutionMember[]
  policy           OrgSubscriptionPolicy?
  pendingUsers     PendingUserApproval[]
  providerUsage    ProviderUsage[]
  ssoConfig        SSOConfiguration?
  subscriptions    Subscription[]
  users            User[]

  @@index([slug])
  @@map("institutions")
}

model InstitutionMember {
  id            String       @id @default(uuid())
  institutionId String       @map("institution_id")
  userId        String       @map("user_id")
  role          UserRole     @default(COMMON_USER)
  status        MemberStatus @default(ACTIVE)
  joinedAt      DateTime     @default(now()) @map("joined_at")
  leftAt        DateTime?    @map("left_at")
  institution   Institution  @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  user          User         @relation("InstitutionMemberships", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([institutionId, userId])
  @@index([institutionId, status])
  @@map("institution_members")
}

model InstitutionInvite {
  id            String      @id @default(uuid())
  institutionId String      @map("institution_id")
  email         String
  role          UserRole    @default(COMMON_USER)
  token         String      @unique
  expiresAt     DateTime    @map("expires_at")
  usedAt        DateTime?   @map("used_at")
  invitedBy     String      @map("invited_by")
  createdAt     DateTime    @default(now()) @map("created_at")
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  inviter       User        @relation("InvitesCreated", fields: [invitedBy], references: [id])

  @@index([token])
  @@index([email])
  @@index([institutionId, email])
  @@map("institution_invites")
}

model InstitutionDomain {
  id            String      @id @default(uuid())
  institutionId String      @map("institution_id")
  domain        String      @unique
  autoApprove   Boolean     @default(false) @map("auto_approve")
  defaultRole   UserRole    @default(COMMON_USER) @map("default_role")
  createdAt     DateTime    @default(now()) @map("created_at")
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  @@index([domain])
  @@map("institution_domains")
}

model PendingUserApproval {
  id               String         @id @default(uuid())
  institutionId    String         @map("institution_id")
  email            String
  name             String
  tempPasswordHash String         @map("temp_password_hash")
  requestedRole    UserRole       @default(COMMON_USER) @map("requested_role")
  status           ApprovalStatus @default(PENDING)
  reviewedBy       String?        @map("reviewed_by")
  reviewedAt       DateTime?      @map("reviewed_at")
  rejectionReason  String?        @map("rejection_reason")
  createdAt        DateTime       @default(now()) @map("created_at")
  institution      Institution    @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  reviewer         User?          @relation("ApprovalsReviewed", fields: [reviewedBy], references: [id])

  @@index([institutionId, status])
  @@index([email])
  @@map("pending_user_approvals")
}

model SSOConfiguration {
  id             String      @id @default(uuid())
  institutionId  String      @unique @map("institution_id")
  provider       SSOProvider
  enabled        Boolean     @default(false)
  entityId       String?     @map("entity_id")
  ssoUrl         String?     @map("sso_url")
  certificate    String?
  clientId       String?     @map("client_id")
  clientSecret   String?     @map("client_secret")
  authUrl        String?     @map("auth_url")
  tokenUrl       String?     @map("token_url")
  userInfoUrl    String?     @map("user_info_url")
  emailAttribute String?     @default("email") @map("email_attribute")
  nameAttribute  String?     @default("name") @map("name_attribute")
  roleAttribute  String?     @map("role_attribute")
  roleMapping    Json?       @map("role_mapping")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  institution    Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  @@map("sso_configurations")
}

model EntitlementSnapshot {
  id          String    @id @default(uuid())
  userId      String    @unique @map("user_id")
  source      String
  planType    PlanType  @map("plan_type")
  limits      Json
  features    Json      @default("{}")
  effectiveAt DateTime  @default(now()) @map("effective_at")
  expiresAt   DateTime? @map("expires_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("entitlement_snapshots")
}

model OrgSubscriptionPolicy {
  id               String      @id @default(uuid())
  institutionId    String      @unique @map("institution_id")
  baselineSeats    Int         @default(0) @map("baseline_seats")
  allowOverage     Boolean     @default(true) @map("allow_overage")
  graceDays        Int         @default(30) @map("grace_days")
  trueUpDayOfMonth Int         @default(1) @map("true_up_day_of_month")
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")
  institution      Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  @@map("org_subscription_policies")
}

model SeatAllocationEvent {
  id            String   @id @default(uuid())
  institutionId String   @map("institution_id")
  delta         Int
  reason        String
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([institutionId, createdAt])
  @@map("seat_allocation_events")
}

model User {
  id                     String                @id @default(uuid())
  institutionId          String?               @map("institution_id")
  name                   String
  email                  String                @unique
  passwordHash           String?               @map("password_hash")
  oauthProvider          String?               @map("oauth_provider")
  oauthId                String?               @map("oauth_id")
  oauthPicture           String?               @map("oauth_picture")
  role                   UserRole
  schoolingLevel         String                @map("schooling_level")
  age                    Int?
  sex                    String?
  preferredLanguages     Json                  @default("[]") @map("preferred_languages")
  createdAt              DateTime              @default(now()) @map("created_at")
  updatedAt              DateTime              @updatedAt @map("updated_at")
  lastLoginAt            DateTime?             @map("last_login_at")
  status                 String                @default("ACTIVE")
  avatarUrl              String?               @map("avatar_url")
  bio                    String?
  settings               Json?                 @default("{}")
  ssoProvider            String?               @map("sso_provider")
  ssoSubject             String?               @unique @map("sso_subject")
  passwordResetExpires   DateTime?             @map("password_reset_expires")
  passwordResetToken     String?               @map("password_reset_token")
  address                String?
  birthday               DateTime?
  activeInstitutionId    String?               @map("active_institution_id")
  contextRole            ContextRole           @default(OWNER) @map("context_role")
  systemRole             SystemRole?           @map("system_role")
  annotationComments     AnnotationComment[]   @relation("UserAnnotationComments")
  annotations            Annotation[]
  assessmentAttempts     AssessmentAttempt[]
  createdClassPlans      ClassPlanWeek[]       @relation("ClassPlansCreated")
  enrollments            ClassStudent[]
  ownedClassrooms        Classroom[]           @relation("ClassroomOwner")
  educatorSessions       CoReadingSession[]    @relation("EducatorSessions")
  learnerSessions        CoReadingSession[]    @relation("LearnerSessions")
  createdContents        Content[]             @relation("ContentCreator")
  ownedContents          Content[]             @relation("ContentOwner")
  cornellNotesEntries    CornellNotes[]        @relation("UserCornellNotes")
  dailyActivities        DailyActivity[]
  dailyGoals             DailyGoal[]
  studentEnrollments     Enrollment[]          @relation("StudentEnrollments")
  entitlementSnapshot    EntitlementSnapshot?
  extensionDeviceAuths   ExtensionDeviceAuth[]
  extensionGrants        ExtensionGrant[]
  ownedFamilies          Family[]              @relation("FamilyOwner")
  memberships            FamilyMember[]
  familyPolicies         FamilyPolicy[]        @relation("FamilyPolicies")
  gameProgress           GameProgress[]
  gameResults            GameResult[]
  chatMessages           GroupChatMessage[]
  groupSessionMembers    GroupSessionMember[]
  highlights             Highlight[]           @relation("UserHighlights")
  invitesCreated         InstitutionInvite[]   @relation("InvitesCreated")
  institutionMemberships InstitutionMember[]   @relation("InstitutionMemberships")
  layerEligibility       LayerEligibility?
  LearnerProfile         LearnerProfile?
  cornellNotes           CornellNote[]
  approvalsReviewed      PendingUserApproval[] @relation("ApprovalsReviewed")
  providerUsage          ProviderUsage[]
  QuestionResult         QuestionResult[]
  readingSessions        ReadingSession[]
  streak                 Streak?
  groupMemberships       StudyGroupMember[]
  ownedGroups            StudyGroup[]          @relation("GroupOwner")
  studySessions          StudySession[]
  subscriptions          Subscription[]
  usageEvents            UsageEvent[]
  assignedBadges         UserBadge[]
  libraryItems           UserLibraryItem[]
  roleAssignments        UserRoleAssignment[]  @relation("UserRoles")
  topicMastery           UserTopicMastery[]
  vocabularyEntries      UserVocabulary[]
  institution            Institution?          @relation(fields: [institutionId], references: [id])

  @@unique([oauthProvider, oauthId])
  @@map("users")
}

model GameProgress {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  gameId     String    @map("game_id")
  stars      Int       @default(0)
  bestScore  Float     @default(0)
  totalPlays Int       @default(0) @map("total_plays")
  streak     Int       @default(0)
  lastPlayed DateTime? @map("last_played")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId])
  @@index([userId])
  @@index([gameId])
  @@map("game_progress")
}

model UserTopicMastery {
  id                 String   @id @default(uuid())
  userId             String   @map("user_id")
  topic              String
  subject            String
  masteryLevel       Float    @default(0) @map("mastery_level")
  questionsAttempted Int      @default(0) @map("questions_attempted")
  questionsCorrect   Int      @default(0) @map("questions_correct")
  streak             Int      @default(0)
  timeSpent          Int      @default(0) @map("time_spent")
  lastActivityAt     DateTime @default(now()) @map("last_activity_at")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, topic, subject])
  @@index([userId])
  @@index([topic])
  @@map("user_topic_mastery")
}

model StudySession {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  startTime       DateTime  @map("start_time")
  endTime         DateTime? @map("end_time")
  durationMinutes Int?      @map("duration_minutes")
  netFocusMinutes Int?      @map("net_focus_minutes")
  focusScore      Float?    @map("focus_score")
  interruptions   Int       @default(0)
  activityType    String    @map("activity_type")
  contentId       String?   @map("content_id")
  sourceId        String?   @map("source_id")
  accuracyRate    Float?    @map("accuracy_rate")
  engagementScore Float?    @map("engagement_score")
  createdAt       DateTime  @default(now()) @map("created_at")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, startTime])
  @@index([userId, activityType])
  @@map("study_sessions")
}

model Class {
  id            String         @id @default(uuid())
  institutionId String         @map("institution_id")
  name          String
  gradeLevel    String         @map("grade_level")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  students      ClassStudent[]
  institution   Institution    @relation(fields: [institutionId], references: [id])

  @@map("classes")
}

model ClassStudent {
  classId   String @map("class_id")
  studentId String @map("student_id")
  class     Class  @relation(fields: [classId], references: [id])
  student   User   @relation(fields: [studentId], references: [id])

  @@id([classId, studentId])
  @@map("class_students")
}

model Course {
  id          String   @id @default(uuid())
  title       String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  lessons     Lesson[]

  @@map("courses")
}

model Lesson {
  id               String           @id @default(uuid())
  courseId         String           @map("course_id")
  title            String
  orderIndex       Int              @map("order_index")
  estimatedMinutes Int              @map("estimated_minutes")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  contentId        String?          @map("content_id")
  progress         LessonProgress[]
  content          Content?         @relation(fields: [contentId], references: [id])
  course           Course           @relation(fields: [courseId], references: [id])

  @@map("lessons")
}

model LessonProgress {
  id          String       @id @default(uuid())
  userId      String       @map("user_id")
  lessonId    String       @map("lesson_id")
  status      LessonStatus @default(AVAILABLE)
  progressPct Int          @default(0) @map("progress_pct")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  lesson      Lesson       @relation(fields: [lessonId], references: [id])

  @@unique([userId, lessonId])
  @@map("lesson_progress")
}

model Content {
  id               String                  @id @default(uuid())
  institutionId    String?                 @map("institution_id")
  type             ContentType
  sourceId         String?                 @map("source_id")
  title            String
  originalLanguage Language                @map("original_language")
  rawText          String                  @map("raw_text")
  metadata         Json?
  createdBy        String?                 @map("created_by")
  createdAt        DateTime                @default(now()) @map("created_at")
  updatedAt        DateTime                @updatedAt @map("updated_at")
  scopeType        ScopeType               @default(USER) @map("scope_type")
  familyId         String?                 @map("family_id")
  fileId           String?                 @map("file_id")
  languageGuess    String?                 @map("language_guess")
  ownerUserId      String?                 @map("owner_user_id")
  scopeId          String?                 @map("scope_id")
  sourceUrl        String?                 @map("source_url")
  duration         Int?                    @map("duration")
  annotations      Annotation[]
  assessments      Assessment[]
  chunks           ContentChunk[]
  extractions      ContentExtraction?
  pedagogicalData  ContentPedagogicalData?
  versions         ContentVersion[]
  creator          User?                   @relation("ContentCreator", fields: [createdBy], references: [id])
  family           Family?                 @relation(fields: [familyId], references: [id])
  file             File?                   @relation(fields: [fileId], references: [id])
  institution      Institution?            @relation(fields: [institutionId], references: [id])
  ownerUser        User?                   @relation("ContentOwner", fields: [ownerUserId], references: [id])
  cornellNotes     CornellNotes[]
  gameResults      GameResult[]
  groupContents    GroupContent[]
  groupSessions    GroupSession[]
  highlights       Highlight[]
  learningAssets   LearningAsset[]
  lessons          Lesson[]
  ReadingSession   ReadingSession[]
  UserLibraryItem  UserLibraryItem[]
  UserVocabulary   UserVocabulary[]

  @@index([title])
  @@index([ownerUserId])
  @@map("contents")
}

model ContentVersion {
  id                   String            @id @default(uuid())
  contentId            String            @map("content_id")
  targetLanguage       Language          @map("target_language")
  schoolingLevelTarget String            @map("schooling_level_target")
  simplifiedText       String            @map("simplified_text")
  summary              String?
  vocabularyGlossary   Json?             @map("vocabulary_glossary")
  createdAt            DateTime          @default(now()) @map("created_at")
  assessments          Assessment[]
  content              Content           @relation(fields: [contentId], references: [id])
  readingSessions      ReadingSession[]
  libraryItems         UserLibraryItem[]

  @@map("content_versions")
}

model UserLibraryItem {
  id               String          @id @default(uuid())
  userId           String          @map("user_id")
  contentId        String          @map("content_id")
  contentVersionId String?         @map("content_version_id")
  status           LibraryStatus   @default(SAVED)
  lastAccessedAt   DateTime        @default(now()) @map("last_accessed_at")
  createdAt        DateTime        @default(now()) @map("created_at")
  content          Content         @relation(fields: [contentId], references: [id])
  contentVersion   ContentVersion? @relation(fields: [contentVersionId], references: [id])
  user             User            @relation(fields: [userId], references: [id])

  @@map("user_library_items")
}

model ReadingSession {
  id               String            @id @default(uuid())
  userId           String            @map("user_id")
  contentId        String            @map("content_id")
  contentVersionId String?           @map("content_version_id")
  startedAt        DateTime          @default(now()) @map("started_at")
  finishedAt       DateTime?         @map("finished_at")
  phase            SessionPhase?     @default(PRE)
  modality         SessionModality?  @default(READING)
  assetLayer       String?           @default("L1") @map("asset_layer")
  goalStatement    String?           @map("goal_statement")
  predictionText   String?           @map("prediction_text")
  targetWordsJson  Json?             @map("target_words_json")
  coReadingSession CoReadingSession?
  cornellNotes     CornellNote[]
  content          Content           @relation(fields: [contentId], references: [id])
  contentVersion   ContentVersion?   @relation(fields: [contentVersionId], references: [id])
  user             User              @relation(fields: [userId], references: [id])
  events           SessionEvent[]
  outcome          SessionOutcome?
  VocabAttempt     VocabAttempt[]

  @@index([userId, startedAt(sort: Desc)], map: "user_sessions_list")
  @@index([userId, phase, startedAt], map: "user_sessions_phase")
  @@map("reading_sessions")
}

model CornellNote {
  id               String         @id @default(uuid())
  userId           String         @map("user_id")
  readingSessionId String         @map("reading_session_id")
  mainNotes        Json           @map("main_notes")
  cueColumn        String?        @map("cue_column")
  summary          String?
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  readingSession   ReadingSession @relation(fields: [readingSessionId], references: [id])
  user             User           @relation(fields: [userId], references: [id])

  @@map("legacy_cornell_notes")
}

model Assessment {
  id                   String               @id @default(uuid())
  contentId            String               @map("content_id")
  contentVersionId     String?              @map("content_version_id")
  institutionId        String?              @map("institution_id")
  schoolingLevelTarget String               @map("schooling_level_target")
  createdAt            DateTime             @default(now()) @map("created_at")
  updatedAt            DateTime             @updatedAt @map("updated_at")
  attempts             AssessmentAttempt[]
  questions            AssessmentQuestion[]
  content              Content              @relation(fields: [contentId], references: [id])
  contentVersion       ContentVersion?      @relation(fields: [contentVersionId], references: [id])
  institution          Institution?         @relation(fields: [institutionId], references: [id])

  @@map("assessments")
}

model AssessmentQuestion {
  id            String             @id @default(uuid())
  assessmentId  String             @map("assessment_id")
  questionType  QuestionType       @map("question_type")
  questionText  String             @map("question_text")
  options       Json?
  correctAnswer Json               @map("correct_answer")
  skills        String[]           @default([])
  answers       AssessmentAnswer[]
  assessment    Assessment         @relation(fields: [assessmentId], references: [id])

  @@map("assessment_questions")
}

model AssessmentAttempt {
  id           String             @id @default(uuid())
  assessmentId String             @map("assessment_id")
  userId       String             @map("user_id")
  startedAt    DateTime           @default(now()) @map("started_at")
  finishedAt   DateTime?          @map("finished_at")
  scoreRaw     Float?             @map("score_raw")
  scorePercent Float?             @map("score_percent")
  answers      AssessmentAnswer[]
  assessment   Assessment         @relation(fields: [assessmentId], references: [id])
  user         User               @relation(fields: [userId], references: [id])

  @@map("assessment_attempts")
}

model AssessmentAnswer {
  id                  String             @id @default(uuid())
  assessmentAttemptId String             @map("assessment_attempt_id")
  questionId          String             @map("question_id")
  userAnswer          Json               @map("user_answer")
  isCorrect           Boolean            @map("is_correct")
  timeSpentSeconds    Int?               @map("time_spent_seconds")
  assessmentAttempt   AssessmentAttempt  @relation(fields: [assessmentAttemptId], references: [id])
  question            AssessmentQuestion @relation(fields: [questionId], references: [id])

  @@map("assessment_answers")
}

model DailyGoal {
  id        String        @id @default(uuid())
  userId    String        @map("user_id")
  goalType  DailyGoalType @map("goal_type")
  goalValue Int           @map("goal_value")
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")
  user      User          @relation(fields: [userId], references: [id])

  @@map("daily_goals")
}

model DailyActivity {
  id                 String   @id @default(uuid())
  userId             String   @map("user_id")
  date               DateTime @db.Date
  minutesStudied     Int      @default(0) @map("minutes_studied")
  sessionsCount      Int      @default(0) @map("sessions_count")
  contentsRead       Int      @default(0) @map("contents_read")
  annotationsCreated Int      @default(0) @map("annotations_created")
  minutesSpent       Int      @default(0) @map("minutes_spent")
  lessonsCompleted   Int      @default(0) @map("lessons_completed")
  goalMet            Boolean  @default(false) @map("goal_met")
  createdAt          DateTime @default(now()) @map("created_at")
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
  @@map("daily_activities")
}

model Streak {
  userId          String    @id @map("user_id")
  currentStreak   Int       @default(0) @map("current_streak")
  bestStreak      Int       @default(0) @map("best_streak")
  lastGoalMetDate DateTime? @map("last_goal_met_date") @db.Date
  freezeTokens    Int       @default(1) @map("freeze_tokens")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  user            User      @relation(fields: [userId], references: [id])

  @@map("streaks")
}

model Badge {
  id          String      @id @default(uuid())
  code        String      @unique
  name        String
  description String
  imageUrl    String?     @map("image_url")
  userBadges  UserBadge[]

  @@map("badges")
}

model UserBadge {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  badgeId   String   @map("badge_id")
  awardedAt DateTime @default(now()) @map("awarded_at")
  badge     Badge    @relation(fields: [badgeId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, badgeId])
  @@map("user_badges")
}

model UserVocabulary {
  id             String         @id @default(uuid())
  userId         String         @map("user_id")
  word           String
  language       Language
  masteryScore   Int            @default(0) @map("mastery_score")
  lastSeenAt     DateTime       @default(now()) @map("last_seen_at")
  srsStage       SrsStage       @default(NEW) @map("srs_stage")
  dueAt          DateTime       @default(now()) @map("due_at")
  lapsesCount    Int            @default(0) @map("lapses_count")
  masteryForm    Int            @default(0) @map("mastery_form")
  masteryMeaning Int            @default(0) @map("mastery_meaning")
  masteryUse     Int            @default(0) @map("mastery_use")
  contentId      String?        @map("content_id")
  meaningNote    String?        @map("meaning_note")
  exampleNote    String?        @map("example_note")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  content        Content?       @relation(fields: [contentId], references: [id])
  user           User           @relation(fields: [userId], references: [id])
  attempts       VocabAttempt[]

  @@unique([userId, word, language])
  @@index([userId, dueAt])
  @@index([srsStage])
  @@map("user_vocabularies")
}

model UserRoleAssignment {
  id        String     @id @default(uuid())
  userId    String     @map("user_id")
  role      UserRole
  scopeType ScopeType? @map("scope_type")
  scopeId   String?    @map("scope_id")
  createdAt DateTime   @default(now()) @map("created_at")
  createdBy String?    @map("created_by")
  user      User       @relation("UserRoles", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role, scopeType, scopeId])
  @@index([userId])
  @@index([role])
  @@map("user_role_assignments")
}

model AuditLog {
  id           String    @id @default(uuid())
  actorUserId  String?   @map("actor_user_id")
  actorRole    UserRole? @map("actor_role")
  action       String
  resourceType String    @map("resource_type")
  resourceId   String?   @map("resource_id")
  requestId    String?   @map("request_id")
  ip           String?
  userAgent    String?   @map("user_agent")
  beforeJson   Json?     @map("before_json")
  afterJson    Json?     @map("after_json")
  reason       String?
  createdAt    DateTime  @default(now()) @map("created_at")

  @@index([actorUserId])
  @@index([action])
  @@index([resourceType])
  @@index([createdAt])
  @@index([requestId])
  @@map("audit_logs")
}

model FeatureFlag {
  id          String       @id @default(uuid())
  key         String       @unique
  name        String
  description String?
  enabled     Boolean      @default(false)
  environment Environment?
  scopeType   ScopeType?   @map("scope_type")
  scopeId     String?      @map("scope_id")
  createdBy   String?      @map("created_by")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  @@index([key])
  @@index([enabled])
  @@map("feature_flags")
}

model IntegrationSecret {
  id             String       @id @default(uuid())
  key            String       @unique
  name           String
  provider       String?
  encryptedValue String       @map("encrypted_value")
  encryptedDek   String       @map("encrypted_dek")
  iv             String
  authTag        String       @map("auth_tag")
  keyId          String       @default("v1") @map("key_id")
  environment    Environment?
  lastRotatedAt  DateTime?    @map("last_rotated_at")
  createdBy      String?      @map("created_by")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  @@index([key])
  @@index([provider])
  @@map("integration_secrets")
}

model SystemMetric {
  id        String   @id @default(uuid())
  metric    String
  value     Float
  tags      Json?
  timestamp DateTime @default(now())
  bucket    String

  @@index([metric, timestamp])
  @@index([bucket])
  @@map("system_metrics")
}

model ErrorLog {
  id         String   @id @default(uuid())
  message    String
  stack      String?
  endpoint   String?
  method     String?
  statusCode Int?     @map("status_code")
  userId     String?  @map("user_id")
  requestId  String?  @map("request_id")
  metadata   Json?
  timestamp  DateTime @default(now())
  resolved   Boolean  @default(false)

  @@index([timestamp])
  @@index([resolved])
  @@index([endpoint])
  @@map("error_logs")
}

model ProviderUsage {
  id               String       @id @default(uuid())
  provider         String
  operation        String
  tokens           Int?
  latency          Int?
  statusCode       Int?         @map("status_code")
  userId           String?      @map("user_id")
  metadata         Json?
  timestamp        DateTime     @default(now())
  completionTokens Int?         @map("completion_tokens")
  costUsd          Float?       @map("cost_usd")
  familyId         String?      @map("family_id")
  feature          String       @default("unknown")
  groupId          String?      @map("group_id")
  institutionId    String?      @map("institution_id")
  model            String?
  promptTokens     Int?         @map("prompt_tokens")
  totalTokens      Int?         @map("total_tokens")
  family           Family?      @relation(fields: [familyId], references: [id])
  group            StudyGroup?  @relation(fields: [groupId], references: [id])
  institution      Institution? @relation(fields: [institutionId], references: [id])
  user             User?        @relation(fields: [userId], references: [id])

  @@index([timestamp])
  @@index([userId, timestamp])
  @@index([familyId, timestamp])
  @@index([institutionId, timestamp])
  @@map("provider_usage")
}

model BackgroundJob {
  id          String    @id @default(uuid())
  jobName     String    @map("job_name")
  status      JobStatus
  startedAt   DateTime  @map("started_at")
  completedAt DateTime? @map("completed_at")
  duration    Int?
  error       String?
  metadata    Json?

  @@index([jobName, status])
  @@index([startedAt])
  @@map("background_jobs")
}

model AppConfig {
  id          String       @id @default(uuid())
  key         String       @unique
  value       String
  type        ConfigType
  category    String
  environment Environment?
  description String?
  metadata    Json?
  createdBy   String?      @map("created_by")
  updatedBy   String?      @map("updated_by")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  @@index([key])
  @@index([category])
  @@index([environment])
  @@map("app_configs")
}

model Plan {
  id             String         @id @default(uuid())
  code           String         @unique
  name           String
  description    String?
  isActive       Boolean        @default(true) @map("is_active")
  entitlements   Json
  monthlyPrice   Float?         @map("monthly_price")
  yearlyPrice    Float?         @map("yearly_price")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  billingPeriod  BillingPeriod? @map("billing_period")
  currency       String         @default("BRL")
  priceCents     Int            @default(0) @map("price_cents")
  seatPriceCents Int?           @map("seat_price_cents")
  type           PlanType       @default(FREE)
  subscriptions  Subscription[]

  @@index([code])
  @@index([isActive])
  @@map("plans")
}

model Subscription {
  id                     String             @id @default(uuid())
  scopeType              ScopeType          @map("scope_type")
  scopeId                String             @map("scope_id")
  planId                 String             @map("plan_id")
  status                 SubscriptionStatus
  source                 SubscriptionSource
  currentPeriodStart     DateTime?          @map("current_period_start")
  currentPeriodEnd       DateTime?          @map("current_period_end")
  cancelAtPeriodEnd      Boolean            @default(false) @map("cancel_at_period_end")
  providerCode           String?            @map("provider_code")
  providerCustomerId     String?            @map("provider_customer_id")
  providerSubscriptionId String?            @unique @map("provider_subscription_id")
  providerPriceId        String?            @map("provider_price_id")
  createdAt              DateTime           @default(now()) @map("created_at")
  updatedAt              DateTime           @updatedAt @map("updated_at")
  canceledAt             DateTime?          @map("canceled_at")
  endedAt                DateTime?          @map("ended_at")
  familyId               String?            @map("family_id")
  graceUntil             DateTime?          @map("grace_until")
  institutionId          String?            @map("institution_id")
  metadata               Json?
  provider               PaymentProvider?
  userId                 String?            @map("user_id")
  family                 Family?            @relation(fields: [familyId], references: [id])
  institution            Institution?       @relation(fields: [institutionId], references: [id])
  plan                   Plan               @relation(fields: [planId], references: [id])
  user                   User?              @relation(fields: [userId], references: [id])

  @@unique([scopeType, scopeId, status], name: "unique_active_subscription", map: "subscriptions_scope_status_unique")
  @@index([scopeType, scopeId])
  @@index([userId])
  @@index([familyId])
  @@index([institutionId])
  @@index([planId])
  @@index([status])
  @@map("subscriptions")
}

model EntitlementOverride {
  id        String    @id @default(uuid())
  scopeType ScopeType @map("scope_type")
  scopeId   String    @map("scope_id")
  overrides Json
  reason    String
  updatedBy String    @map("updated_by")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@unique([scopeType, scopeId])
  @@map("entitlement_overrides")
}

model UsageEvent {
  id            String      @id @default(uuid())
  environment   Environment
  occurredAt    DateTime    @map("occurred_at")
  scopeType     ScopeType   @map("scope_type")
  scopeId       String      @map("scope_id")
  providerCode  String?     @map("provider_code")
  endpoint      String?
  metric        String
  quantity      Float
  approxCostUsd Float?      @map("approx_cost_usd")
  requestId     String?     @map("request_id")
  userId        String?     @map("user_id")
  metadata      Json?
  createdAt     DateTime    @default(now()) @map("created_at")
  User          User?       @relation(fields: [userId], references: [id])

  @@index([scopeType, scopeId, metric, occurredAt])
  @@index([occurredAt])
  @@index([metric])
  @@map("usage_events")
}

model BillingEvent {
  id              String    @id @default(uuid())
  providerCode    String    @map("provider_code")
  providerEventId String    @unique @map("provider_event_id")
  eventType       String    @map("event_type")
  payload         Json
  processedAt     DateTime? @map("processed_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  @@index([providerCode])
  @@index([processedAt])
  @@map("billing_events")
}

model File {
  id               String    @id @default(uuid())
  storageProvider  String
  storageKey       String
  mimeType         String
  sizeBytes        BigInt
  checksumSha256   String?
  originalFilename String?
  createdAt        DateTime  @default(now())
  contents         Content[]

  @@index([storageProvider, storageKey])
  @@map("files")
}

model CornellNotes {
  id          String   @id @default(uuid())
  contentId   String
  createdAt   DateTime @default(now())
  cuesJson    Json     @default("[]")
  notesJson   Json     @default("[]")
  summaryText String   @default("")
  updatedAt   DateTime @default(now())
  userId      String
  content     Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user        User     @relation("UserCornellNotes", fields: [userId], references: [id])

  @@unique([contentId, userId])
  @@index([contentId])
  @@index([userId])
  @@map("cornell_notes")
}

model Highlight {
  id              String               @id @default(uuid())
  contentId       String
  userId          String
  kind            HighlightKind
  targetType      TargetType
  pageNumber      Int?
  anchorJson      Json
  colorKey        String               @default("yellow")
  commentText     String?
  tagsJson        Json                 @default("[]")
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @default(now())
  timestampMs     Int?                 @map("timestamp_ms")
  durationMs      Int?                 @map("duration_ms")
  visibility      AnnotationVisibility @default(PRIVATE)
  visibilityScope VisibilityScope?     @map("visibility_scope")
  contextType     ContextType?         @map("context_type")
  contextId       String?              @map("context_id")
  learnerId       String?              @map("learner_id")
  status          AnnotationStatus     @default(ACTIVE)
  deletedAt       DateTime?            @map("deleted_at")
  comments        AnnotationComment[]
  content         Content              @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user            User                 @relation("UserHighlights", fields: [userId], references: [id])

  @@index([contentId])
  @@index([userId])
  @@index([visibility])
  @@index([contextType])
  @@index([contextId])
  @@index([status])
  @@map("highlights")
}

model AnnotationComment {
  id          String           @id @default(uuid())
  highlightId String           @map("highlight_id")
  userId      String           @map("user_id")
  text        String
  status      AnnotationStatus @default(ACTIVE)
  deletedAt   DateTime?        @map("deleted_at")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")
  highlight   Highlight        @relation(fields: [highlightId], references: [id], onDelete: Cascade)
  user        User             @relation("UserAnnotationComments", fields: [userId], references: [id])

  @@index([highlightId])
  @@index([userId])
  @@index([status])
  @@map("annotation_comments")
}

model ContentExtraction {
  id               String           @id @default(uuid())
  contentId        String           @unique @map("content_id")
  status           ExtractionStatus @default(PENDING)
  extractedTextRef String?          @map("extracted_text_ref")
  metadataJson     Json?            @map("metadata_json")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  content          Content          @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@map("content_extractions")
}

model ContentChunk {
  id            String   @id @default(uuid())
  contentId     String   @map("content_id")
  chunkIndex    Int      @map("chunk_index")
  pageNumber    Int?     @map("page_number")
  text          String
  tokenEstimate Int?     @map("token_estimate")
  createdAt     DateTime @default(now()) @map("created_at")
  content       Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@unique([contentId, chunkIndex])
  @@index([contentId])
  @@index([pageNumber])
  @@map("content_chunks")
}

model LearnerProfile {
  userId              String         @id @map("user_id")
  educationLevel      EducationLevel @default(ADULTO_LEIGO) @map("education_level")
  readingLevelScore   Int?           @map("reading_level_score")
  listeningLevelScore Int?           @map("listening_level_score")
  writingLevelScore   Int?           @map("writing_level_score")
  dailyTimeBudgetMin  Int            @default(30) @map("daily_time_budget_min")
  dailyReviewCap      Int            @default(20) @map("daily_review_cap")
  createdAt           DateTime       @default(now()) @map("created_at")
  updatedAt           DateTime       @updatedAt @map("updated_at")
  user                User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("learner_profiles")
}

model SessionEvent {
  id               String          @id @default(uuid())
  readingSessionId String?         @map("reading_session_id")
  eventType        EventType
  payloadJson      Json            @map("payload_json")
  createdAt        DateTime        @default(now()) @map("created_at")
  session          ReadingSession? @relation(fields: [readingSessionId], references: [id], onDelete: Cascade)

  @@index([readingSessionId])
  @@index([eventType])
  @@map("session_events")
}

model SessionOutcome {
  readingSessionId   String         @id @map("reading_session_id")
  comprehensionScore Int            @default(0) @map("comprehension_score")
  productionScore    Int            @default(0) @map("production_score")
  frustrationIndex   Int            @default(0) @map("frustration_index")
  computedAt         DateTime       @default(now()) @map("computed_at")
  session            ReadingSession @relation(fields: [readingSessionId], references: [id], onDelete: Cascade)

  @@map("session_outcomes")
}

model ExtensionDeviceAuth {
  id              String   @id @default(cuid())
  deviceCode      String   @unique @map("device_code")
  userCode        String   @unique @map("user_code")
  status          String   @default("PENDING")
  clientId        String   @default("browser-extension") @map("client_id")
  requestedScopes Json     @default("[]") @map("requested_scopes")
  userId          String?  @map("user_id")
  expiresAt       DateTime @map("expires_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  user            User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([deviceCode])
  @@index([userCode])
  @@index([status, expiresAt])
  @@map("extension_device_auth")
}

model ExtensionGrant {
  id             String    @id @default(cuid())
  userId         String    @map("user_id")
  clientId       String    @default("browser-extension") @map("client_id")
  scopes         Json      @default("[]")
  accessTokenJti String?   @map("access_token_jti")
  refreshToken   String?   @unique @map("refresh_token")
  revokedAt      DateTime? @map("revoked_at")
  lastUsedAt     DateTime? @map("last_used_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([accessTokenJti])
  @@index([refreshToken])
  @@map("extension_grants")
}

model VocabAttempt {
  id        String          @id @default(uuid())
  vocabId   String          @map("vocab_id")
  sessionId String?         @map("session_id")
  dimension VocabDimension
  result    AttemptResult
  createdAt DateTime        @default(now()) @map("created_at")
  session   ReadingSession? @relation(fields: [sessionId], references: [id])
  vocab     UserVocabulary  @relation(fields: [vocabId], references: [id], onDelete: Cascade)

  @@index([vocabId])
  @@index([createdAt])
  @@map("vocab_attempts")
}

model LearningAsset {
  id                 String          @id @default(uuid())
  contentId          String          @map("content_id")
  layer              AssetLayer
  modality           SessionModality
  bodyRef            String?         @map("body_ref")
  glossaryJson       Json?           @map("glossary_json")
  cuesJson           Json?           @map("cues_json")
  checkpointsJson    Json?           @map("checkpoints_json")
  quizPostJson       Json?           @map("quiz_post_json")
  difficultyEstimate Int?            @map("difficulty_estimate")
  lengthEstimate     Int?            @map("length_estimate")
  promptVersion      String          @map("prompt_version")
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")
  content            Content         @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@unique([contentId, layer, modality, promptVersion])
  @@index([contentId, layer])
  @@index([promptVersion])
  @@map("learning_assets")
}

model LayerEligibility {
  userId     String   @id @map("user_id")
  eligibleL2 Boolean  @default(false) @map("eligible_l2")
  eligibleL3 Boolean  @default(false) @map("eligible_l3")
  reasonJson Json?    @map("reason_json")
  updatedAt  DateTime @updatedAt @map("updated_at")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("layer_eligibility")
}

model StudyGroup {
  id            String             @id @default(uuid())
  ownerUserId   String             @map("owner_user_id")
  scopeType     ScopeType?         @map("scope_type")
  scopeId       String?            @map("scope_id")
  name          String
  createdAt     DateTime           @default(now()) @map("created_at")
  annotations   Annotation[]
  contents      GroupContent[]
  sessions      GroupSession[]
  providerUsage ProviderUsage[]
  members       StudyGroupMember[]
  owner         User               @relation("GroupOwner", fields: [ownerUserId], references: [id])

  @@index([ownerUserId])
  @@index([scopeType, scopeId])
  @@map("study_groups")
}

model StudyGroupMember {
  groupId  String            @map("group_id")
  userId   String            @map("user_id")
  role     GroupRole
  status   GroupMemberStatus @default(ACTIVE)
  joinedAt DateTime          @default(now()) @map("joined_at")
  group    StudyGroup        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user     User              @relation(fields: [userId], references: [id])

  @@id([groupId, userId])
  @@index([userId])
  @@map("study_group_members")
}

model GroupContent {
  groupId       String     @map("group_id")
  contentId     String     @map("content_id")
  addedByUserId String     @map("added_by_user_id")
  createdAt     DateTime   @default(now()) @map("created_at")
  content       Content    @relation(fields: [contentId], references: [id], onDelete: Cascade)
  group         StudyGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@id([groupId, contentId])
  @@index([contentId])
  @@map("group_contents")
}

model GroupSession {
  id           String               @id @default(uuid())
  groupId      String               @map("group_id")
  contentId    String               @map("content_id")
  mode         GroupSessionMode     @default(PI_SPRINT)
  layer        String               @default("L1")
  status       GroupSessionStatus   @default(CREATED)
  startsAt     DateTime?            @map("starts_at")
  endsAt       DateTime?            @map("ends_at")
  createdAt    DateTime             @default(now()) @map("created_at")
  chatMessages GroupChatMessage[]
  events       GroupEvent[]
  rounds       GroupRound[]
  members      GroupSessionMember[]
  content      Content              @relation(fields: [contentId], references: [id])
  group        StudyGroup           @relation(fields: [groupId], references: [id], onDelete: Cascade)
  SharedCard   SharedCard[]

  @@index([groupId])
  @@index([status])
  @@map("group_sessions")
}

model GroupSessionMember {
  sessionId        String       @map("session_id")
  userId           String       @map("user_id")
  assignedRole     SessionRole  @map("assigned_role")
  attendanceStatus String       @default("JOINED") @map("attendance_status")
  session          GroupSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user             User         @relation(fields: [userId], references: [id])

  @@id([sessionId, userId])
  @@map("group_session_members")
}

model GroupRound {
  id           String             @id @default(uuid())
  sessionId    String             @map("session_id")
  roundIndex   Int                @map("round_index")
  roundType    String             @default("PI") @map("round_type")
  promptJson   Json               @map("prompt_json")
  timingJson   Json               @map("timing_json")
  status       RoundStatus        @default(CREATED)
  createdAt    DateTime           @default(now()) @map("created_at")
  chatMessages GroupChatMessage[]
  events       GroupEvent[]
  session      GroupSession       @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sharedCard   SharedCard?

  @@unique([sessionId, roundIndex])
  @@index([sessionId])
  @@map("group_rounds")
}

model GroupEvent {
  id          String       @id @default(uuid())
  sessionId   String       @map("session_id")
  roundId     String?      @map("round_id")
  userId      String?      @map("user_id")
  eventType   String       @map("event_type")
  payloadJson Json         @map("payload_json")
  createdAt   DateTime     @default(now()) @map("created_at")
  round       GroupRound?  @relation(fields: [roundId], references: [id])
  session     GroupSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([roundId])
  @@index([eventType])
  @@map("group_events")
}

model SharedCard {
  id              String       @id @default(uuid())
  sessionId       String       @map("session_id")
  roundId         String       @unique @map("round_id")
  createdByUserId String       @map("created_by_user_id")
  cardJson        Json         @map("card_json")
  createdAt       DateTime     @default(now()) @map("created_at")
  round           GroupRound   @relation(fields: [roundId], references: [id], onDelete: Cascade)
  session         GroupSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("shared_cards")
}

model GroupChatMessage {
  id        String       @id @default(cuid())
  sessionId String       @map("session_id")
  roundId   String       @map("round_id")
  userId    String       @map("user_id")
  message   String
  createdAt DateTime     @default(now()) @map("created_at")
  round     GroupRound   @relation(fields: [roundId], references: [id], onDelete: Cascade)
  session   GroupSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id])

  @@index([sessionId, roundId])
  @@index([createdAt])
  @@map("group_chat_messages")
}

model QuestionBank {
  id                 String                @id @default(cuid())
  language           String
  universalConceptId String?               @map("universal_concept_id")
  hasTranslations    Boolean               @default(false) @map("has_translations")
  gameType           String                @map("game_type")
  subject            String
  topic              String
  difficulty         Int
  educationLevel     String                @map("education_level")
  question           Json
  answer             Json
  metadata           Json?
  sourceType         String                @map("source_type")
  sourceContentId    String?               @map("source_content_id")
  timesUsed          Int                   @default(0) @map("times_used")
  avgScore           Float?                @map("avg_score")
  createdAt          DateTime              @default(now()) @map("created_at")
  updatedAt          DateTime              @updatedAt @map("updated_at")
  analytics          QuestionAnalytics?
  results            QuestionResult[]
  translations       QuestionTranslation[]

  @@index([language, gameType, subject, topic])
  @@index([universalConceptId])
  @@index([educationLevel, difficulty])
  @@map("question_bank")
}

model QuestionTranslation {
  id               String       @id @default(cuid())
  sourceQuestionId String       @map("source_question_id")
  targetLanguage   String       @map("target_language")
  question         Json
  answer           Json
  subject          String
  topic            String
  isAITranslated   Boolean      @default(true) @map("is_ai_translated")
  isReviewed       Boolean      @default(false) @map("is_reviewed")
  reviewedBy       String?      @map("reviewed_by")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")
  sourceQuestion   QuestionBank @relation(fields: [sourceQuestionId], references: [id], onDelete: Cascade)

  @@unique([sourceQuestionId, targetLanguage])
  @@index([targetLanguage])
  @@map("question_translations")
}

model QuestionResult {
  id            String       @id @default(cuid())
  userId        String       @map("user_id")
  questionId    String       @map("question_id")
  gameSessionId String?      @map("game_session_id")
  score         Int
  timeTaken     Int          @map("time_taken")
  isCorrect     Boolean      @map("is_correct")
  selfRating    Int?         @map("self_rating")
  userAnswer    Json?        @map("user_answer")
  mistakes      Json?
  createdAt     DateTime     @default(now()) @map("created_at")
  question      QuestionBank @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([questionId])
  @@map("question_results")
}

model QuestionAnalytics {
  id             String       @id @default(cuid())
  questionId     String       @unique @map("question_id")
  totalAttempts  Int          @default(0) @map("total_attempts")
  successRate    Float        @map("success_rate")
  avgScore       Float        @map("avg_score")
  avgTime        Int          @map("avg_time")
  avgSelfRating  Float?       @map("avg_self_rating")
  commonMistakes Json         @map("common_mistakes")
  isDifficult    Boolean      @default(false) @map("is_difficult")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  question       QuestionBank @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("question_analytics")
}

model ConceptDifficulty {
  id             String   @id @default(cuid())
  topic          String
  subject        String
  totalAttempts  Int      @default(0) @map("total_attempts")
  avgScore       Float    @map("avg_score")
  successRate    Float    @map("success_rate")
  commonMistakes String[] @map("common_mistakes")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@unique([topic, subject])
  @@map("concept_difficulty")
}

model Annotation {
  id           String               @id @default(uuid())
  contentId    String               @map("content_id")
  userId       String               @map("user_id")
  type         AnnotationType
  startOffset  Int                  @map("start_offset")
  endOffset    Int                  @map("end_offset")
  selectedText String?              @map("selected_text")
  text         String?
  color        String?
  visibility   AnnotationVisibility
  groupId      String?              @map("group_id")
  parentId     String?              @map("parent_id")
  isFavorite   Boolean              @default(false) @map("is_favorite")
  createdAt    DateTime             @default(now()) @map("created_at")
  updatedAt    DateTime             @updatedAt @map("updated_at")
  content      Content              @relation(fields: [contentId], references: [id], onDelete: Cascade)
  group        StudyGroup?          @relation(fields: [groupId], references: [id], onDelete: Cascade)
  parent       Annotation?          @relation("AnnotationReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies      Annotation[]         @relation("AnnotationReplies")
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([contentId])
  @@index([userId])
  @@index([groupId])
  @@map("annotations")
}

model Family {
  id                String             @id @default(uuid())
  name              String
  joinCode          String?            @unique @map("join_code")
  ownerId           String             @map("owner_id")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  coReadingSessions CoReadingSession[]
  contents          Content[]
  owner             User               @relation("FamilyOwner", fields: [ownerId], references: [id])
  members           FamilyMember[]
  policies          FamilyPolicy[]
  providerUsage     ProviderUsage[]
  subscriptions     Subscription[]

  @@map("families")
}

model FamilyMember {
  id          String             @id @default(uuid())
  familyId    String             @map("family_id")
  userId      String             @map("user_id")
  role        FamilyRole
  status      FamilyMemberStatus @default(INVITED)
  displayName String?            @map("display_name")
  joinedAt    DateTime           @default(now()) @map("joined_at")
  family      Family             @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user        User               @relation(fields: [userId], references: [id])

  @@unique([familyId, userId])
  @@map("family_members")
}

model FamilyPolicy {
  id                   String      @id @default(uuid())
  familyId             String      @map("family_id")
  learnerUserId        String      @map("learner_user_id")
  timeboxDefaultMin    Int         @default(15) @map("timebox_default_min")
  dailyMinMinutes      Int         @default(15) @map("daily_min_minutes")
  dailyReviewCap       Int         @default(20) @map("daily_review_cap")
  coReadingDays        Int[]       @map("co_reading_days")
  coReadingTime        String?     @map("co_reading_time")
  toolWordsGateEnabled Boolean     @default(true) @map("tool_words_gate_enabled")
  privacyMode          PrivacyMode @default(AGGREGATED_ONLY) @map("privacy_mode")
  createdAt            DateTime    @default(now()) @map("created_at")
  updatedAt            DateTime    @updatedAt @map("updated_at")
  family               Family      @relation(fields: [familyId], references: [id], onDelete: Cascade)
  learner              User        @relation("FamilyPolicies", fields: [learnerUserId], references: [id], onDelete: Cascade)

  @@unique([familyId, learnerUserId])
  @@map("family_policies")
}

model CoReadingSession {
  id               String          @id @default(uuid())
  familyId         String          @map("family_id")
  educatorUserId   String          @map("educator_user_id")
  learnerUserId    String          @map("learner_user_id")
  readingSessionId String          @unique @map("reading_session_id")
  threadIdLearner  String          @map("thread_id_learner")
  threadIdEducator String          @map("thread_id_educator")
  type             CoSessionType   @default(CO_READING)
  timeboxMin       Int             @map("timebox_min")
  status           CoReadingStatus @default(ACTIVE)
  startedAt        DateTime        @default(now()) @map("started_at")
  endedAt          DateTime?       @map("ended_at")
  educator         User            @relation("EducatorSessions", fields: [educatorUserId], references: [id])
  family           Family          @relation(fields: [familyId], references: [id], onDelete: Cascade)
  learner          User            @relation("LearnerSessions", fields: [learnerUserId], references: [id])
  readingSession   ReadingSession  @relation(fields: [readingSessionId], references: [id], onDelete: Cascade)

  @@map("co_reading_sessions")
}

model Classroom {
  id                  String          @id @default(uuid())
  institutionId       String?         @map("institution_id")
  ownerEducatorUserId String          @map("owner_educator_id")
  name                String
  gradeLevel          String?         @map("grade_level")
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")
  weeklyPlans         ClassPlanWeek[]
  policies            ClassPolicy?
  owner               User            @relation("ClassroomOwner", fields: [ownerEducatorUserId], references: [id])
  enrollments         Enrollment[]

  @@map("classrooms")
}

model Enrollment {
  id            String           @id @default(uuid())
  classroomId   String           @map("classroom_id")
  learnerUserId String           @map("learner_user_id")
  status        EnrollmentStatus @default(ACTIVE)
  nickname      String?
  enrolledAt    DateTime         @default(now()) @map("enrolled_at")
  classroom     Classroom        @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  learner       User             @relation("StudentEnrollments", fields: [learnerUserId], references: [id])

  @@unique([classroomId, learnerUserId])
  @@map("enrollments")
}

model ClassPolicy {
  id                   String           @id @default(uuid())
  classroomId          String           @unique @map("classroom_id")
  timeboxDefaultMin    Int              @default(15) @map("timebox_default_min")
  weeklyUnitsTarget    Int              @default(3) @map("weekly_units_target")
  toolWordsGateEnabled Boolean          @default(true) @map("tool_words_gate_enabled")
  dailyReviewCap       Int              @default(10) @map("daily_review_cap")
  privacyMode          ClassPrivacyMode @default(AGGREGATED_ONLY) @map("privacy_mode")
  interventionMode     InterventionMode @default(PROMPT_COACH) @map("intervention_mode")
  createdAt            DateTime         @default(now()) @map("created_at")
  updatedAt            DateTime         @updatedAt @map("updated_at")
  classroom            Classroom        @relation(fields: [classroomId], references: [id], onDelete: Cascade)

  @@map("class_policies")
}

model ClassPlanWeek {
  id                      String    @id @default(uuid())
  classroomId             String    @map("classroom_id")
  weekStart               DateTime  @map("week_start")
  createdByEducatorUserId String    @map("created_by_educator_id")
  title                   String?
  notes                   String?
  itemsJson               Json      @map("items_json")
  toolWordsJson           Json?     @map("tool_words_json")
  checkpointsJson         Json?     @map("checkpoints_json")
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")
  classroom               Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  creator                 User      @relation("ClassPlansCreated", fields: [createdByEducatorUserId], references: [id])

  @@unique([classroomId, weekStart])
  @@map("class_plan_weeks")
}

model ContentPedagogicalData {
  id                String   @id @default(uuid())
  contentId         String   @unique @map("content_id")
  vocabularyTriage  Json?    @map("vocabulary_triage")
  socraticQuestions Json?    @map("socratic_questions")
  quizQuestions     Json?    @map("quiz_questions")
  tabooCards        Json?    @map("taboo_cards")
  bossFightConfig   Json?    @map("boss_fight_config")
  freeRecallPrompts Json?    @map("free_recall_prompts")
  processingVersion String   @default("v1.0") @map("processing_version")
  processedAt       DateTime @default(now()) @map("processed_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  content           Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([contentId])
  @@map("content_pedagogical_data")
}

model GameResult {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  contentId String   @map("content_id")
  gameType  String
  score     Float
  metadata  Json?
  playedAt  DateTime @default(now()) @map("played_at")
  content   Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, contentId])
  @@index([gameType])
  @@index([playedAt])
  @@map("game_results")
}

model TeacherVerification {
  id            String                    @id @default(uuid())
  userId        String                    @unique @map("user_id")
  institutionId String                    @map("institution_id")
  status        TeacherVerificationStatus @default(PENDING)
  verifiedBy    String?                   @map("verified_by")
  verifiedAt    DateTime?                 @map("verified_at")
  createdAt     DateTime                  @default(now()) @map("created_at")
  updatedAt     DateTime                  @updatedAt @map("updated_at")

  @@index([institutionId, status])
  @@map("teacher_verifications")
}

model ContentShare {
  contentId   String           @map("content_id")
  contextType ShareContextType @map("context_type")
  contextId   String           @map("context_id")
  permission  SharePermission  @default(VIEW)
  createdBy   String?          @map("created_by")
  createdAt   DateTime         @default(now()) @map("created_at")

  @@id([contentId, contextType, contextId])
  @@index([contextType, contextId])
  @@map("content_shares")
}

model AnnotationShare {
  annotationId String              @map("annotation_id")
  contextType  ShareContextType    @map("context_type")
  contextId    String              @map("context_id")
  mode         AnnotationShareMode @default(VIEW)
  createdBy    String?             @map("created_by")
  createdAt    DateTime            @default(now()) @map("created_at")

  @@id([annotationId, contextType, contextId])
  @@index([contextType, contextId])
  @@map("annotation_shares")
}

model CommentThread {
  id          String            @id @default(uuid())
  contextType ShareContextType  @map("context_type")
  contextId   String            @map("context_id")
  targetType  CommentTargetType @map("target_type")
  targetId    String            @map("target_id")
  createdAt   DateTime          @default(now()) @map("created_at")
  comments    Comment[]

  @@unique([contextType, contextId, targetType, targetId])
  @@index([contextType, contextId])
  @@map("comment_threads")
}

model Comment {
  id           String        @id @default(uuid())
  threadId     String        @map("thread_id")
  authorId     String        @map("author_id")
  body         String
  createdAt    DateTime      @default(now()) @map("created_at")
  deletedAt    DateTime?     @map("deleted_at")
  deletedBy    String?       @map("deleted_by")
  deleteReason String?       @map("delete_reason")
  thread       CommentThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt])
  @@map("comments")
}

model InstitutionPolicy {
  id                      String   @id @default(uuid())
  institutionId           String   @unique @map("institution_id")
  allowAdvancedAI         Boolean  @default(false) @map("allow_advanced_ai")
  allowExternalSharing    Boolean  @default(false) @map("allow_external_sharing")
  allowTextExtraction     Boolean  @default(false) @map("allow_text_extraction")
  studentUnenrollmentMode String   @default("TEACHER_OR_ADMIN_ONLY") @map("student_unenrollment_mode")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  @@map("institution_policies")
}

model GradebookExport {
  id          String   @id @default(uuid())
  classroomId String   @map("classroom_id")
  createdBy   String   @map("created_by")
  range       Json
  format      String   @default("CSV")
  fileRef     String   @map("file_ref")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([classroomId, createdAt])
  @@map("gradebook_exports")
}

enum PlanType {
  FREE
  INDIVIDUAL_PREMIUM
  FAMILY
  INSTITUTION
}

enum BillingPeriod {
  MONTHLY
  ANNUAL
}

enum OrgUserStatus {
  PROVISIONED
  ACTIVE_LICENSED
  SUSPENDED
  DEPROVISIONED
}

enum PaymentProvider {
  STRIPE
  MANUAL_INVOICE
  OTHER
}

enum SessionPhase {
  PRE
  DURING
  POST
  FINISHED
}

enum SessionModality {
  READING
  LISTENING
  WRITING
}

enum EventType {
  MARK_UNKNOWN_WORD
  MARK_KEY_IDEA
  CHECKPOINT_RESPONSE
  QUIZ_RESPONSE
  PRODUCTION_SUBMIT
  CLASS_ALERT_RAISED
  CLASS_POLICY_SET
  CLASS_WEEKLY_PLAN_CREATED
  FAMILY_POLICY_SET
  CO_SESSION_STARTED
  CO_SESSION_PHASE_CHANGED
  EDUCATOR_INTERVENTION_CHOSEN
  FAMILY_ALERT_RAISED
  CO_SESSION_FINISHED
  ANNOTATION_FAVORITE_TOGGLED
  ANNOTATION_REPLY_CREATED
  PROMPT_SENT
  PROMPT_RECEIVED
}

enum EducationLevel {
  FUNDAMENTAL_1
  FUNDAMENTAL_2
  MEDIO
  SUPERIOR
  ADULTO_LEIGO
}

enum UserRole {
  ADMIN
  SUPPORT
  OPS
  INSTITUTION_ADMIN
  TEACHER
  STUDENT
  COMMON_USER
  GUARDIAN
  SCHOOL_ADMIN
}

enum SystemRole {
  ADMIN
  SUPPORT
  OPS
}

enum ContextRole {
  OWNER
  INSTITUTION_EDUCATION_ADMIN
  TEACHER
  STUDENT
  INSTITUTION_ENTERPRISE_ADMIN
  EMPLOYEE
}

enum InstitutionKind {
  EDUCATION
  ENTERPRISE
}

enum InstitutionRole {
  INSTITUTION_EDUCATION_ADMIN
  TEACHER
  STUDENT
  INSTITUTION_ENTERPRISE_ADMIN
  EMPLOYEE
}

enum ContentOwnerType {
  USER
  INSTITUTION
  CLASSROOM
}

enum TeacherVerificationStatus {
  PENDING
  VERIFIED
  REVOKED
}

enum ShareContextType {
  CLASSROOM
  FAMILY
  STUDY_GROUP
}

enum SharePermission {
  VIEW
  COMMENT
  ASSIGN
}

enum AnnotationShareMode {
  VIEW
  COMMENT
}

enum CommentTargetType {
  CONTENT
  ANNOTATION
  SUBMISSION
}

enum ScopeType {
  GLOBAL
  INSTITUTION
  USER
  FAMILY
}

enum Environment {
  DEV
  STAGING
  PROD
}

enum InstitutionType {
  SCHOOL
  UNIVERSITY
  COURSE
  OTHER
}

enum MemberStatus {
  ACTIVE
  SUSPENDED
  LEFT
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SSOProvider {
  SAML
  GOOGLE_WORKSPACE
  MICROSOFT_ENTRA
  OKTA
  CUSTOM_OIDC
}

enum ContentType {
  NEWS
  ARXIV
  SCHOOL_MATERIAL
  PDF
  IMAGE
  DOCX
  ARTICLE
  WEB_CLIP
  VIDEO
  AUDIO
}

enum Language {
  PT_BR
  EN
  KO
}

enum LibraryStatus {
  SAVED
  IN_PROGRESS
  COMPLETED
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
}

enum LessonStatus {
  LOCKED
  AVAILABLE
  IN_PROGRESS
  COMPLETED
}

enum DailyGoalType {
  MINUTES
  LESSONS
}

enum JobStatus {
  RUNNING
  COMPLETED
  FAILED
}

enum ConfigType {
  STRING
  NUMBER
  BOOLEAN
  JSON
  SECRET_REF
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  GRACE_PERIOD
  EXPIRED
  SUSPENDED
}

enum SubscriptionSource {
  INTERNAL
  PAYMENT_PROVIDER
}

enum HighlightKind {
  TEXT
  AREA
}

enum TargetType {
  PDF
  IMAGE
  DOCX
  VIDEO
  AUDIO
}

enum ExtractionStatus {
  PENDING
  RUNNING
  DONE
  FAILED
}

enum SrsStage {
  NEW
  D1
  D3
  D7
  D14
  D30
  D60
  MASTERED
}

enum VocabDimension {
  FORM
  MEANING
  USE
}

enum AttemptResult {
  FAIL
  HARD
  OK
  EASY
}

enum AssetLayer {
  L1
  L2
  L3
}

enum GroupRole {
  OWNER
  MOD
  MEMBER
}

enum GroupMemberStatus {
  ACTIVE
  INVITED
  REMOVED
}

enum GroupSessionMode {
  PI_SPRINT
  JIGSAW_MICRO
  TBL_LITE
}

enum GroupSessionStatus {
  CREATED
  RUNNING
  POST
  FINISHED
}

enum SessionRole {
  FACILITATOR
  TIMEKEEPER
  CLARIFIER
  CONNECTOR
  SCRIBE
}

enum RoundStatus {
  CREATED
  VOTING
  DISCUSSING
  REVOTING
  EXPLAINING
  DONE
}

enum AnnotationType {
  HIGHLIGHT
  NOTE
  COMMENT
}

enum AnnotationVisibility {
  PRIVATE
  GROUP
  PUBLIC
}

enum FamilyRole {
  OWNER
  GUARDIAN
  CHILD
  EDUCATOR
  LEARNER
}

enum FamilyMemberStatus {
  INVITED
  ACTIVE
  REMOVED
}

enum VisibilityScope {
  CLASS_PROJECT
  ONLY_EDUCATORS
  RESPONSIBLES_OF_LEARNER
  GROUP_MEMBERS
}

enum ContextType {
  INSTITUTION
  GROUP_STUDY
  FAMILY
}

enum AnnotationStatus {
  ACTIVE
  DELETED
}

enum PrivacyMode {
  AGGREGATED_ONLY
  AGGREGATED_PLUS_TRIGGERS
}

enum ClassPrivacyMode {
  AGGREGATED_ONLY
  AGGREGATED_PLUS_HELP_REQUESTS
  AGGREGATED_PLUS_FLAGS
}

enum CoReadingStatus {
  ACTIVE
  COMPLETED
  ABANDONED
}

enum EnrollmentStatus {
  ACTIVE
  PENDING
  REMOVED
}

enum InterventionMode {
  PROMPT_COACH
  PROMPT_COACH_PLUS_1ON1
}

enum CoSessionType {
  CO_READING
  TEACH_BACK
}
