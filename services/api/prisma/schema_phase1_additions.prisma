// ===== PHASE 1 EXPAND: NEW TABLES =====

// Feature Flags System
model FeatureFlag {
  id        String    @id @default(uuid())
  key       String    @unique
  enabled   Boolean   @default(false)
  scopeType ScopeType @default(GLOBAL) @map("scope_type")
  scopeId   String?   @map("scope_id")
  metadata  Json?
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@index([key, scopeType, scopeId])
  @@map("feature_flags")
}

// Teacher Verification System
enum TeacherVerificationStatus {
  PENDING
  VERIFIED
  REVOKED
}

model TeacherVerification {
  id            String                    @id @default(uuid())
  userId        String                    @unique @map("user_id")
  institutionId String                    @map("institution_id")
  status        TeacherVerificationStatus @default(PENDING)
  verifiedBy    String?                   @map("verified_by")
  verifiedAt    DateTime?                 @map("verified_at")
  createdAt     DateTime                  @default(now()) @map("created_at")
  updatedAt     DateTime                  @updatedAt @map("updated_at")

  user        User        @relation("TeacherVerifications", fields: [userId], references: [id], onDelete: Cascade)
  institution Institution @relation("InstitutionTeacherVerifications", fields: [institutionId], references: [id], onDelete: Cascade)

  @@index([institutionId, status])
  @@map("teacher_verifications")
}

// Sharing System
enum ShareContextType {
  CLASSROOM
  FAMILY
  STUDY_GROUP
}

enum SharePermission {
  VIEW
  COMMENT
  ASSIGN
}

model ContentShare {
  contentId   String           @map("content_id")
  contextType ShareContextType @map("context_type")
  contextId   String           @map("context_id")
  permission  SharePermission  @default(VIEW)
  createdBy   String?          @map("created_by")
  createdAt   DateTime         @default(now()) @map("created_at")

  content Content @relation("ContentShares", fields: [contentId], references: [id], onDelete: Cascade)

  @@id([contentId, contextType, contextId])
  @@index([contextType, contextId])
  @@map("content_shares")
}

enum AnnotationShareMode {
  VIEW
  COMMENT
}

model AnnotationShare {
  annotationId String              @map("annotation_id")
  contextType  ShareContextType    @map("context_type")
  contextId    String              @map("context_id")
  mode         AnnotationShareMode @default(VIEW)
  createdBy    String?             @map("created_by")
  createdAt    DateTime            @default(now()) @map("created_at")

  annotation Annotation @relation("AnnotationShares", fields: [annotationId], references: [id], onDelete: Cascade)

  @@id([annotationId, contextType, contextId])
  @@index([contextType, contextId])
  @@map("annotation_shares")
}

// Comments System
enum CommentTargetType {
  CONTENT
  ANNOTATION
  SUBMISSION
}

model CommentThread {
  id          String            @id @default(uuid())
  contextType ShareContextType  @map("context_type")
  contextId   String            @map("context_id")
  targetType  CommentTargetType @map("target_type")
  targetId    String            @map("target_id")
  createdAt   DateTime          @default(now()) @map("created_at")

  comments Comment[]

  @@unique([contextType, contextId, targetType, targetId])
  @@index([contextType, contextId])
  @@map("comment_threads")
}

model Comment {
  id           String    @id @default(uuid())
  threadId     String    @map("thread_id")
  authorId     String    @map("author_id")
  body         String
  createdAt    DateTime  @default(now()) @map("created_at")
  deletedAt    DateTime? @map("deleted_at")
  deletedBy    String?   @map("deleted_by")
  deleteReason String?   @map("delete_reason")

  thread CommentThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  author User          @relation("UserComments", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt])
  @@map("comments")
}

// Institution Policy
model InstitutionPolicy {
  id            String  @id @default(uuid())
  institutionId String  @unique @map("institution_id")

  allowAdvancedAI      Boolean @default(false) @map("allow_advanced_ai")
  allowExternalSharing Boolean @default(false) @map("allow_external_sharing")
  allowTextExtraction  Boolean @default(false) @map("allow_text_extraction")

  studentUnenrollmentMode String @default("TEACHER_OR_ADMIN_ONLY") @map("student_unenrollment_mode")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  institution Institution @relation("InstitutionPolicy", fields: [institutionId], references: [id], onDelete: Cascade)

  @@map("institution_policies")
}

// Content Ownership (PHASE 1 EXPAND - additive fields)
enum ContentOwnerType {
  USER
  INSTITUTION
  CLASSROOM
}

// Audit Log Enhancement
enum AuditActionType {
  CONTEXT_SWITCHED
  ROLE_ASSIGNED
  MEMBER_STATUS_CHANGED
  TEACHER_VERIFICATION_CHANGED
  CLASSROOM_CREATED
  CLASSROOM_ARCHIVED
  ENROLLMENT_INVITED
  ENROLLMENT_ACCEPTED
  ENROLLMENT_REMOVED
  STUDENT_UNENROLL_REQUESTED
  CONTENT_CREATED
  CONTENT_SHARED
  CONTENT_UNSHARED
  ANNOTATION_CREATED
  ANNOTATION_SHARED
  ANNOTATION_UNSHARED
  COMMENT_ADDED
  COMMENT_DELETED
  STUDYITEM_CREATED
  SUBMISSION_TURNED_IN
  SUBMISSION_RETURNED
  SUBMISSION_MARKED_MISSING
  SUBMISSION_EXCUSED
  SCORE_CHANGED
  GRADEBOOK_EXPORT_CREATED
}

model AuditLog {
  id            String          @id @default(uuid())
  actorId       String          @map("actor_id")
  institutionId String?         @map("institution_id")
  actionType    AuditActionType @map("action_type")
  targetType    String          @map("target_type")
  targetId      String          @map("target_id")
  metadata      Json            @default("{}")
  createdAt     DateTime        @default(now()) @map("created_at")

  actor User @relation("AuditLogActor", fields: [actorId], references: [id], onDelete: Cascade)

  @@index([institutionId, createdAt])
  @@index([actorId, createdAt])
  @@map("audit_logs")
}

// Gradebook Export
model GradebookExport {
  id          String   @id @default(uuid())
  classroomId String   @map("classroom_id")
  createdBy   String   @map("created_by")
  range       Json
  format      String   @default("CSV")
  fileRef     String   @map("file_ref")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([classroomId, createdAt])
  @@map("gradebook_exports")
}
