[Nest] 30040  - 22/12/2025, 13:09:29   ERROR [ExceptionsHandler] PrismaClientValidationError: 
Invalid `this.prisma.sessionEvent.create()` invocation in
C:\projects\aprendeai-app\services\api\src\events\classroom-event.service.ts:32:37

  29 
  30 const validatedPayload = schema.parse(eventPayload);
  31 
→ 32 return this.prisma.sessionEvent.create({
       data: {
         readingSessionId: "policy_638b6b5d-3564-419a-91b0-164fb32767b6",
         eventType: "CLASS_POLICY_SET",
                    ~~~~~~~~~~~~~~~~~~
         payloadJson: {
           domain: "CLASS",
           type: "CLASS_POLICY_SET",
           data: {
             classroomId: "638b6b5d-3564-419a-91b0-164fb32767b6",
             policy: {
               weeklyUnitsTarget: 3,
               timeboxDefaultMin: 20,
               toolWordsGateEnabled: true,
               dailyReviewCap: 30,
               privacyMode: "AGGREGATED_PLUS_HELP_REQUESTS",
               interventionMode: "PROMPT_COACH_PLUS_1ON1"
             }
           }
         }
       }
     })

Invalid value for argument `eventType`. Expected EventType.
    at wn (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:29:1363)
    at $n.handleRequestError (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:6958)
    at $n.handleAndLogRequestError (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:6623)
    at $n.request (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:6307)
    at l (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:130:9633)
    at ClassPolicyService.upsert (C:\projects\aprendeai-app\services\api\src\classroom\services\class-policy.service.ts:40:5) {
  clientVersion: '5.22.0'
}
[Nest] 30040  - 22/12/2025, 13:09:29   ERROR [ExceptionsHandler] PrismaClientValidationError: 
Invalid `this.prisma.classPlanWeek.create()` invocation in
C:\projects\aprendeai-app\services\api\src\classroom\services\class-plan.service.ts:24:50

  21   items: string[], // Array of content IDs
  22   toolWords?: string[],
  23 ) {
→ 24   const plan = await this.prisma.classPlanWeek.create({
         data: {
           classroom: {
             connect: {
               id: "638b6b5d-3564-419a-91b0-164fb32767b6"
             }
           },
           creator: {
             connect: {
               id: undefined,
       ?       email?: String,
       ?       oauthProvider_oauthId?: UserOauthProviderOauthIdCompoundUniqueInput,
       ?       AND?: UserWhereInput | UserWhereInput[],
       ?       OR?: UserWhereInput[],
       ?       NOT?: UserWhereInput | UserWhereInput[],
       ?       institutionId?: StringNullableFilter | String | Null,
       ?       name?: StringFilter | String,
       ?       passwordHash?: StringNullableFilter | String | Null,
       ?       oauthProvider?: StringNullableFilter | String | Null,
       ?       oauthId?: StringNullableFilter | String | Null,
       ?       oauthPicture?: StringNullableFilter | String | Null,
       ?       role?: EnumUserRoleFilter | UserRole,
       ?       schoolingLevel?: StringFilter | String,
       ?       age?: IntNullableFilter | Int | Null,
       ?       sex?: StringNullableFilter | String | Null,
       ?       preferredLanguages?: JsonFilter,
       ?       createdAt?: DateTimeFilter | DateTime,
       ?       updatedAt?: DateTimeFilter | DateTime,
       ?       lastLoginAt?: DateTimeNullableFilter | DateTime | Null,
       ?       status?: StringFilter | String,
       ?       avatarUrl?: StringNullableFilter | String | Null,
       ?       bio?: StringNullableFilter | String | Null,
       ?       settings?: JsonNullableFilter,
       ?       assessmentAttempts?: AssessmentAttemptListRelationFilter,
       ?       enrollments?: ClassStudentListRelationFilter,
       ?       createdContents?: ContentListRelationFilter,
       ?       ownedContents?: ContentListRelationFilter,
       ?       cornellNotesEntries?: CornellNotesListRelationFilter,
       ?       dailyActivities?: DailyActivityListRelationFilter,
       ?       dailyGoals?: DailyGoalListRelationFilter,
       ?       usageEvents?: UsageEventListRelationFilter,
       ?       ownedFamilies?: FamilyListRelationFilter,
       ?       memberships?: FamilyMemberListRelationFilter,
       ?       highlights?: HighlightListRelationFilter,
       ?       cornellNotes?: CornellNoteListRelationFilter,
       ?       readingSessions?: ReadingSessionListRelationFilter,
       ?       streak?: StreakNullableRelationFilter | StreakWhereInput | Null,
       ?       assignedBadges?: UserBadgeListRelationFilter,
       ?       libraryItems?: UserLibraryItemListRelationFilter,
       ?       roleAssignments?: UserRoleAssignmentListRelationFilter,
       ?       vocabularyEntries?: UserVocabularyListRelationFilter,
       ?       layerEligibility?: LayerEligibilityNullableRelationFilter | LayerEligibilityWhereInput | Null,
       ?       institution?: InstitutionNullableRelationFilter | InstitutionWhereInput | Null,
       ?       LearnerProfile?: LearnerProfileListRelationFilter,
       ?       ownedGroups?: StudyGroupListRelationFilter,
       ?       groupMemberships?: StudyGroupMemberListRelationFilter,
       ?       groupSessionMembers?: GroupSessionMemberListRelationFilter,
       ?       chatMessages?: GroupChatMessageListRelationFilter,
       ?       annotations?: AnnotationListRelationFilter,
       ?       familyPolicies?: FamilyPolicyListRelationFilter,
       ?       educatorSessions?: CoReadingSessionListRelationFilter,
       ?       learnerSessions?: CoReadingSessionListRelationFilter,
       ?       ownedClassrooms?: ClassroomListRelationFilter,
       ?       studentEnrollments?: EnrollmentListRelationFilter,
       ?       createdClassPlans?: ClassPlanWeekListRelationFilter,
       ?       extensionDeviceAuths?: ExtensionDeviceAuthListRelationFilter,
       ?       extensionGrants?: ExtensionGrantListRelationFilter
             }
           },
           weekStart: new Date("2025-12-21T16:09:29.617Z"),
           itemsJson: [
             "content_1",
             "content_2",
             "content_3"
           ],
           toolWordsJson: [
             "palavra1",
             "palavra2"
           ]
         }
       })

Argument `connect` of type UserWhereUniqueInput needs at least one of `id`, `email` or `oauthProvider_oauthId` arguments. Available options are marked with ?.
    at wn (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:29:1363)
    at $n.handleRequestError (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:6958)
    at $n.handleAndLogRequestError (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:6623)
    at $n.request (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:6307)
    at l (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:130:9633)
    at ClassPlanService.createWeeklyPlan (C:\projects\aprendeai-app\services\api\src\classroom\services\class-plan.service.ts:24:18) {
  clientVersion: '5.22.0'
}
[Nest] 30040  - 22/12/2025, 13:09:29   ERROR [ExceptionsHandler] PrismaClientUnknownRequestError: 
Invalid `this.prisma.sessionEvent.create()` invocation in
C:\projects\aprendeai-app\services\api\src\events\classroom-event.service.ts:32:37

  29 
  30 const validatedPayload = schema.parse(eventPayload);
  31 
→ 32 return this.prisma.sessionEvent.create(
Error occurred during query execution:
ConnectorError(ConnectorError { user_facing_error: None, kind: QueryError(PostgresError { code: "22P02", message: "invalid input value for enum \"EventType\": \"CLASS_ALERT_RAISED\"", severity: "ERROR", detail: None, column: None, hint: None }), transient: false })
    at $n.handleRequestError (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:7505)
    at $n.handleAndLogRequestError (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:6623)
    at $n.request (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:6307)
    at l (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:130:9633)
    at ClassInterventionService.logHelpRequest (C:\projects\aprendeai-app\services\api\src\classroom\services\class-intervention.service.ts:23:5) {
  clientVersion: '5.22.0'
}
FAIL test/integration/classroom-mode.integration.spec.ts (7.772 s)
  Classroom Mode Integration Tests (e2e)
    Classroom CRUD Flow
      √ should create a classroom (59 ms)
      √ should get classroom by ID (26 ms)
      √ should update classroom (45 ms)
    Enrollment Flow
      √ should enroll student in classroom (15 ms)
      √ should get enrollments for classroom (11 ms)
    Classroom Policy Flow
      × should create classroom policy (21 ms)
      √ should get policy prompt (15 ms)
    Weekly Planning Flow
      × should create weekly plan (13 ms)
      × should get current week plan (10 ms)
    Dashboard with Privacy Filtering
      × should get teacher dashboard with privacy filtering (15 ms)
    Intervention Flow
      × should log student help request (11 ms)
      √ should get intervention prompt (16 ms)

  ● Classroom Mode Integration Tests (e2e) › Classroom Policy Flow › should create classroom policy

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

      171 |         });
      172 |
    > 173 |       expect(response.status).toBe(201);
          |                               ^
      174 |       expect(response.body.weeklyUnitsTarget).toBe(3);
      175 |       expect(response.body.privacyMode).toBe('AGGREGATED_PLUS_HELP_REQUESTS');
      176 |     });

      at Object.<anonymous> (integration/classroom-mode.integration.spec.ts:173:31)

  ● Classroom Mode Integration Tests (e2e) › Weekly Planning Flow › should create weekly plan

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

      205 |         });
      206 |
    > 207 |       expect(response.status).toBe(201);
          |                               ^
      208 |       expect(response.body).toHaveProperty('itemsJson');
      209 |       expect(response.body.itemsJson).toHaveLength(3);
      210 |     });

      at Object.<anonymous> (integration/classroom-mode.integration.spec.ts:207:31)

  ● Classroom Mode Integration Tests (e2e) › Weekly Planning Flow › should get current week plan

    expect(received).toHaveProperty(path)

    Expected path: "itemsJson"
    Received path: []

    Received value: {}

      216 |
      217 |       expect(response.status).toBe(200);
    > 218 |       expect(response.body).toHaveProperty('itemsJson');
          |                             ^
      219 |     });
      220 |   });
      221 |

      at Object.<anonymous> (integration/classroom-mode.integration.spec.ts:218:29)

  ● Classroom Mode Integration Tests (e2e) › Dashboard with Privacy Filtering › should get teacher dashboard with privacy filtering

    expect(received).toBe(expected) // Object.is equality

    Expected: "AGGREGATED_PLUS_HELP_REQUESTS"
    Received: "AGGREGATED_ONLY"

      229 |       expect(response.body).toHaveProperty('activeStudents');
      230 |       expect(response.body).toHaveProperty('students');
    > 231 |       expect(response.body.privacyMode).toBe('AGGREGATED_PLUS_HELP_REQUESTS');
          |                                         ^
      232 |       
      233 |       // With AGGREGATED_PLUS_HELP_REQUESTS: should have helpRequests but not comprehensionScore
      234 |       const student = response.body.students[0];

      at Object.<anonymous> (integration/classroom-mode.integration.spec.ts:231:41)

  ● Classroom Mode Integration Tests (e2e) › Intervention Flow › should log student help request

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

      251 |         });
      252 |
    > 253 |       expect(response.status).toBe(201);
          |                               ^
      254 |       expect(response.body).toHaveProperty('timestamp');
      255 |       expect(response.body.status).toBe('PENDING');
      256 |     });

      at Object.<anonymous> (integration/classroom-mode.integration.spec.ts:253:31)

Test Suites: 1 failed, 1 total
Tests:       5 failed, 7 passed, 12 total
Snapshots:   0 total
Time:        7.961 s, estimated 8 s
Ran all test suites matching /test\\integration\\classroom-mode.integration.spec.ts/i.
