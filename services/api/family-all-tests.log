
> api@0.0.1 test:integration
> jest --config ./test/jest-integration.config.js --testPathPattern=family.spec

  console.log
    [FamilyService.create] BEFORE UPDATE: { userId: '85ed89a4-5928-47b6-9835-373b2078bce8', currentSettings: {} }

      at ../src/family/family.service.ts:50:15

  console.log
    [FamilyService.create] AFTER UPDATE - Set primaryFamilyId: c7735555-f4c0-4011-800e-1b7cfd5a7f29

      at ../src/family/family.service.ts:62:15

  console.log
    Inviting new user: newuser@family-test.com

      at FamilyService.inviteMember (../src/family/family.service.ts:164:16)

[Nest] 57832  - 21/12/2025, 23:45:47   ERROR [ExceptionsHandler] PrismaClientValidationError: 
Invalid `tx.familyMember.update()` invocation in
C:\projects\aprendeai-app\services\api\src\family\family.service.ts:409:29

  406 });
  407 
  408 // 2. Update Old Owner Role to ADMIN (or MEMBER)
→ 409 await tx.familyMember.update({
        where: {
          familyId_userId: {
            familyId: "c7735555-f4c0-4011-800e-1b7cfd5a7f29",
            userId: "85ed89a4-5928-47b6-9835-373b2078bce8"
          }
        },
        data: {
          role: "ADMIN"
                ~~~~~~~
        }
      })

Invalid value for argument `role`. Expected FamilyRole.
    at wn (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:29:1363)
    at $n.handleRequestError (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:6958)
    at $n.handleAndLogRequestError (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:6623)
    at $n.request (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:6307)
    at l (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:130:9633)
    at C:\projects\aprendeai-app\services\api\src\family\family.service.ts:409:7
    at Proxy._transactionWithCallback (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:130:8000) {
  clientVersion: '5.22.0'
}
[Nest] 57832  - 21/12/2025, 23:45:47   ERROR [ExceptionsHandler] PrismaClientValidationError: 
Invalid `tx.familyMember.update()` invocation in
C:\projects\aprendeai-app\services\api\src\family\family.service.ts:409:29

  406 });
  407 
  408 // 2. Update Old Owner Role to ADMIN (or MEMBER)
→ 409 await tx.familyMember.update({
        where: {
          familyId_userId: {
            familyId: "c7735555-f4c0-4011-800e-1b7cfd5a7f29",
            userId: "85ed89a4-5928-47b6-9835-373b2078bce8"
          }
        },
        data: {
          role: "ADMIN"
                ~~~~~~~
        }
      })

Invalid value for argument `role`. Expected FamilyRole.
    at wn (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:29:1363)
    at $n.handleRequestError (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:6958)
    at $n.handleAndLogRequestError (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:6623)
    at $n.request (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:6307)
    at l (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:130:9633)
    at C:\projects\aprendeai-app\services\api\src\family\family.service.ts:409:7
    at Proxy._transactionWithCallback (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:130:8000) {
  clientVersion: '5.22.0'
}
  console.log
    [FamilyService.create] BEFORE UPDATE: {
      userId: '85ed89a4-5928-47b6-9835-373b2078bce8',
      currentSettings: { primaryFamilyId: 'c7735555-f4c0-4011-800e-1b7cfd5a7f29' }
    }

      at ../src/family/family.service.ts:50:15

  console.log
    [FamilyService.create] AFTER UPDATE - Set primaryFamilyId: 01540242-0375-42bd-ba36-5d58d9fcd9bc

      at ../src/family/family.service.ts:62:15

  console.log
    [FamilyService.create] BEFORE UPDATE: {
      userId: '85ed89a4-5928-47b6-9835-373b2078bce8',
      currentSettings: { primaryFamilyId: '01540242-0375-42bd-ba36-5d58d9fcd9bc' }
    }

      at ../src/family/family.service.ts:50:15

  console.log
    [FamilyService.create] AFTER UPDATE - Set primaryFamilyId: fee76422-f5f7-42e5-ac20-67de9a129f54

      at ../src/family/family.service.ts:62:15

FAIL test/integration/family.spec.ts (6.026 s)
  ● Family Plan (Integration) › POST /families/:id/invite › should add existing user as GUARDIAN

    expect(received).toContain(expected) // indexOf

    Matcher error: received value must not be null nor undefined

    Received has value: undefined

      151 |         .expect(201);
      152 |
    > 153 |       expect(response.body.message).toContain('invited');
          |                                     ^
      154 |
      155 |       // Verify membership created
      156 |       const existingUser = await prisma.user.findUnique({

      at Object.<anonymous> (integration/family.spec.ts:153:37)

  ● Family Plan (Integration) › POST /families/:id/invite › should create placeholder user for new email

    expect(received).toContain(expected) // indexOf

    Matcher error: received value must not be null nor undefined

    Received has value: undefined

      182 |         .expect(201);
      183 |
    > 184 |       expect(response.body.message).toContain('invited');
          |                                     ^
      185 |
      186 |       // Verify placeholder user created
      187 |       const newUser = await prisma.user.findUnique({

      at Object.<anonymous> (integration/family.spec.ts:184:37)

  ● Family Plan (Integration) › POST /families/:id/invite › should reject duplicate invitations

    expected 400 "Bad Request", got 409 "Conflict"

      202 |           role: 'GUARDIAN',
      203 |         })
    > 204 |         .expect(400);
          |          ^
      205 |     });
      206 |
      207 |     it('should only allow owner to invite members', async () => {

      at Object.<anonymous> (integration/family.spec.ts:204:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › POST /families/:id/invite › should only allow owner to invite members

    expected 403 "Forbidden", got 401 "Unauthorized"

      233 |           role: 'CHILD',
      234 |         })
    > 235 |         .expect(403);
          |          ^
      236 |     });
      237 |   });
      238 |

      at Object.<anonymous> (integration/family.spec.ts:235:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › POST /families/:id/transfer-ownership › should transfer ownership to existing member

    expected 200 "OK", got 500 "Internal Server Error"

      254 |           newOwnerId: memberUserId,
      255 |         })
    > 256 |         .expect(200);
          |          ^
      257 |
      258 |       expect(response.body.message).toContain('transferred');
      259 |

      at Object.<anonymous> (integration/family.spec.ts:256:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › POST /families/:id/transfer-ownership › should prevent non-owner from transferring

    expected 403 "Forbidden", got 500 "Internal Server Error"

      289 |           newOwnerId: ownerUserId,
      290 |         })
    > 291 |         .expect(403);
          |          ^
      292 |     });
      293 |
      294 |     afterAll(async () => {

      at Object.<anonymous> (integration/family.spec.ts:291:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › POST /families/:id/primary › should set family as primary for user

    expected 200 "OK", got 201 "Created"

      316 |         .post(apiUrl(ROUTES.FAMILY.SET_PRIMARY(familyId)))
      317 |         .set('Authorization', `Bearer ${authToken}`)
    > 318 |         .expect(200);
          |          ^
      319 |
      320 |       expect(response.body.message).toContain('primary');
      321 |

      at Object.<anonymous> (integration/family.spec.ts:318:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › POST /families/:id/primary › should only allow family members to set as primary

    expected 400 "Bad Request", got 401 "Unauthorized"

      349 |         .post(apiUrl(ROUTES.FAMILY.SET_PRIMARY(familyId)))
      350 |         .set('Authorization', `Bearer ${outsiderLogin.body.accessToken}`)
    > 351 |         .expect(400);
          |          ^
      352 |     });
      353 |   });
      354 |

      at Object.<anonymous> (integration/family.spec.ts:351:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › GET /families/:id/billing-hierarchy › should resolve to primary family

    expected 200 "OK", got 404 "Not Found"

      358 |         .get(apiUrl(ROUTES.FAMILY.BILLING_HIERARCHY(familyId)))
      359 |         .set('Authorization', `Bearer ${authToken}`)
    > 360 |         .expect(200);
          |          ^
      361 |
      362 |       expect(response.body.scopeType).toBe('FAMILY');
      363 |       expect(response.body.scopeId).toBe(familyId);

      at Object.<anonymous> (integration/family.spec.ts:360:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › GET /families/:id/billing-hierarchy › should fall back to user scope if no families

    expected 200 "OK", got 404 "Not Found"

      375 |         .get(apiUrl(ROUTES.FAMILY.BILLING_HIERARCHY('any-id')))
      376 |         .set('Authorization', `Bearer ${outsiderLogin.body.accessToken}`)
    > 377 |         .expect(200);
          |          ^
      378 |
      379 |       expect(response.body.scopeType).toBe('USER');
      380 |     });

      at Object.<anonymous> (integration/family.spec.ts:377:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › DELETE /families/:id › should only allow owner to delete family

    expected 403 "Forbidden", got 401 "Unauthorized"

      426 |         .delete(apiUrl(ROUTES.FAMILY.BY_ID(familyId)))
      427 |         .set('Authorization', `Bearer ${newOwnerLogin.body.accessToken}`)
    > 428 |         .expect(403);
          |          ^
      429 |     });
      430 |
      431 |     it('should return 404 if family does not exist', async () => {

      at Object.<anonymous> (integration/family.spec.ts:428:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › Multi-Family Scenarios › should switch primary family

    expected 200 "OK", got 201 "Created"

      469 |         .post(apiUrl(ROUTES.FAMILY.SET_PRIMARY(secondFamilyId)))
      470 |         .set('Authorization', `Bearer ${authToken}`)
    > 471 |         .expect(200);
          |          ^
      472 |
      473 |       const user = await prisma.user.findUnique({
      474 |         where: { id: ownerUserId },

      at Object.<anonymous> (integration/family.spec.ts:471:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › Multi-Family Scenarios › should resolve billing to new primary family

    expected 200 "OK", got 404 "Not Found"

      482 |         .get(apiUrl(ROUTES.FAMILY.BILLING_HIERARCHY(secondFamilyId)))
      483 |         .set('Authorization', `Bearer ${authToken}`)
    > 484 |         .expect(200);
          |          ^
      485 |
      486 |       expect(response.body.scopeId).toBe(secondFamilyId);
      487 |     });

      at Object.<anonymous> (integration/family.spec.ts:484:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)


  ● Test suite failed to run

    expected 200 "OK", got 401 "Unauthorized"

      307 |           newOwnerId: ownerUserId,
      308 |         })
    > 309 |         .expect(200);
          |          ^
      310 |     });
      311 |   });
      312 |

      at Object.<anonymous> (integration/family.spec.ts:309:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

Test Suites: 1 failed, 1 total
Tests:       13 failed, 9 passed, 22 total
Snapshots:   0 total
Time:        6.238 s, estimated 7 s
Ran all test suites matching /family.spec/i.
