[Nest] 25612  - 22/12/2025, 13:17:01   ERROR [ExceptionsHandler] PrismaClientKnownRequestError: 
Invalid `this.prisma.sessionEvent.create()` invocation in
C:\projects\aprendeai-app\services\api\src\events\classroom-event.service.ts:32:37

  29 
  30 const validatedPayload = schema.parse(eventPayload);
  31 
→ 32 return this.prisma.sessionEvent.create(
Foreign key constraint violated: `session_events_reading_session_id_fkey (index)`
    at $n.handleRequestError (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:7315)
    at $n.handleAndLogRequestError (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:6623)
    at $n.request (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:6307)
    at l (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:130:9633)
    at ClassPolicyService.upsert (C:\projects\aprendeai-app\services\api\src\classroom\services\class-policy.service.ts:40:5) {
  code: 'P2003',
  clientVersion: '5.22.0',
  meta: {
    modelName: 'SessionEvent',
    field_name: 'session_events_reading_session_id_fkey (index)'
  }
}
[Nest] 25612  - 22/12/2025, 13:17:01   ERROR [ExceptionsHandler] PrismaClientKnownRequestError: 
Invalid `this.prisma.sessionEvent.create()` invocation in
C:\projects\aprendeai-app\services\api\src\events\classroom-event.service.ts:32:37

  29 
  30 const validatedPayload = schema.parse(eventPayload);
  31 
→ 32 return this.prisma.sessionEvent.create(
Foreign key constraint violated: `session_events_reading_session_id_fkey (index)`
    at $n.handleRequestError (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:7315)
    at $n.handleAndLogRequestError (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:6623)
    at $n.request (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:6307)
    at l (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:130:9633)
    at ClassPlanService.createWeeklyPlan (C:\projects\aprendeai-app\services\api\src\classroom\services\class-plan.service.ts:35:5) {
  code: 'P2003',
  clientVersion: '5.22.0',
  meta: {
    modelName: 'SessionEvent',
    field_name: 'session_events_reading_session_id_fkey (index)'
  }
}
[Nest] 25612  - 22/12/2025, 13:17:01   ERROR [ExceptionsHandler] PrismaClientKnownRequestError: 
Invalid `this.prisma.sessionEvent.create()` invocation in
C:\projects\aprendeai-app\services\api\src\events\classroom-event.service.ts:32:37

  29 
  30 const validatedPayload = schema.parse(eventPayload);
  31 
→ 32 return this.prisma.sessionEvent.create(
Foreign key constraint violated: `session_events_reading_session_id_fkey (index)`
    at $n.handleRequestError (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:7315)
    at $n.handleAndLogRequestError (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:6623)
    at $n.request (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:6307)
    at l (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:130:9633)
    at ClassInterventionService.logHelpRequest (C:\projects\aprendeai-app\services\api\src\classroom\services\class-intervention.service.ts:23:5) {
  code: 'P2003',
  clientVersion: '5.22.0',
  meta: {
    modelName: 'SessionEvent',
    field_name: 'session_events_reading_session_id_fkey (index)'
  }
}
FAIL test/integration/classroom-mode.integration.spec.ts (5.73 s)
  Classroom Mode Integration Tests (e2e)
    Classroom CRUD Flow
      √ should create a classroom (39 ms)
      √ should get classroom by ID (19 ms)
      √ should update classroom (10 ms)
    Enrollment Flow
      √ should enroll student in classroom (26 ms)
      √ should get enrollments for classroom (11 ms)
    Classroom Policy Flow
      × should create classroom policy (25 ms)
      √ should get policy prompt (8 ms)
    Weekly Planning Flow
      × should create weekly plan (19 ms)
      × should get current week plan (13 ms)
    Dashboard with Privacy Filtering
      × should get teacher dashboard with privacy filtering (17 ms)
    Intervention Flow
      × should log student help request (12 ms)
      √ should get intervention prompt (6 ms)

  ● Classroom Mode Integration Tests (e2e) › Classroom Policy Flow › should create classroom policy

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

      171 |         });
      172 |
    > 173 |       expect(response.status).toBe(201);
          |                               ^
      174 |       expect(response.body.weeklyUnitsTarget).toBe(3);
      175 |       expect(response.body.privacyMode).toBe('AGGREGATED_PLUS_HELP_REQUESTS');
      176 |     });

      at Object.<anonymous> (integration/classroom-mode.integration.spec.ts:173:31)

  ● Classroom Mode Integration Tests (e2e) › Weekly Planning Flow › should create weekly plan

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

      205 |         });
      206 |
    > 207 |       expect(response.status).toBe(201);
          |                               ^
      208 |       expect(response.body).toHaveProperty('itemsJson');
      209 |       expect(response.body.itemsJson).toHaveLength(3);
      210 |     });

      at Object.<anonymous> (integration/classroom-mode.integration.spec.ts:207:31)

  ● Classroom Mode Integration Tests (e2e) › Weekly Planning Flow › should get current week plan

    expect(received).toHaveProperty(path)

    Expected path: "itemsJson"
    Received path: []

    Received value: {}

      216 |
      217 |       expect(response.status).toBe(200);
    > 218 |       expect(response.body).toHaveProperty('itemsJson');
          |                             ^
      219 |     });
      220 |   });
      221 |

      at Object.<anonymous> (integration/classroom-mode.integration.spec.ts:218:29)

  ● Classroom Mode Integration Tests (e2e) › Dashboard with Privacy Filtering › should get teacher dashboard with privacy filtering

    expect(received).toBe(expected) // Object.is equality

    Expected: "AGGREGATED_PLUS_HELP_REQUESTS"
    Received: "AGGREGATED_ONLY"

      229 |       expect(response.body).toHaveProperty('activeStudents');
      230 |       expect(response.body).toHaveProperty('students');
    > 231 |       expect(response.body.privacyMode).toBe('AGGREGATED_PLUS_HELP_REQUESTS');
          |                                         ^
      232 |       
      233 |       // With AGGREGATED_PLUS_HELP_REQUESTS: should have helpRequests but not comprehensionScore
      234 |       const student = response.body.students[0];

      at Object.<anonymous> (integration/classroom-mode.integration.spec.ts:231:41)

  ● Classroom Mode Integration Tests (e2e) › Intervention Flow › should log student help request

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

      251 |         });
      252 |
    > 253 |       expect(response.status).toBe(201);
          |                               ^
      254 |       expect(response.body).toHaveProperty('timestamp');
      255 |       expect(response.body.status).toBe('PENDING');
      256 |     });

      at Object.<anonymous> (integration/classroom-mode.integration.spec.ts:253:31)

Test Suites: 1 failed, 1 total
Tests:       5 failed, 7 passed, 12 total
Snapshots:   0 total
Time:        5.92 s, estimated 6 s
Ran all test suites matching /test\\integration\\classroom-mode.integration.spec.ts/i.
