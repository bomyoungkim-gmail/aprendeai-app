
> api@0.0.1 test
> jest institution-admin.integration.spec.ts

FAIL test/integration/institution-admin.integration.spec.ts (6.194 s)
  Institution Admin Dashboard (Integration)
    Setup: Create Institution Admin
      × should register institution admin user (126 ms)
      × should create institution (8 ms)
    GET /institutions/my-institution
      × should return institution data with stats (2 ms)
      √ should return 401 for unauthenticated requests (6 ms)
      × should return error for non-institution-admin users (72 ms)

  ● Institution Admin Dashboard (Integration) › Setup: Create Institution Admin › should register institution admin user

    expect(received).toHaveProperty(path)

    Expected path: "access_token"
    Received path: []

    Received value: {"age": null, "avatarUrl": null, "bio": null, "createdAt": "2025-12-24T07:52:08.225Z", "email": "admin@inst-admin-test.com", "id": "43c65e28-8ea8-4f9e-b991-a3e48e0f636c", "institutionId": null, "lastLoginAt": null, "name": "Test Admin", "oauthId": null, "oauthPicture": null, "oauthProvider": null, "passwordResetExpires": null, "passwordResetToken": null, "preferredLanguages": [], "role": "COMMON_USER", "schoolingLevel": "ADULT", "settings": {}, "sex": null, "ssoProvider": null, "ssoSubject": null, "status": "ACTIVE", "updatedAt": "2025-12-24T07:52:08.225Z"}

      43 |         .expect(201);
      44 |
    > 45 |       expect(res.body).toHaveProperty('access_token');
         |                        ^
      46 |       authToken = res.body.access_token;
      47 |       institutionAdminId = res.body.user.id;
      48 |     });

      at Object.<anonymous> (test/integration/institution-admin.integration.spec.ts:45:24)

  ● Institution Admin Dashboard (Integration) › Setup: Create Institution Admin › should create institution

    PrismaClientValidationError: 
    Invalid `prisma.institutionMember.create()` invocation in
    C:\projects\aprendeai-app\services\api\test\integration\institution-admin.integration.spec.ts:62:38

      59 institutionId = institution.id;
      60 
      61 // Make user an INSTITUTION_ADMIN
    → 62 await prisma.institutionMember.create({
           data: {
             institutionId: "35be7f93-0dbb-4b6b-8448-45df2101b006",
             userId: undefined,
             role: "INSTITUTION_ADMIN",
             status: "ACTIVE",
         +   institution: {
         +     create: InstitutionCreateWithoutMembersInput | InstitutionUncheckedCreateWithoutMembersInput,
         +     connectOrCreate: InstitutionCreateOrConnectWithoutMembersInput,
         +     connect: InstitutionWhereUniqueInput
         +   }
           }
         })

    Argument `institution` is missing.

      60 |
      61 |       // Make user an INSTITUTION_ADMIN
    > 62 |       await prisma.institutionMember.create({
         |       ^
      63 |         data: {
      64 |           institutionId,
      65 |           userId: institutionAdminId,

      at wn (node_modules/@prisma/client/runtime/library.js:29:1363)
      at $n.handleRequestError (node_modules/@prisma/client/runtime/library.js:121:6958)
      at $n.handleAndLogRequestError (node_modules/@prisma/client/runtime/library.js:121:6623)
      at $n.request (node_modules/@prisma/client/runtime/library.js:121:6307)
      at l (node_modules/@prisma/client/runtime/library.js:130:9633)
      at Object.<anonymous> (test/integration/institution-admin.integration.spec.ts:62:7)

  ● Institution Admin Dashboard (Integration) › GET /institutions/my-institution › should return institution data with stats

    PrismaClientValidationError: 
    Invalid `prisma.institutionInvite.create()` invocation in
    C:\projects\aprendeai-app\services\api\test\integration\institution-admin.integration.spec.ts:84:38

      81 describe('GET /institutions/my-institution', () => {
      82   it('should return institution data with stats', async () => {
      83     // Add some test data
    → 84     await prisma.institutionInvite.create({
               data: {
                 institution: {
                   connect: {
                     id: "35be7f93-0dbb-4b6b-8448-45df2101b006"
                   }
                 },
                 email: "invited@test.com",
                 role: "TEACHER",
                 token: "test-token-123",
                 expiresAt: new Date("2025-12-31T07:52:08.275Z"),
                 inviter: {
                   connect: {
                     id: undefined,
             ?       email?: String,
             ?       ssoSubject?: String,
             ?       oauthProvider_oauthId?: UserOauthProviderOauthIdCompoundUniqueInput,
             ?       AND?: UserWhereInput | UserWhereInput[],
             ?       OR?: UserWhereInput[],
             ?       NOT?: UserWhereInput | UserWhereInput[],
             ?       institutionId?: StringNullableFilter | String | Null,
             ?       name?: StringFilter | String,
             ?       passwordHash?: StringNullableFilter | String | Null,
             ?       passwordResetToken?: StringNullableFilter | String | Null,
             ?       passwordResetExpires?: DateTimeNullableFilter | DateTime | Null,
             ?       oauthProvider?: StringNullableFilter | String | Null,
             ?       oauthId?: StringNullableFilter | String | Null,
             ?       oauthPicture?: StringNullableFilter | String | Null,
             ?       role?: EnumUserRoleFilter | UserRole,
             ?       schoolingLevel?: StringFilter | String,
             ?       age?: IntNullableFilter | Int | Null,
             ?       sex?: StringNullableFilter | String | Null,
             ?       preferredLanguages?: JsonFilter,
             ?       createdAt?: DateTimeFilter | DateTime,
             ?       updatedAt?: DateTimeFilter | DateTime,
             ?       lastLoginAt?: DateTimeNullableFilter | DateTime | Null,
             ?       status?: StringFilter | String,
             ?       avatarUrl?: StringNullableFilter | String | Null,
             ?       bio?: StringNullableFilter | String | Null,
             ?       settings?: JsonNullableFilter,
             ?       ssoProvider?: StringNullableFilter | String | Null,
             ?       assessmentAttempts?: AssessmentAttemptListRelationFilter,
             ?       enrollments?: ClassStudentListRelationFilter,
             ?       createdContents?: ContentListRelationFilter,
             ?       ownedContents?: ContentListRelationFilter,
             ?       cornellNotesEntries?: CornellNotesListRelationFilter,
             ?       dailyActivities?: DailyActivityListRelationFilter,
             ?       dailyGoals?: DailyGoalListRelationFilter,
             ?       usageEvents?: UsageEventListRelationFilter,
             ?       ownedFamilies?: FamilyListRelationFilter,
             ?       memberships?: FamilyMemberListRelationFilter,
             ?       highlights?: HighlightListRelationFilter,
             ?       cornellNotes?: CornellNoteListRelationFilter,
             ?       readingSessions?: ReadingSessionListRelationFilter,
             ?       streak?: StreakNullableRelationFilter | StreakWhereInput | Null,
             ?       assignedBadges?: UserBadgeListRelationFilter,
             ?       libraryItems?: UserLibraryItemListRelationFilter,
             ?       roleAssignments?: UserRoleAssignmentListRelationFilter,
             ?       vocabularyEntries?: UserVocabularyListRelationFilter,
             ?       layerEligibility?: LayerEligibilityNullableRelationFilter | LayerEligibilityWhereInput | Null,
             ?       institution?: InstitutionNullableRelationFilter | InstitutionWhereInput | Null,
             ?       LearnerProfile?: LearnerProfileListRelationFilter,
             ?       ownedGroups?: StudyGroupListRelationFilter,
             ?       groupMemberships?: StudyGroupMemberListRelationFilter,
             ?       groupSessionMembers?: GroupSessionMemberListRelationFilter,
             ?       chatMessages?: GroupChatMessageListRelationFilter,
             ?       annotations?: AnnotationListRelationFilter,
             ?       familyPolicies?: FamilyPolicyListRelationFilter,
             ?       educatorSessions?: CoReadingSessionListRelationFilter,
             ?       learnerSessions?: CoReadingSessionListRelationFilter,
             ?       ownedClassrooms?: ClassroomListRelationFilter,
             ?       studentEnrollments?: EnrollmentListRelationFilter,
             ?       createdClassPlans?: ClassPlanWeekListRelationFilter,
             ?       extensionDeviceAuths?: ExtensionDeviceAuthListRelationFilter,
             ?       extensionGrants?: ExtensionGrantListRelationFilter,
             ?       gameProgress?: GameProgressListRelationFilter,
             ?       institutionMemberships?: InstitutionMemberListRelationFilter,
             ?       invitesCreated?: InstitutionInviteListRelationFilter,
             ?       approvalsReviewed?: PendingUserApprovalListRelationFilter
                   }
                 }
               }
             })

    Argument `connect` of type UserWhereUniqueInput needs at least one of `id`, `email`, `ssoSubject` or `oauthProvider_oauthId` arguments. Available options are marked with ?.

      82 |     it('should return institution data with stats', async () => {
      83 |       // Add some test data
    > 84 |       await prisma.institutionInvite.create({
         |       ^
      85 |         data: {
      86 |           institution: { connect: { id: institutionId } },
      87 |           email: 'invited@test.com',

      at wn (node_modules/@prisma/client/runtime/library.js:29:1363)
      at $n.handleRequestError (node_modules/@prisma/client/runtime/library.js:121:6958)
      at $n.handleAndLogRequestError (node_modules/@prisma/client/runtime/library.js:121:6623)
      at $n.request (node_modules/@prisma/client/runtime/library.js:121:6307)
      at l (node_modules/@prisma/client/runtime/library.js:130:9633)
      at Object.<anonymous> (test/integration/institution-admin.integration.spec.ts:84:7)

  ● Institution Admin Dashboard (Integration) › GET /institutions/my-institution › should return error for non-institution-admin users

    expected 500 "Internal Server Error", got 401 "Unauthorized"

      147 |         .get('/institutions/my-institution')
      148 |         .set('Authorization', `Bearer ${regularUserToken}`)
    > 149 |         .expect(500); // Should return error because user is not an institution admin
          |          ^
      150 |
      151 |       expect(res.body.message).toContain('User is not an institution admin');
      152 |     });

      at Object.<anonymous> (test/integration/institution-admin.integration.spec.ts:149:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

Test Suites: 1 failed, 1 total
Tests:       4 failed, 1 passed, 5 total
Snapshots:   0 total
Time:        6.405 s, estimated 9 s
Ran all test suites matching /institution-admin.integration.spec.ts/i.
