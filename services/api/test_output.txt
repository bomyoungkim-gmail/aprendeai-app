
> api@0.0.1 test
> jest src/graph/__tests__/graph-enhancements.e2e-spec.ts

[Nest] 52292  - 08/01/2026, 10:24:26   ERROR [ExceptionsHandler] TypeError: this.prisma.topic_graphs.count is not a function
    at GraphHealthService.getHealthMetrics (C:\projects\aprendeai-app\services\api\src\graph\health\graph-health.service.ts:139:63)
    at GraphHealthController.getHealth (C:\projects\aprendeai-app\services\api\src\graph\health\graph-health.controller.ts:21:31)
    at C:\projects\aprendeai-app\services\api\node_modules\@nestjs\core\router\router-execution-context.js:38:29
    at InterceptorsConsumer.intercept (C:\projects\aprendeai-app\services\api\node_modules\@nestjs\core\interceptors\interceptors-consumer.js:12:20)
    at C:\projects\aprendeai-app\services\api\node_modules\@nestjs\core\router\router-execution-context.js:46:60
    at C:\projects\aprendeai-app\services\api\node_modules\@nestjs\core\router\router-proxy.js:9:23
    at Layer.handleRequest (C:\projects\aprendeai-app\services\api\node_modules\router\lib\layer.js:152:17)
    at next (C:\projects\aprendeai-app\services\api\node_modules\router\lib\route.js:157:13)
    at Route.dispatch (C:\projects\aprendeai-app\services\api\node_modules\router\lib\route.js:117:3)
    at handle (C:\projects\aprendeai-app\services\api\node_modules\router\index.js:435:11)
    at Layer.handleRequest (C:\projects\aprendeai-app\services\api\node_modules\router\lib\layer.js:152:17)
    at C:\projects\aprendeai-app\services\api\node_modules\router\index.js:295:15
    at processParams (C:\projects\aprendeai-app\services\api\node_modules\router\index.js:582:12)
    at next (C:\projects\aprendeai-app\services\api\node_modules\router\index.js:291:5)
    at read (C:\projects\aprendeai-app\services\api\node_modules\body-parser\lib\read.js:54:5)
    at urlencodedParser (C:\projects\aprendeai-app\services\api\node_modules\body-parser\lib\types\urlencoded.js:58:5)
    at Layer.handleRequest (C:\projects\aprendeai-app\services\api\node_modules\router\lib\layer.js:152:17)
    at trimPrefix (C:\projects\aprendeai-app\services\api\node_modules\router\index.js:342:13)
    at C:\projects\aprendeai-app\services\api\node_modules\router\index.js:297:9
    at processParams (C:\projects\aprendeai-app\services\api\node_modules\router\index.js:582:12)
    at next (C:\projects\aprendeai-app\services\api\node_modules\router\index.js:291:5)
    at read (C:\projects\aprendeai-app\services\api\node_modules\body-parser\lib\read.js:54:5)
    at jsonParser (C:\projects\aprendeai-app\services\api\node_modules\body-parser\lib\types\json.js:90:5)
    at Layer.handleRequest (C:\projects\aprendeai-app\services\api\node_modules\router\lib\layer.js:152:17)
    at trimPrefix (C:\projects\aprendeai-app\services\api\node_modules\router\index.js:342:13)
    at C:\projects\aprendeai-app\services\api\node_modules\router\index.js:297:9
    at processParams (C:\projects\aprendeai-app\services\api\node_modules\router\index.js:582:12)
    at next (C:\projects\aprendeai-app\services\api\node_modules\router\index.js:291:5)
    at C:\projects\aprendeai-app\services\api\node_modules\@nestjs\platform-express\adapters\express-adapter.js:34:17
    at Layer.handleRequest (C:\projects\aprendeai-app\services\api\node_modules\router\lib\layer.js:152:17)
    at trimPrefix (C:\projects\aprendeai-app\services\api\node_modules\router\index.js:342:13)
    at C:\projects\aprendeai-app\services\api\node_modules\router\index.js:297:9
    at processParams (C:\projects\aprendeai-app\services\api\node_modules\router\index.js:582:12)
    at next (C:\projects\aprendeai-app\services\api\node_modules\router\index.js:291:5)
    at Function.handle (C:\projects\aprendeai-app\services\api\node_modules\router\index.js:186:3)
    at Function.handle (C:\projects\aprendeai-app\services\api\node_modules\express\lib\application.js:177:15)
    at Server.app (C:\projects\aprendeai-app\services\api\node_modules\express\lib\express.js:38:9)
    at Server.emit (node:events:519:28)
    at parserOnIncoming (node:_http_server:1184:12)
    at HTTPParser.parserOnHeadersComplete (node:_http_common:122:17)
FAIL src/graph/__tests__/graph-enhancements.e2e-spec.ts (5.126 s)
  Graph Automation (e2e)
    /metrics/graph (GET)
      √ should return 200 and Prometheus formatted metrics (22 ms)
    /health/graph-automation (GET)
      × should return 200 and health status (12 ms)
    /graph/diff/:userId (GET)
      √ should return 200 and diff structure (5 ms)
      √ should support contentId parameter (4 ms)

  ● Graph Automation (e2e) › /health/graph-automation (GET) › should return 200 and health status

    expected 200 "OK", got 500 "Internal Server Error"

      77 |       return request(app.getHttpServer())
      78 |         .get('/health/graph-automation')
    > 79 |         .expect(200)
         |          ^
      80 |         .expect((res) => {
      81 |           expect(res.body).toHaveProperty('status');
      82 |           expect(res.body).toHaveProperty('timestamp');

      at Object.<anonymous> (src/graph/__tests__/graph-enhancements.e2e-spec.ts:79:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

Test Suites: 1 failed, 1 total
Tests:       1 failed, 3 passed, 4 total
Snapshots:   0 total
Time:        5.345 s
Ran all test suites matching /src\\graph\\__tests__\\graph-enhancements.e2e-spec.ts/i.
