FAIL test/integration/review-srs.spec.ts (7.483 s)
  Review & SRS Integration Tests
    GET /review/queue - Queue Retrieval
      × should return empty queue when no due items (21 ms)
      × should return due vocabulary items (15 ms)
      × should NOT return future items (10 ms)
      × should respect daily review cap (43 ms)
    POST /review/attempt - SRS Transitions
      × should transition NEW + OK -> D1 (14 ms)
      × should transition with FAIL -> D1 (reset) (6 ms)
      × should update due date correctly for D30 (2 ms)
      × should record attempt in history (4 ms)
    SRS Edge Cases
      × should keep MASTERED on OK (7 ms)
      × should regress MASTERED on FAIL (2 ms)

  ● Review & SRS Integration Tests › GET /review/queue - Queue Retrieval › should return empty queue when no due items

    expected 200 "OK", got 404 "Not Found"

      90 |         .get(apiUrl('review/queue'))
      91 |         .set('Authorization', authToken)
    > 92 |         .expect(200);
         |          ^
      93 |       
      94 |       expect(response.body).toEqual([]);
      95 |     });

      at Object.<anonymous> (integration/review-srs.spec.ts:92:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Review & SRS Integration Tests › GET /review/queue - Queue Retrieval › should return due vocabulary items

    expected 200 "OK", got 404 "Not Found"

      111 |         .get(apiUrl('review/queue'))
      112 |         .set('Authorization', authToken)
    > 113 |         .expect(200);
          |          ^
      114 |       
      115 |       expect(response.body.length).toBeGreaterThan(0);
      116 |       expect(response.body[0].word).toBe('test');

      at Object.<anonymous> (integration/review-srs.spec.ts:113:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Review & SRS Integration Tests › GET /review/queue - Queue Retrieval › should NOT return future items

    expected 200 "OK", got 404 "Not Found"

      133 |         .get(apiUrl('review/queue'))
      134 |         .set('Authorization', authToken)
    > 135 |         .expect(200);
          |          ^
      136 |       
      137 |       expect(response.body).toEqual([]);
      138 |     });

      at Object.<anonymous> (integration/review-srs.spec.ts:135:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Review & SRS Integration Tests › GET /review/queue - Queue Retrieval › should respect daily review cap

    expected 200 "OK", got 404 "Not Found"

      160 |         .get(apiUrl('review/queue'))
      161 |         .set('Authorization', authToken)
    > 162 |         .expect(200);
          |          ^
      163 |       
      164 |       expect(response.body.length).toBeLessThanOrEqual(20);
      165 |     });

      at Object.<anonymous> (integration/review-srs.spec.ts:162:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Review & SRS Integration Tests › POST /review/attempt - SRS Transitions › should transition NEW + OK -> D1

    expected 200 "OK", got 404 "Not Found"

      192 |           result: 'OK',
      193 |         })
    > 194 |         .expect(200);
          |          ^
      195 |       
      196 |       expect(response.body.srsStage).toBe('D1');
      197 |       expect(response.body.dueAt).toBeDefined();

      at Object.<anonymous> (integration/review-srs.spec.ts:194:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Review & SRS Integration Tests › POST /review/attempt - SRS Transitions › should transition with FAIL -> D1 (reset)

    PrismaClientKnownRequestError: 
    Invalid `prisma.userVocabulary.create()` invocation in
    C:\projects\aprendeai-app\services\api\test\integration\review-srs.spec.ts:173:49

      170 
      171 beforeEach(async () => {
      172   // Create fresh vocab item
    → 173   const vocab = await prisma.userVocabulary.create(
    Unique constraint failed on the fields: (`user_id`,`word`,`language`)

      171 |     beforeEach(async () => {
      172 |       // Create fresh vocab item
    > 173 |       const vocab = await prisma.userVocabulary.create({
          |                     ^
      174 |         data: {
      175 |           userId: testUserId,
      176 |           contentId: testContentId,

      at $n.handleRequestError (../node_modules/@prisma/client/runtime/library.js:121:7315)
      at $n.handleAndLogRequestError (../node_modules/@prisma/client/runtime/library.js:121:6623)
      at $n.request (../node_modules/@prisma/client/runtime/library.js:121:6307)
      at l (../node_modules/@prisma/client/runtime/library.js:130:9633)
      at Object.<anonymous> (integration/review-srs.spec.ts:173:21)

  ● Review & SRS Integration Tests › POST /review/attempt - SRS Transitions › should update due date correctly for D30

    PrismaClientKnownRequestError: 
    Invalid `prisma.userVocabulary.create()` invocation in
    C:\projects\aprendeai-app\services\api\test\integration\review-srs.spec.ts:173:49

      170 
      171 beforeEach(async () => {
      172   // Create fresh vocab item
    → 173   const vocab = await prisma.userVocabulary.create(
    Unique constraint failed on the fields: (`user_id`,`word`,`language`)

      171 |     beforeEach(async () => {
      172 |       // Create fresh vocab item
    > 173 |       const vocab = await prisma.userVocabulary.create({
          |                     ^
      174 |         data: {
      175 |           userId: testUserId,
      176 |           contentId: testContentId,

      at $n.handleRequestError (../node_modules/@prisma/client/runtime/library.js:121:7315)
      at $n.handleAndLogRequestError (../node_modules/@prisma/client/runtime/library.js:121:6623)
      at $n.request (../node_modules/@prisma/client/runtime/library.js:121:6307)
      at l (../node_modules/@prisma/client/runtime/library.js:130:9633)
      at Object.<anonymous> (integration/review-srs.spec.ts:173:21)

  ● Review & SRS Integration Tests › POST /review/attempt - SRS Transitions › should record attempt in history

    PrismaClientKnownRequestError: 
    Invalid `prisma.userVocabulary.create()` invocation in
    C:\projects\aprendeai-app\services\api\test\integration\review-srs.spec.ts:173:49

      170 
      171 beforeEach(async () => {
      172   // Create fresh vocab item
    → 173   const vocab = await prisma.userVocabulary.create(
    Unique constraint failed on the fields: (`user_id`,`word`,`language`)

      171 |     beforeEach(async () => {
      172 |       // Create fresh vocab item
    > 173 |       const vocab = await prisma.userVocabulary.create({
          |                     ^
      174 |         data: {
      175 |           userId: testUserId,
      176 |           contentId: testContentId,

      at $n.handleRequestError (../node_modules/@prisma/client/runtime/library.js:121:7315)
      at $n.handleAndLogRequestError (../node_modules/@prisma/client/runtime/library.js:121:6623)
      at $n.request (../node_modules/@prisma/client/runtime/library.js:121:6307)
      at l (../node_modules/@prisma/client/runtime/library.js:130:9633)
      at Object.<anonymous> (integration/review-srs.spec.ts:173:21)

  ● Review & SRS Integration Tests › SRS Edge Cases › should keep MASTERED on OK

    expected 200 "OK", got 404 "Not Found"

      292 |           result: 'OK',
      293 |         })
    > 294 |         .expect(200);
          |          ^
      295 |       
      296 |       expect(response.body.srsStage).toBe('MASTERED');
      297 |     });

      at Object.<anonymous> (integration/review-srs.spec.ts:294:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Review & SRS Integration Tests › SRS Edge Cases › should regress MASTERED on FAIL

    PrismaClientKnownRequestError: 
    Invalid `prisma.userVocabulary.create()` invocation in
    C:\projects\aprendeai-app\services\api\test\integration\review-srs.spec.ts:273:49

      270 let vocabId: string;
      271 
      272 beforeEach(async () => {
    → 273   const vocab = await prisma.userVocabulary.create(
    Unique constraint failed on the fields: (`user_id`,`word`,`language`)

      271 |     
      272 |     beforeEach(async () => {
    > 273 |       const vocab = await prisma.userVocabulary.create({
          |                     ^
      274 |         data: {
      275 |           userId: testUserId,
      276 |           contentId: testContentId,

      at $n.handleRequestError (../node_modules/@prisma/client/runtime/library.js:121:7315)
      at $n.handleAndLogRequestError (../node_modules/@prisma/client/runtime/library.js:121:6623)
      at $n.request (../node_modules/@prisma/client/runtime/library.js:121:6307)
      at l (../node_modules/@prisma/client/runtime/library.js:130:9633)
      at Object.<anonymous> (integration/review-srs.spec.ts:273:21)

Test Suites: 1 failed, 1 total
Tests:       10 failed, 10 total
Snapshots:   0 total
Time:        7.675 s
Ran all test suites matching /test\\integration\\review-srs.spec.ts/i.
