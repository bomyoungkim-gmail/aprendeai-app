  console.error
    JwtAuthGuard Error: null

    [0m [90m 10 |[39m   handleRequest(err[33m,[39m user[33m,[39m info) {
     [90m 11 |[39m     [36mif[39m (err [33m||[39m [33m![39muser) {
    [31m[1m>[22m[39m[90m 12 |[39m       console[33m.[39merror([32m'JwtAuthGuard Error:'[39m[33m,[39m err)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 13 |[39m       console[33m.[39merror([32m'JwtAuthGuard Info:'[39m[33m,[39m info)[33m;[39m
     [90m 14 |[39m       console[33m.[39merror([32m'JwtAuthGuard User:'[39m[33m,[39m user)[33m;[39m
     [90m 15 |[39m       [36mthrow[39m err [33m||[39m [36mnew[39m [33mError[39m([32m'Unauthorized'[39m)[33m;[39m [90m// Using Error for visibility in logs if UnauthorizedException is swallowed[39m[0m

      at JwtAuthGuard.handleRequest (src/auth/jwt-auth.guard.ts:12:15)
      at node_modules/@nestjs/passport/dist/auth.guard.js:44:124
      at node_modules/@nestjs/passport/dist/auth.guard.js:83:24
      at allFailed (node_modules/passport/lib/middleware/authenticate.js:110:18)
      at attempt (node_modules/passport/lib/middleware/authenticate.js:183:28)
      at JwtStrategy.strategy.fail (node_modules/passport/lib/middleware/authenticate.js:314:9)
      at node_modules/passport-jwt/lib/strategy.js:106:33
      at Object.<anonymous>.module.exports [as verify] (node_modules/jsonwebtoken/verify.js:70:12)
      at Function.Object.<anonymous>.module.exports [as JwtVerifier] (node_modules/passport-jwt/lib/verify_jwt.js:4:16)
      at node_modules/passport-jwt/lib/strategy.js:104:25
      at JwtStrategy._secretOrKeyProvider (node_modules/passport-jwt/lib/strategy.js:40:13)
      at JwtStrategy.Object.<anonymous>.JwtStrategy.authenticate (node_modules/passport-jwt/lib/strategy.js:99:10)
      at attempt (node_modules/passport/lib/middleware/authenticate.js:378:16)
      at authenticate (node_modules/passport/lib/middleware/authenticate.js:379:7)
      at node_modules/@nestjs/passport/dist/auth.guard.js:88:3
      at node_modules/@nestjs/passport/dist/auth.guard.js:80:83
      at JwtAuthGuard.canActivate (node_modules/@nestjs/passport/dist/auth.guard.js:44:32)

  console.error
    JwtAuthGuard Info: JsonWebTokenError {
      name: 'JsonWebTokenError',
      message: 'jwt malformed'
    }

    [0m [90m 11 |[39m     [36mif[39m (err [33m||[39m [33m![39muser) {
     [90m 12 |[39m       console[33m.[39merror([32m'JwtAuthGuard Error:'[39m[33m,[39m err)[33m;[39m
    [31m[1m>[22m[39m[90m 13 |[39m       console[33m.[39merror([32m'JwtAuthGuard Info:'[39m[33m,[39m info)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 14 |[39m       console[33m.[39merror([32m'JwtAuthGuard User:'[39m[33m,[39m user)[33m;[39m
     [90m 15 |[39m       [36mthrow[39m err [33m||[39m [36mnew[39m [33mError[39m([32m'Unauthorized'[39m)[33m;[39m [90m// Using Error for visibility in logs if UnauthorizedException is swallowed[39m
     [90m 16 |[39m     }[0m

      at JwtAuthGuard.handleRequest (src/auth/jwt-auth.guard.ts:13:15)
      at node_modules/@nestjs/passport/dist/auth.guard.js:44:124
      at node_modules/@nestjs/passport/dist/auth.guard.js:83:24
      at allFailed (node_modules/passport/lib/middleware/authenticate.js:110:18)
      at attempt (node_modules/passport/lib/middleware/authenticate.js:183:28)
      at JwtStrategy.strategy.fail (node_modules/passport/lib/middleware/authenticate.js:314:9)
      at node_modules/passport-jwt/lib/strategy.js:106:33
      at Object.<anonymous>.module.exports [as verify] (node_modules/jsonwebtoken/verify.js:70:12)
      at Function.Object.<anonymous>.module.exports [as JwtVerifier] (node_modules/passport-jwt/lib/verify_jwt.js:4:16)
      at node_modules/passport-jwt/lib/strategy.js:104:25
      at JwtStrategy._secretOrKeyProvider (node_modules/passport-jwt/lib/strategy.js:40:13)
      at JwtStrategy.Object.<anonymous>.JwtStrategy.authenticate (node_modules/passport-jwt/lib/strategy.js:99:10)
      at attempt (node_modules/passport/lib/middleware/authenticate.js:378:16)
      at authenticate (node_modules/passport/lib/middleware/authenticate.js:379:7)
      at node_modules/@nestjs/passport/dist/auth.guard.js:88:3
      at node_modules/@nestjs/passport/dist/auth.guard.js:80:83
      at JwtAuthGuard.canActivate (node_modules/@nestjs/passport/dist/auth.guard.js:44:32)

  console.error
    JwtAuthGuard User: false

    [0m [90m 12 |[39m       console[33m.[39merror([32m'JwtAuthGuard Error:'[39m[33m,[39m err)[33m;[39m
     [90m 13 |[39m       console[33m.[39merror([32m'JwtAuthGuard Info:'[39m[33m,[39m info)[33m;[39m
    [31m[1m>[22m[39m[90m 14 |[39m       console[33m.[39merror([32m'JwtAuthGuard User:'[39m[33m,[39m user)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 15 |[39m       [36mthrow[39m err [33m||[39m [36mnew[39m [33mError[39m([32m'Unauthorized'[39m)[33m;[39m [90m// Using Error for visibility in logs if UnauthorizedException is swallowed[39m
     [90m 16 |[39m     }
     [90m 17 |[39m     [36mreturn[39m user[33m;[39m[0m

      at JwtAuthGuard.handleRequest (src/auth/jwt-auth.guard.ts:14:15)
      at node_modules/@nestjs/passport/dist/auth.guard.js:44:124
      at node_modules/@nestjs/passport/dist/auth.guard.js:83:24
      at allFailed (node_modules/passport/lib/middleware/authenticate.js:110:18)
      at attempt (node_modules/passport/lib/middleware/authenticate.js:183:28)
      at JwtStrategy.strategy.fail (node_modules/passport/lib/middleware/authenticate.js:314:9)
      at node_modules/passport-jwt/lib/strategy.js:106:33
      at Object.<anonymous>.module.exports [as verify] (node_modules/jsonwebtoken/verify.js:70:12)
      at Function.Object.<anonymous>.module.exports [as JwtVerifier] (node_modules/passport-jwt/lib/verify_jwt.js:4:16)
      at node_modules/passport-jwt/lib/strategy.js:104:25
      at JwtStrategy._secretOrKeyProvider (node_modules/passport-jwt/lib/strategy.js:40:13)
      at JwtStrategy.Object.<anonymous>.JwtStrategy.authenticate (node_modules/passport-jwt/lib/strategy.js:99:10)
      at attempt (node_modules/passport/lib/middleware/authenticate.js:378:16)
      at authenticate (node_modules/passport/lib/middleware/authenticate.js:379:7)
      at node_modules/@nestjs/passport/dist/auth.guard.js:88:3
      at node_modules/@nestjs/passport/dist/auth.guard.js:80:83
      at JwtAuthGuard.canActivate (node_modules/@nestjs/passport/dist/auth.guard.js:44:32)

[Nest] 44864  - 20/12/2025, 23:46:38   ERROR [ExceptionsHandler] Error: Unauthorized
    at JwtAuthGuard.handleRequest (C:\projects\aprendeai-app\services\api\src\auth\jwt-auth.guard.ts:15:20)
    at C:\projects\aprendeai-app\services\api\node_modules\@nestjs\passport\dist\auth.guard.js:44:124
    at C:\projects\aprendeai-app\services\api\node_modules\@nestjs\passport\dist\auth.guard.js:83:24
    at allFailed (C:\projects\aprendeai-app\services\api\node_modules\passport\lib\middleware\authenticate.js:110:18)
    at attempt (C:\projects\aprendeai-app\services\api\node_modules\passport\lib\middleware\authenticate.js:183:28)
    at JwtStrategy.strategy.fail (C:\projects\aprendeai-app\services\api\node_modules\passport\lib\middleware\authenticate.js:314:9)
    at C:\projects\aprendeai-app\services\api\node_modules\passport-jwt\lib\strategy.js:106:33
    at Object.<anonymous>.module.exports [as verify] (C:\projects\aprendeai-app\services\api\node_modules\jsonwebtoken\verify.js:70:12)
    at Function.Object.<anonymous>.module.exports [as JwtVerifier] (C:\projects\aprendeai-app\services\api\node_modules\passport-jwt\lib\verify_jwt.js:4:16)
    at C:\projects\aprendeai-app\services\api\node_modules\passport-jwt\lib\strategy.js:104:25
    at JwtStrategy._secretOrKeyProvider (C:\projects\aprendeai-app\services\api\node_modules\passport-jwt\lib\strategy.js:40:13)
    at JwtStrategy.Object.<anonymous>.JwtStrategy.authenticate (C:\projects\aprendeai-app\services\api\node_modules\passport-jwt\lib\strategy.js:99:10)
    at attempt (C:\projects\aprendeai-app\services\api\node_modules\passport\lib\middleware\authenticate.js:378:16)
    at authenticate (C:\projects\aprendeai-app\services\api\node_modules\passport\lib\middleware\authenticate.js:379:7)
    at C:\projects\aprendeai-app\services\api\node_modules\@nestjs\passport\dist\auth.guard.js:88:3
    at new Promise (<anonymous>)
    at C:\projects\aprendeai-app\services\api\node_modules\@nestjs\passport\dist\auth.guard.js:80:83
    at JwtAuthGuard.canActivate (C:\projects\aprendeai-app\services\api\node_modules\@nestjs\passport\dist\auth.guard.js:44:32)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
FAIL test/integration/family-primary.integration.spec.ts (7.045 s)
  Primary Family Logic (Integration)
    Auto-Primary on Creation
      Ã— should set primaryFamilyId in database when creating FIRST family (206 ms)
      â—‹ skipped should switch Primary when creating SECOND family (Creation Priority)
    Auto-Primary on Invites
      â—‹ skipped should set Primary on FIRST invite acceptance
      â—‹ skipped should NOT change Primary on SECOND invite acceptance

  â— Primary Family Logic (Integration) â€º Auto-Primary on Creation â€º should set primaryFamilyId in database when creating FIRST family

    expected 201 "Created", got 500 "Internal Server Error"

      74 |         .set('Authorization', `Bearer ${token}`)
      75 |         .send({ name: 'Family A' })
    > 76 |         .expect(201);
         |          ^
      77 |
      78 |       const familyId = res.body.id;
      79 |

      at Object.<anonymous> (test/integration/family-primary.integration.spec.ts:76:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

Test Suites: 1 failed, 1 total
Tests:       1 failed, 3 skipped, 4 total
Snapshots:   0 total
Time:        7.244 s
Ran all test suites matching /test\\integration\\family-primary.integration.spec.ts/i with tests matching "FIRST family".
