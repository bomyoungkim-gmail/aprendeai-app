
> api@0.0.1 test:e2e
> jest --config ./test/jest-e2e.json session-history.e2e-spec.ts --runInBand

FAIL test/e2e/session-history.e2e-spec.ts (6.428 s)
  Session History API (E2E)
    GET /api/v1/sessions
      × should return paginated sessions with default params (20 ms)
      × should respect page and limit parameters (6 ms)
      × should filter by phase (4 ms)
      × should filter by date range (4 ms)
      × should search by content title (4 ms)
      × should enforce max limit of 100 (3 ms)
      √ should return 401 without auth token (3 ms)
    GET /api/v1/sessions/export
      × should export as JSON by default (4 ms)
      × should export as CSV when format=csv (4 ms)
      √ should return 401 without auth token (3 ms)
    GET /api/v1/sessions/analytics
      × should return analytics with default 30 days (3 ms)
      × should respect custom days parameter (3 ms)
      × should return activity grouped by date (3 ms)
      √ should return 401 without auth token (3 ms)

  ● Session History API (E2E) › GET /api/v1/sessions › should return paginated sessions with default params

    expected 200 "OK", got 401 "Unauthorized"

      90 |         .get('/api/v1/sessions')
      91 |         .set('Authorization', authToken)
    > 92 |         .expect(200)
         |          ^
      93 |         .expect((res) => {
      94 |           expect(res.body.sessions).toBeDefined();
      95 |           expect(Array.isArray(res.body.sessions)).toBe(true);

      at Object.<anonymous> (test/e2e/session-history.e2e-spec.ts:92:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ● Session History API (E2E) › GET /api/v1/sessions › should respect page and limit parameters

    expected 200 "OK", got 401 "Unauthorized"

      108 |         .get('/api/v1/sessions?page=2&limit=10')
      109 |         .set('Authorization', authToken)
    > 110 |         .expect(200)
          |          ^
      111 |         .expect((res) => {
      112 |           expect(res.body.sessions.length).toBeLessThanOrEqual(10);
      113 |           expect(res.body.pagination).toMatchObject({

      at Object.<anonymous> (test/e2e/session-history.e2e-spec.ts:110:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ● Session History API (E2E) › GET /api/v1/sessions › should filter by phase

    expected 200 "OK", got 401 "Unauthorized"

      122 |         .get('/api/v1/sessions?phase=PRE')
      123 |         .set('Authorization', authToken)
    > 124 |         .expect(200)
          |          ^
      125 |         .expect((res) => {
      126 |           expect(res.body.sessions.length).toBeGreaterThan(0);
      127 |           res.body.sessions.forEach((session: any) => {

      at Object.<anonymous> (test/e2e/session-history.e2e-spec.ts:124:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ● Session History API (E2E) › GET /api/v1/sessions › should filter by date range

    expected 200 "OK", got 401 "Unauthorized"

      139 |         .get(`/api/v1/sessions?since=${since.toISOString()}&until=${until.toISOString()}`)
      140 |         .set('Authorization', authToken)
    > 141 |         .expect(200)
          |          ^
      142 |         .expect((res) => {
      143 |           expect(res.body.sessions).toBeDefined();
      144 |           expect(res.body.sessions.length).toBeGreaterThan(0);

      at Object.<anonymous> (test/e2e/session-history.e2e-spec.ts:141:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ● Session History API (E2E) › GET /api/v1/sessions › should search by content title

    expected 200 "OK", got 401 "Unauthorized"

      151 |         .get('/api/v1/sessions?query=Test Article')
      152 |         .set('Authorization', authToken)
    > 153 |         .expect(200)
          |          ^
      154 |         .expect((res) => {
      155 |           expect(res.body.sessions).toBeDefined();
      156 |           res.body.sessions.forEach((session: any) => {

      at Object.<anonymous> (test/e2e/session-history.e2e-spec.ts:153:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ● Session History API (E2E) › GET /api/v1/sessions › should enforce max limit of 100

    expected 200 "OK", got 401 "Unauthorized"

      164 |         .get('/api/v1/sessions?limit=500')
      165 |         .set('Authorization', authToken)
    > 166 |         .expect(200)
          |          ^
      167 |         .expect((res) => {
      168 |           expect(res.body.pagination.limit).toBeLessThanOrEqual(100);
      169 |         });

      at Object.<anonymous> (test/e2e/session-history.e2e-spec.ts:166:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ● Session History API (E2E) › GET /api/v1/sessions/export › should export as JSON by default

    expected 200 "OK", got 401 "Unauthorized"

      182 |         .get('/api/v1/sessions/export')
      183 |         .set('Authorization', authToken)
    > 184 |         .expect(200)
          |          ^
      185 |         .expect((res) => {
      186 |           expect(res.body.data).toBeDefined();
      187 |           expect(Array.isArray(res.body.data)).toBe(true);

      at Object.<anonymous> (test/e2e/session-history.e2e-spec.ts:184:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ● Session History API (E2E) › GET /api/v1/sessions/export › should export as CSV when format=csv

    expected 200 "OK", got 401 "Unauthorized"

      194 |         .get('/api/v1/sessions/export?format=csv')
      195 |         .set('Authorization', authToken)
    > 196 |         .expect(200)
          |          ^
      197 |         .expect((res) => {
      198 |           expect(res.body.data).toBeDefined();
      199 |           expect(typeof res.body.data).toBe('string');

      at Object.<anonymous> (test/e2e/session-history.e2e-spec.ts:196:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ● Session History API (E2E) › GET /api/v1/sessions/analytics › should return analytics with default 30 days

    expected 200 "OK", got 401 "Unauthorized"

      215 |         .get('/api/v1/sessions/analytics')
      216 |         .set('Authorization', authToken)
    > 217 |         .expect(200)
          |          ^
      218 |         .expect((res) => {
      219 |           expect(res.body).toHaveProperty('activityByDate');
      220 |           expect(res.body).toHaveProperty('phaseDistribution');

      at Object.<anonymous> (test/e2e/session-history.e2e-spec.ts:217:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ● Session History API (E2E) › GET /api/v1/sessions/analytics › should respect custom days parameter

    expected 200 "OK", got 401 "Unauthorized"

      233 |         .get('/api/v1/sessions/analytics?days=7')
      234 |         .set('Authorization', authToken)
    > 235 |         .expect(200)
          |          ^
      236 |         .expect((res) => {
      237 |           expect(res.body.periodDays).toBe(7);
      238 |           expect(res.body.totalSessions).toBeLessThan(25);

      at Object.<anonymous> (test/e2e/session-history.e2e-spec.ts:235:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ● Session History API (E2E) › GET /api/v1/sessions/analytics › should return activity grouped by date

    expected 200 "OK", got 401 "Unauthorized"

      244 |         .get('/api/v1/sessions/analytics?days=30')
      245 |         .set('Authorization', authToken)
    > 246 |         .expect(200)
          |          ^
      247 |         .expect((res) => {
      248 |           expect(typeof res.body.activityByDate).toBe('object');
      249 |           const dates = Object.keys(res.body.activityByDate);

      at Object.<anonymous> (test/e2e/session-history.e2e-spec.ts:246:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

Test Suites: 1 failed, 1 total
Tests:       11 failed, 3 passed, 14 total
Snapshots:   0 total
Time:        6.625 s
Ran all test suites matching /session-history.e2e-spec.ts/i.
