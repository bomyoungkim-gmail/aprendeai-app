
> api@0.0.1 test:integration
> jest --config ./test/jest-integration.config.js --testPathPattern=family.spec

  console.log
    [FamilyService.create] BEFORE UPDATE: { userId: '91c73091-abc6-4159-895c-68aa94266af9', currentSettings: {} }

      at ../src/family/family.service.ts:50:15

  console.log
    [FamilyService.create] AFTER UPDATE - Set primaryFamilyId: 2da8aac9-145b-4163-9686-02280cb2d0fd

      at ../src/family/family.service.ts:62:15

  console.log
    Inviting new user: newuser@family-test.com

      at FamilyService.inviteMember (../src/family/family.service.ts:164:16)

  console.log
    [FamilyService.create] BEFORE UPDATE: {
      userId: '91c73091-abc6-4159-895c-68aa94266af9',
      currentSettings: { primaryFamilyId: '2da8aac9-145b-4163-9686-02280cb2d0fd' }
    }

      at ../src/family/family.service.ts:50:15

  console.log
    [FamilyService.create] AFTER UPDATE - Set primaryFamilyId: aa7a4a40-2b49-4ba4-8ab6-f9a425f32ce9

      at ../src/family/family.service.ts:62:15

  console.log
    [FamilyService.create] BEFORE UPDATE: {
      userId: '91c73091-abc6-4159-895c-68aa94266af9',
      currentSettings: { primaryFamilyId: 'aa7a4a40-2b49-4ba4-8ab6-f9a425f32ce9' }
    }

      at ../src/family/family.service.ts:50:15

  console.log
    [FamilyService.create] AFTER UPDATE - Set primaryFamilyId: 95e1ee94-8b0a-4e22-bc40-b7e0eb146ad5

      at ../src/family/family.service.ts:62:15

FAIL test/integration/family.spec.ts (6.366 s)
  Family Plan (Integration)
    Authentication Setup
      √ should register and login owner user (205 ms)
    POST /families
      √ should create family with current user as owner (52 ms)
      √ should create owner membership record (3 ms)
      √ should return family with members array (20 ms)
    GET /families
      √ should list all families user belongs to (14 ms)
    POST /families/:id/invite
      × should add existing user as GUARDIAN (95 ms)
      × should create placeholder user for new email (30 ms)
      √ should reject duplicate invitations (20 ms)
      √ should only allow owner to invite members (146 ms)
    POST /families/:id/transfer-ownership
      × should transfer ownership to existing member (22 ms)
      √ should prevent non-owner from transferring (12 ms)
    POST /families/:id/primary
      × should set family as primary for user (14 ms)
      √ should only allow family members to set as primary (136 ms)
    GET /families/:id/billing-hierarchy
      × should resolve to primary family (4 ms)
      × should fall back to user scope if no families (64 ms)
    DELETE /families/:id
      √ should delete family and all members (17 ms)
      √ should only allow owner to delete family (71 ms)
      √ should return 404 if family does not exist (8 ms)
    Multi-Family Scenarios
      √ should create second family (25 ms)
      √ should list both families (12 ms)
      √ should switch primary family (14 ms)
      × should resolve billing to new primary family (3 ms)

  ● Family Plan (Integration) › POST /families/:id/invite › should add existing user as GUARDIAN

    expect(received).toContain(expected) // indexOf

    Matcher error: received value must not be null nor undefined

    Received has value: undefined

      151 |         .expect(201);
      152 |
    > 153 |       expect(response.body.message).toContain('invited');
          |                                     ^
      154 |
      155 |       // Verify membership created
      156 |       const existingUser = await prisma.user.findUnique({

      at Object.<anonymous> (integration/family.spec.ts:153:37)

  ● Family Plan (Integration) › POST /families/:id/invite › should create placeholder user for new email

    expect(received).toContain(expected) // indexOf

    Matcher error: received value must not be null nor undefined

    Received has value: undefined

      182 |         .expect(201);
      183 |
    > 184 |       expect(response.body.message).toContain('invited');
          |                                     ^
      185 |
      186 |       // Verify placeholder user created
      187 |       const newUser = await prisma.user.findUnique({

      at Object.<anonymous> (integration/family.spec.ts:184:37)

  ● Family Plan (Integration) › POST /families/:id/transfer-ownership › should transfer ownership to existing member

    expect(received).toContain(expected) // indexOf

    Matcher error: received value must not be null nor undefined

    Received has value: undefined

      256 |         .expect(201);
      257 |
    > 258 |       expect(response.body.message).toContain('transferred');
          |                                     ^
      259 |
      260 |       // Verify family ownerId updated
      261 |       const family = await prisma.family.findUnique({

      at Object.<anonymous> (integration/family.spec.ts:258:37)

  ● Family Plan (Integration) › POST /families/:id/primary › should set family as primary for user

    expect(received).toContain(expected) // indexOf

    Matcher error: received value must not be null nor undefined

    Received has value: undefined

      318 |         .expect(201);
      319 |
    > 320 |       expect(response.body.message).toContain('primary');
          |                                     ^
      321 |
      322 |       // Verify user settings updated
      323 |       const user = await prisma.user.findUnique({

      at Object.<anonymous> (integration/family.spec.ts:320:37)

  ● Family Plan (Integration) › GET /families/:id/billing-hierarchy › should resolve to primary family

    expected 200 "OK", got 404 "Not Found"

      358 |         .get(apiUrl(ROUTES.FAMILY.BILLING_HIERARCHY(familyId)))
      359 |         .set('Authorization', `Bearer ${authToken}`)
    > 360 |         .expect(200);
          |          ^
      361 |
      362 |       expect(response.body.scopeType).toBe('FAMILY');
      363 |       expect(response.body.scopeId).toBe(familyId);

      at Object.<anonymous> (integration/family.spec.ts:360:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › GET /families/:id/billing-hierarchy › should fall back to user scope if no families

    expected 200 "OK", got 404 "Not Found"

      375 |         .get(apiUrl(ROUTES.FAMILY.BILLING_HIERARCHY('any-id')))
      376 |         .set('Authorization', `Bearer ${outsiderLogin.body.access_token}`)
    > 377 |         .expect(200);
          |          ^
      378 |
      379 |       expect(response.body.scopeType).toBe('USER');
      380 |     });

      at Object.<anonymous> (integration/family.spec.ts:377:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › Multi-Family Scenarios › should resolve billing to new primary family

    expected 200 "OK", got 404 "Not Found"

      482 |         .get(apiUrl(ROUTES.FAMILY.BILLING_HIERARCHY(secondFamilyId)))
      483 |         .set('Authorization', `Bearer ${authToken}`)
    > 484 |         .expect(200);
          |          ^
      485 |
      486 |       expect(response.body.scopeId).toBe(secondFamilyId);
      487 |     });

      at Object.<anonymous> (integration/family.spec.ts:484:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

Test Suites: 1 failed, 1 total
Tests:       7 failed, 15 passed, 22 total
Snapshots:   0 total
Time:        6.564 s, estimated 14 s
Ran all test suites matching /family.spec/i.
