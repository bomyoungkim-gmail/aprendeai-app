[Nest] 7652  - 22/12/2025, 13:06:29   ERROR [ExceptionsHandler] PrismaClientValidationError: 
Invalid `this.prisma.sessionEvent.create()` invocation in
C:\projects\aprendeai-app\services\api\src\events\classroom-event.service.ts:32:37

  29 
  30 const validatedPayload = schema.parse(eventPayload);
  31 
→ 32 return this.prisma.sessionEvent.create({
       data: {
         readingSessionId: "help_1766419589449",
         eventType: "CLASS_ALERT_RAISED",
                    ~~~~~~~~~~~~~~~~~~~~
         payloadJson: {
           domain: "CLASS",
           type: "CLASS_ALERT_RAISED",
           data: {
             classroomId: "30d31d9c-0c38-4388-b6f0-75124cbb9db1",
             learnerUserId: "a7bdc8ca-6094-4a53-80b1-6fa12ac9a609",
             alertType: "HELP_REQUEST",
             severity: "MED"
           }
         }
       }
     })

Invalid value for argument `eventType`. Expected EventType.
    at wn (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:29:1363)
    at $n.handleRequestError (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:6958)
    at $n.handleAndLogRequestError (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:6623)
    at $n.request (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:121:6307)
    at l (C:\projects\aprendeai-app\services\api\node_modules\@prisma\client\runtime\library.js:130:9633)
    at ClassInterventionService.logHelpRequest (C:\projects\aprendeai-app\services\api\src\classroom\services\class-intervention.service.ts:23:5) {
  clientVersion: '5.22.0'
}
FAIL test/integration/classroom-mode.integration.spec.ts (7.416 s)
  Classroom Mode Integration Tests (e2e)
    Classroom CRUD Flow
      √ should create a classroom (40 ms)
      √ should get classroom by ID (18 ms)
      √ should update classroom (20 ms)
    Enrollment Flow
      × should enroll student in classroom (11 ms)
      × should get enrollments for classroom (11 ms)
    Classroom Policy Flow
      × should create classroom policy (9 ms)
      √ should get policy prompt (7 ms)
    Weekly Planning Flow
      × should create weekly plan (8 ms)
      × should get current week plan (10 ms)
    Dashboard with Privacy Filtering
      × should get teacher dashboard with privacy filtering (13 ms)
    Intervention Flow
      × should log student help request (20 ms)
      √ should get intervention prompt (14 ms)

  ● Classroom Mode Integration Tests (e2e) › Enrollment Flow › should enroll student in classroom

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 400

      142 |         });
      143 |
    > 144 |       expect(response.status).toBe(201);
          |                               ^
      145 |       expect(response.body.learnerUserId).toBe(studentId);
      146 |       expect(response.body.status).toBe('ACTIVE');
      147 |     });

      at Object.<anonymous> (integration/classroom-mode.integration.spec.ts:144:31)

  ● Classroom Mode Integration Tests (e2e) › Enrollment Flow › should get enrollments for classroom

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   0

      154 |       expect(response.status).toBe(200);
      155 |       expect(Array.isArray(response.body)).toBe(true);
    > 156 |       expect(response.body.length).toBeGreaterThan(0);
          |                                    ^
      157 |       expect(response.body[0].learnerUserId).toBe(studentId);
      158 |     });
      159 |   });

      at Object.<anonymous> (integration/classroom-mode.integration.spec.ts:156:36)

  ● Classroom Mode Integration Tests (e2e) › Classroom Policy Flow › should create classroom policy

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 400

      171 |         });
      172 |
    > 173 |       expect(response.status).toBe(201);
          |                               ^
      174 |       expect(response.body.weeklyUnitsTarget).toBe(3);
      175 |       expect(response.body.privacyMode).toBe('AGGREGATED_PLUS_HELP_REQUESTS');
      176 |     });

      at Object.<anonymous> (integration/classroom-mode.integration.spec.ts:173:31)

  ● Classroom Mode Integration Tests (e2e) › Weekly Planning Flow › should create weekly plan

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 400

      205 |         });
      206 |
    > 207 |       expect(response.status).toBe(201);
          |                               ^
      208 |       expect(response.body).toHaveProperty('itemsJson');
      209 |       expect(response.body.itemsJson).toHaveLength(3);
      210 |     });

      at Object.<anonymous> (integration/classroom-mode.integration.spec.ts:207:31)

  ● Classroom Mode Integration Tests (e2e) › Weekly Planning Flow › should get current week plan

    expect(received).toHaveProperty(path)

    Expected path: "itemsJson"
    Received path: []

    Received value: {}

      216 |
      217 |       expect(response.status).toBe(200);
    > 218 |       expect(response.body).toHaveProperty('itemsJson');
          |                             ^
      219 |     });
      220 |   });
      221 |

      at Object.<anonymous> (integration/classroom-mode.integration.spec.ts:218:29)

  ● Classroom Mode Integration Tests (e2e) › Dashboard with Privacy Filtering › should get teacher dashboard with privacy filtering

    expect(received).toBe(expected) // Object.is equality

    Expected: "AGGREGATED_PLUS_HELP_REQUESTS"
    Received: "AGGREGATED_ONLY"

      229 |       expect(response.body).toHaveProperty('activeStudents');
      230 |       expect(response.body).toHaveProperty('students');
    > 231 |       expect(response.body.privacyMode).toBe('AGGREGATED_PLUS_HELP_REQUESTS');
          |                                         ^
      232 |       
      233 |       // With AGGREGATED_PLUS_HELP_REQUESTS: should have helpRequests but not comprehensionScore
      234 |       const student = response.body.students[0];

      at Object.<anonymous> (integration/classroom-mode.integration.spec.ts:231:41)

  ● Classroom Mode Integration Tests (e2e) › Intervention Flow › should log student help request

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

      251 |         });
      252 |
    > 253 |       expect(response.status).toBe(201);
          |                               ^
      254 |       expect(response.body).toHaveProperty('timestamp');
      255 |       expect(response.body.status).toBe('PENDING');
      256 |     });

      at Object.<anonymous> (integration/classroom-mode.integration.spec.ts:253:31)

Test Suites: 1 failed, 1 total
Tests:       7 failed, 5 passed, 12 total
Snapshots:   0 total
Time:        7.611 s, estimated 8 s
Ran all test suites matching /test\\integration\\classroom-mode.integration.spec.ts/i.
