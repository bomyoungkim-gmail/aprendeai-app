
> api@0.0.1 test:unit
> jest --testMatch='**/test/unit/**/*.spec.ts'

  console.log
    [FamilyService.create] BEFORE UPDATE: { userId: 'user-123', currentSettings: {} }

      at src/family/family.service.ts:50:15

  console.log
    [FamilyService.create] AFTER UPDATE - Set primaryFamilyId: family-id

      at src/family/family.service.ts:62:15

  console.log
    [FamilyService.create] BEFORE UPDATE: {
      userId: 'user-123',
      currentSettings: { primaryFamilyId: 'old-family-id' }
    }

      at src/family/family.service.ts:50:15

  console.log
    [FamilyService.create] AFTER UPDATE - Set primaryFamilyId: family-id

      at src/family/family.service.ts:62:15

  console.log
    Inviting new user: newuser@test.com

      at FamilyService.inviteMember (src/family/family.service.ts:164:16)

  console.log
    Inviting new user: newuser@test.com

      at FamilyService.inviteMember (src/family/family.service.ts:164:16)

PASS test/unit/family.service.spec.ts (5.347 s)
  FamilyService (Unit)
    create()
      √ should create family and auto-set as primaryFamilyId (43 ms)
      √ should overwrite existing primaryFamilyId on creation (3 ms)
    acceptInvite()
      √ should accept invite and set Primary if user has none (2 ms)
      √ should accept invite but NOT change Primary if already set (1 ms)
      √ should return member if already active (2 ms)
      √ should throw NotFoundException if invite not found (14 ms)
    inviteMember()
      √ should create placeholder user for non-existent email (2 ms)
      √ should add existing user to family (2 ms)
      √ should set default role to CHILD (3 ms)
      √ should throw if user already in family (2 ms)
      √ should send invitation email (1 ms)
      √ should throw ForbiddenException if not owner (1 ms)
    transferOwnership()
      √ should update family ownerId (2 ms)
      √ should downgrade old owner to GUARDIAN (2 ms)
      √ should upgrade new owner to OWNER (1 ms)
      √ should throw if new owner not in family (1 ms)
      √ should use transaction for atomicity (1 ms)
      √ should throw ForbiddenException if not current owner (5 ms)
    resolveBillingHierarchy()
      √ should return primary family when set (1 ms)
      √ should return first joined family as fallback (1 ms)
      √ should return user scope if no families (1 ms)
    deleteFamily()
      √ should delete family and all members (1 ms)
      √ should throw ForbiddenException if not owner (1 ms)

Test Suites: 1 passed, 1 total
Tests:       23 passed, 23 total
Snapshots:   0 total
Time:        5.664 s
Ran all test suites.
