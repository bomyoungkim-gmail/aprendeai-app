
> api@0.0.1 test:integration
> jest --config ./test/jest-integration.config.js --testPathPattern=family.spec.ts

FAIL test/integration/family.spec.ts (5.895 s)
  ● Family Plan (Integration) › Authentication Setup › should register and login owner user

    expected 200 "OK", got 201 "Created"

      62 |           password: 'Test123!@#',
      63 |         })
    > 64 |         .expect(200);
         |          ^
      65 |
      66 |       authToken = loginResponse.body.accessToken;
      67 |       ownerUserId = loginResponse.body.user.id;

      at Object.<anonymous> (integration/family.spec.ts:64:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › POST /families › should create family with current user as owner

    expected 201 "Created", got 401 "Unauthorized"

      79 |           name: 'Test Family',
      80 |         })
    > 81 |         .expect(201);
         |          ^
      82 |
      83 |       familyId = response.body.id;
      84 |

      at Object.<anonymous> (integration/family.spec.ts:81:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › POST /families › should create owner membership record

    expect(received).toHaveLength(expected)

    Expected length: 1
    Received length: 0
    Received array:  []

      94 |       });
      95 |
    > 96 |       expect(members).toHaveLength(1);
         |                       ^
      97 |       expect(members[0]).toMatchObject({
      98 |         userId: ownerUserId,
      99 |         role: 'OWNER',

      at Object.<anonymous> (integration/family.spec.ts:96:23)

  ● Family Plan (Integration) › POST /families › should return family with members array

    expected 200 "OK", got 401 "Unauthorized"

      106 |         .get(`/families/${familyId}`)
      107 |         .set('Authorization', `Bearer ${authToken}`)
    > 108 |         .expect(200);
          |          ^
      109 |
      110 |       expect(response.body.members).toBeDefined();
      111 |       expect(response.body.members).toHaveLength(1);

      at Object.<anonymous> (integration/family.spec.ts:108:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › GET /families › should list all families user belongs to

    expected 200 "OK", got 401 "Unauthorized"

      119 |         .get('/families')
      120 |         .set('Authorization', `Bearer ${authToken}`)
    > 121 |         .expect(200);
          |          ^
      122 |
      123 |       expect(response.body).toHaveLength(1);
      124 |       expect(response.body[0].name).toBe('Test Family');

      at Object.<anonymous> (integration/family.spec.ts:121:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › POST /families/:id/invite › should add existing user as GUARDIAN

    expected 201 "Created", got 401 "Unauthorized"

      147 |           role: 'GUARDIAN',
      148 |         })
    > 149 |         .expect(201);
          |          ^
      150 |
      151 |       expect(response.body.message).toContain('invited');
      152 |

      at Object.<anonymous> (integration/family.spec.ts:149:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › POST /families/:id/invite › should create placeholder user for new email

    expected 201 "Created", got 401 "Unauthorized"

      178 |           role: 'CHILD',
      179 |         })
    > 180 |         .expect(201);
          |          ^
      181 |
      182 |       expect(response.body.message).toContain('invited');
      183 |

      at Object.<anonymous> (integration/family.spec.ts:180:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › POST /families/:id/invite › should reject duplicate invitations

    expected 400 "Bad Request", got 401 "Unauthorized"

      200 |           role: 'GUARDIAN',
      201 |         })
    > 202 |         .expect(400);
          |          ^
      203 |     });
      204 |
      205 |     it('should only allow owner to invite members', async () => {

      at Object.<anonymous> (integration/family.spec.ts:202:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › POST /families/:id/invite › should only allow owner to invite members

    expected 403 "Forbidden", got 401 "Unauthorized"

      231 |           role: 'CHILD',
      232 |         })
    > 233 |         .expect(403);
          |          ^
      234 |     });
      235 |   });
      236 |

      at Object.<anonymous> (integration/family.spec.ts:233:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › POST /families/:id/transfer-ownership › should transfer ownership to existing member

    expected 200 "OK", got 401 "Unauthorized"

      252 |           newOwnerId: memberUserId,
      253 |         })
    > 254 |         .expect(200);
          |          ^
      255 |
      256 |       expect(response.body.message).toContain('transferred');
      257 |

      at Object.<anonymous> (integration/family.spec.ts:254:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › POST /families/:id/transfer-ownership › should prevent non-owner from transferring

    expected 403 "Forbidden", got 401 "Unauthorized"

      287 |           newOwnerId: ownerUserId,
      288 |         })
    > 289 |         .expect(403);
          |          ^
      290 |     });
      291 |
      292 |     afterAll(async () => {

      at Object.<anonymous> (integration/family.spec.ts:289:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › POST /families/:id/primary › should set family as primary for user

    expected 200 "OK", got 401 "Unauthorized"

      314 |         .post(`/families/${familyId}/primary`)
      315 |         .set('Authorization', `Bearer ${authToken}`)
    > 316 |         .expect(200);
          |          ^
      317 |
      318 |       expect(response.body.message).toContain('primary');
      319 |

      at Object.<anonymous> (integration/family.spec.ts:316:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › POST /families/:id/primary › should only allow family members to set as primary

    expected 400 "Bad Request", got 401 "Unauthorized"

      347 |         .post(`/families/${familyId}/primary`)
      348 |         .set('Authorization', `Bearer ${outsiderLogin.body.accessToken}`)
    > 349 |         .expect(400);
          |          ^
      350 |     });
      351 |   });
      352 |

      at Object.<anonymous> (integration/family.spec.ts:349:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › GET /families/:id/billing-hierarchy › should resolve to primary family

    expected 200 "OK", got 404 "Not Found"

      356 |         .get(`/families/${familyId}/billing-hierarchy`)
      357 |         .set('Authorization', `Bearer ${authToken}`)
    > 358 |         .expect(200);
          |          ^
      359 |
      360 |       expect(response.body.scopeType).toBe('FAMILY');
      361 |       expect(response.body.scopeId).toBe(familyId);

      at Object.<anonymous> (integration/family.spec.ts:358:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › GET /families/:id/billing-hierarchy › should fall back to user scope if no families

    expected 200 "OK", got 404 "Not Found"

      373 |         .get(`/families/any-id/billing-hierarchy`)
      374 |         .set('Authorization', `Bearer ${outsiderLogin.body.accessToken}`)
    > 375 |         .expect(200);
          |          ^
      376 |
      377 |       expect(response.body.scopeType).toBe('USER');
      378 |     });

      at Object.<anonymous> (integration/family.spec.ts:375:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › DELETE /families/:id › should delete family and all members

    expected 200 "OK", got 401 "Unauthorized"

      398 |         .delete(`/families/${tempFamilyId}`)
      399 |         .set('Authorization', `Bearer ${authToken}`)
    > 400 |         .expect(200);
          |          ^
      401 |
      402 |       // Verify family deleted
      403 |       const family = await prisma.family.findUnique({

      at Object.<anonymous> (integration/family.spec.ts:400:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › DELETE /families/:id › should only allow owner to delete family

    expected 403 "Forbidden", got 401 "Unauthorized"

      424 |         .delete(`/families/${familyId}`)
      425 |         .set('Authorization', `Bearer ${newOwnerLogin.body.accessToken}`)
    > 426 |         .expect(403);
          |          ^
      427 |     });
      428 |
      429 |     it('should return 404 if family does not exist', async () => {

      at Object.<anonymous> (integration/family.spec.ts:426:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › DELETE /families/:id › should return 404 if family does not exist

    expected 404 "Not Found", got 401 "Unauthorized"

      431 |         .delete(`/families/non-existent-id`)
      432 |         .set('Authorization', `Bearer ${authToken}`)
    > 433 |         .expect(404);
          |          ^
      434 |     });
      435 |   });
      436 |

      at Object.<anonymous> (integration/family.spec.ts:433:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › Multi-Family Scenarios › should create second family

    expected 201 "Created", got 401 "Unauthorized"

      445 |           name: 'Second Family',
      446 |         })
    > 447 |         .expect(201);
          |          ^
      448 |
      449 |       secondFamilyId = response.body.id;
      450 |       expect(response.body.name).toBe('Second Family');

      at Object.<anonymous> (integration/family.spec.ts:447:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › Multi-Family Scenarios › should list both families

    expected 200 "OK", got 401 "Unauthorized"

      455 |         .get('/families')
      456 |         .set('Authorization', `Bearer ${authToken}`)
    > 457 |         .expect(200);
          |          ^
      458 |
      459 |       expect(response.body.length).toBeGreaterThanOrEqual(2);
      460 |       const familyNames = response.body.map(f => f.name);

      at Object.<anonymous> (integration/family.spec.ts:457:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › Multi-Family Scenarios › should switch primary family

    expected 200 "OK", got 401 "Unauthorized"

      467 |         .post(`/families/${secondFamilyId}/primary`)
      468 |         .set('Authorization', `Bearer ${authToken}`)
    > 469 |         .expect(200);
          |          ^
      470 |
      471 |       const user = await prisma.user.findUnique({
      472 |         where: { id: ownerUserId },

      at Object.<anonymous> (integration/family.spec.ts:469:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Family Plan (Integration) › Multi-Family Scenarios › should resolve billing to new primary family

    expected 200 "OK", got 404 "Not Found"

      480 |         .get(`/families/${secondFamilyId}/billing-hierarchy`)
      481 |         .set('Authorization', `Bearer ${authToken}`)
    > 482 |         .expect(200);
          |          ^
      483 |
      484 |       expect(response.body.scopeId).toBe(secondFamilyId);
      485 |     });

      at Object.<anonymous> (integration/family.spec.ts:482:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)


  ● Test suite failed to run

    expected 200 "OK", got 401 "Unauthorized"

      305 |           newOwnerId: ownerUserId,
      306 |         })
    > 307 |         .expect(200);
          |          ^
      308 |     });
      309 |   });
      310 |

      at Object.<anonymous> (integration/family.spec.ts:307:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

Test Suites: 1 failed, 1 total
Tests:       22 failed, 22 total
Snapshots:   0 total
Time:        6.103 s
Ran all test suites matching /family.spec.ts/i.
