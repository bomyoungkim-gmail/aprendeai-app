
> api@0.0.1 test
> jest test/integration/solo-sessions.integration.spec.ts

  console.warn
    ‚ö†Ô∏è  FRONTEND_URL not set, using fallback: http://localhost:3000

    [0m [90m 28 |[39m
     [90m 29 |[39m     [36mif[39m (fallback) {
    [31m[1m>[22m[39m[90m 30 |[39m       console[33m.[39mwarn([32m`‚ö†Ô∏è  ${envVar} not set, using fallback: ${fallback}`[39m)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 31 |[39m       [36mreturn[39m fallback[33m;[39m
     [90m 32 |[39m     }
     [90m 33 |[39m[0m

      at requireInProduction (src/config/urls.config.ts:30:15)
      at Object.<anonymous> (src/config/urls.config.ts:53:11)
      at Object.<anonymous> (src/notifications/notifications.gateway.ts:13:1)
      at Object.<anonymous> (src/queue/queue-consumer.service.ts:3:1)
      at Object.<anonymous> (src/queue/queue.module.ts:4:1)
      at Object.<anonymous> (src/app.module.ts:6:1)
      at Object.<anonymous> (test/integration/solo-sessions.integration.spec.ts:5:1)

[Nest] 34600  - 25/12/2025, 15:39:43   ERROR [ExceptionsHandler] TypeError: Do not know how to serialize a BigInt
    at JSON.stringify (<anonymous>)
    at stringify (C:\projects\aprendeai-app\services\api\node_modules\express\lib\response.js:1020:12)
    at ServerResponse.json (C:\projects\aprendeai-app\services\api\node_modules\express\lib\response.js:243:14)
    at ExpressAdapter.reply (C:\projects\aprendeai-app\services\api\node_modules\@nestjs\platform-express\adapters\express-adapter.js:80:62)
    at RouterResponseController.apply (C:\projects\aprendeai-app\services\api\node_modules\@nestjs\core\router\router-response-controller.js:15:36)
    at C:\projects\aprendeai-app\services\api\node_modules\@nestjs\core\router\router-execution-context.js:176:48
    at C:\projects\aprendeai-app\services\api\node_modules\@nestjs\core\router\router-execution-context.js:47:13
    at C:\projects\aprendeai-app\services\api\node_modules\@nestjs\core\router\router-proxy.js:9:17
[Nest] 34600  - 25/12/2025, 15:39:44   ERROR [AiServiceClient] AI Service call failed (correlationId=test-thread-id)
[Nest] 34600  - 25/12/2025, 15:39:44   ERROR [AiServiceClient] AxiosError {
  message: 'Request failed with status code 500',
  name: 'AxiosError',
  code: 'ERR_BAD_RESPONSE',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [
      'xhr',
      'http',
      'fetch'
    ],
    transformRequest: [
      [Function: transformRequest]
    ],
    transformResponse: [
      [Function: transformResponse]
    ],
    timeout: 30000,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: {
      FormData: [Function: FormData] {
        LINE_BREAK: '\r\n',
        DEFAULT_CONTENT_TYPE: 'application/octet-stream'
      },
      Blob: [class Blob]
    },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      'X-Signature': 'sha256=cbb9e5400a51f0323f684423723817acf5f864ecf94deae7211b5029aea602f3',
      'X-Correlation-ID': 'test-thread-id',
      'X-Request-ID': 'test-thread-id',
      'User-Agent': 'axios/1.13.2',
      'Content-Length': '633',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    cancelToken: CancelToken {
      promise: Promise {
        CanceledError {
          message: 'canceled',
          name: 'CanceledError',
          code: 'ERR_CANCELED'
        },
        then: [Function (anonymous)]
      },
      _listeners: [],
      reason: CanceledError {
        message: 'canceled',
        name: 'CanceledError',
        code: 'ERR_CANCELED'
      }
    },
    method: 'post',
    url: 'http://localhost:8001/educator/turn',
    data: '{"promptMessage":{"text":"What is the main idea of this article?","actorRole":"LEARNER","threadId":"test-thread-id","readingSessionId":"99f6833e-a87d-4084-ab78-0fa1e0dd35c4","clientTs":"2025-12-25T18:39:44.029Z","metadata":{"uiMode":"DURING","contentId":"553122c6-a697-4dff-90a5-bca1ad0181aa","assetLayer":"L1","readingIntent":"analytical","tenantId":"633cb093-ccbd-4534-afc4-b97774f63894","userId":"633cb093-ccbd-4534-afc4-b97774f63894","pedState":{},"lastTurns":[],"contentSlice":"Article content","memoriesTopK":6,"contextPlan":{"prefixVersion":"CANONICAL_PREFIX_V1","lastTurnsWindow":6,"memoriesTopK":6,"contentSliceChars":15}}}}',
    allowAbsoluteUrls: true
  },
  request: <ref *2> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: 633,
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    _header: 'POST /educator/turn HTTP/1.1\r\nAccept: application/json, text/plain, */*\r\nContent-Type: application/json\r\nX-Signature: sha256=cbb9e5400a51f0323f684423723817acf5f864ecf94deae7211b5029aea602f3\r\nX-Correlation-ID: test-thread-id\r\nX-Request-ID: test-thread-id\r\nUser-Agent: axios/1.13.2\r\nContent-Length: 633\r\nAccept-Encoding: gzip, compress, deflate, br\r\nHost: localhost:8001\r\nConnection: keep-alive\r\n\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype] {
        free: [Function (anonymous)],
        newListener: [Function: maybeEnableKeylog]
      },
      _eventsCount: 2,
      _maxListeners: undefined,
      options: [Object: null prototype] {
        keepAlive: true,
        scheduling: 'lifo',
        timeout: 5000,
        proxyEnv: undefined,
        noDelay: true,
        path: null
      },
      defaultPort: 80,
      protocol: 'http:',
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype] {
        'localhost:8001:': [
          Socket {
            connecting: false,
            _hadError: false,
            _parent: null,
            _host: 'localhost',
            _closeAfterHandlingError: false,
            _events: [Object],
            _readableState: [ReadableState],
            _writableState: [WritableState],
            allowHalfOpen: false,
            _maxListeners: undefined,
            _eventsCount: 6,
            _sockname: null,
            _pendingData: null,
            _pendingEncoding: '',
            server: null,
            _server: null,
            timeout: 5000,
            parser: null,
            _httpMessage: null,
            autoSelectFamilyAttemptedAddresses: [Array],
            [Symbol(async_id_symbol)]: -1,
            [Symbol(kHandle)]: [TCP],
            [Symbol(lastWriteQueueSize)]: 0,
            [Symbol(timeout)]: Timeout {
              _idleTimeout: 5000,
              _idlePrev: [TimersList],
              _idleNext: [Timeout],
              _idleStart: 6682,
              _onTimeout: [Function: bound ],
              _timerArgs: undefined,
              _repeat: null,
              _destroyed: false,
              [Symbol(refed)]: false,
              [Symbol(kHasPrimitive)]: false,
              [Symbol(asyncId)]: 2504,
              [Symbol(triggerId)]: 2502,
              [Symbol(kAsyncContextFrame)]: undefined
            },
            [Symbol(kBuffer)]: null,
            [Symbol(kBufferCb)]: null,
            [Symbol(kBufferGen)]: null,
            [Symbol(shapeMode)]: true,
            [Symbol(kCapture)]: false,
            [Symbol(kSetNoDelay)]: true,
            [Symbol(kSetKeepAlive)]: true,
            [Symbol(kSetKeepAliveInitialDelay)]: 1,
            [Symbol(kBytesRead)]: 0,
            [Symbol(kBytesWritten)]: 0
          }
        ]
      },
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      agentKeepAliveTimeoutBuffer: 1000,
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/educator/turn',
    _ended: true,
    res: IncomingMessage {
      _events: {
        close: undefined,
        error: [Function: handleStreamError],
        data: [Function: handleStreamData],
        end: [
          [Function: responseOnEnd],
          [Function: handleStreamEnd]
        ],
        readable: undefined,
        aborted: [Function: handlerStreamAborted]
      },
      _readableState: ReadableState {
        highWaterMark: 16384,
        buffer: [],
        bufferIndex: 0,
        length: 0,
        pipes: [],
        awaitDrainWriters: null,
        [Symbol(kState)]: 194779004
      },
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [
        'date',
        'Thu, 25 Dec 2025 18:39:43 GMT',
        'server',
        'uvicorn',
        'content-length',
        '76',
        'content-type',
        'application/json',
        'x-request-id',
        'test-thread-id',
        'x-response-time',
        '0.012s'
      ],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 500,
      statusMessage: 'Internal Server Error',
      client: <ref *1> Socket {
        connecting: false,
        _hadError: false,
        _parent: null,
        _host: 'localhost',
        _closeAfterHandlingError: false,
        _events: {
          close: [Function: onClose],
          error: [Function: bound onceWrapper] {
            listener: [Function: freeSocketErrorListener]
          },
          prefinish: undefined,
          finish: undefined,
          drain: undefined,
          data: undefined,
          end: [Function: onReadableStreamEnd],
          readable: undefined,
          connect: undefined,
          free: [Function: onFree],
          timeout: [
            [Function: onTimeout],
            [Function (anonymous)]
          ],
          agentRemove: [Function: onRemove]
        },
        _readableState: ReadableState {
          highWaterMark: 16384,
          buffer: [],
          bufferIndex: 0,
          length: 0,
          pipes: [],
          awaitDrainWriters: null,
          [Symbol(kState)]: 60303620
        },
        _writableState: WritableState {
          highWaterMark: 16384,
          length: 0,
          corked: 0,
          onwrite: [Function: bound onwrite],
          writelen: 0,
          bufferedIndex: 0,
          pendingcb: 0,
          [Symbol(kState)]: 17563908,
          [Symbol(kBufferedValue)]: null,
          [Symbol(kWriteCbValue)]: null
        },
        allowHalfOpen: false,
        _maxListeners: undefined,
        _eventsCount: 6,
        _sockname: null,
        _pendingData: null,
        _pendingEncoding: '',
        server: null,
        _server: null,
        timeout: 5000,
        parser: null,
        _httpMessage: null,
        autoSelectFamilyAttemptedAddresses: [
          '::1:8001'
        ],
        [Symbol(async_id_symbol)]: -1,
        [Symbol(kHandle)]: TCP {
          reading: true,
          onconnection: null,
          [Symbol(owner_symbol)]: [Circular *1]
        },
        [Symbol(lastWriteQueueSize)]: 0,
        [Symbol(timeout)]: Timeout {
          _idleTimeout: 5000,
          _idlePrev: [TimersList],
          _idleNext: [Timeout],
          _idleStart: 6682,
          _onTimeout: [Function: bound ],
          _timerArgs: undefined,
          _repeat: null,
          _destroyed: false,
          [Symbol(refed)]: false,
          [Symbol(kHasPrimitive)]: false,
          [Symbol(asyncId)]: 2504,
          [Symbol(triggerId)]: 2502,
          [Symbol(kAsyncContextFrame)]: undefined
        },
        [Symbol(kBuffer)]: null,
        [Symbol(kBufferCb)]: null,
        [Symbol(kBufferGen)]: null,
        [Symbol(shapeMode)]: true,
        [Symbol(kCapture)]: false,
        [Symbol(kSetNoDelay)]: true,
        [Symbol(kSetKeepAlive)]: true,
        [Symbol(kSetKeepAliveInitialDelay)]: 1,
        [Symbol(kBytesRead)]: 0,
        [Symbol(kBytesWritten)]: 0
      },
      _consuming: false,
      _dumped: false,
      req: [Circular *2],
      _eventsCount: 4,
      responseUrl: 'http://localhost:8001/educator/turn',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: {
        date: 'Thu, 25 Dec 2025 18:39:43 GMT',
        server: 'uvicorn',
        'content-length': '76',
        'content-type': 'application/json',
        'x-request-id': 'test-thread-id',
        'x-response-time': '0.012s'
      },
      [Symbol(kHeadersCount)]: 12,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: false,
    host: 'localhost',
    protocol: 'http:',
    _redirectable: Writable {
      _events: {
        close: undefined,
        error: [Function: handleRequestError],
        prefinish: undefined,
        finish: undefined,
        drain: undefined,
        response: [Function: handleResponse],
        socket: [
          [Function: handleRequestSocket],
          [Function: destroyOnTimeout]
        ],
        timeout: undefined,
        abort: undefined
      },
      _writableState: WritableState {
        highWaterMark: 16384,
        length: 0,
        corked: 0,
        onwrite: [Function: bound onwrite],
        writelen: 0,
        bufferedIndex: 0,
        pendingcb: 0,
        [Symbol(kState)]: 17580812,
        [Symbol(kBufferedValue)]: null
      },
      _maxListeners: undefined,
      _options: {
        maxRedirects: 21,
        maxBodyLength: Infinity,
        protocol: 'http:',
        path: '/educator/turn',
        method: 'POST',
        headers: [Object: null prototype] {
          Accept: 'application/json, text/plain, */*',
          'Content-Type': 'application/json',
          'X-Signature': 'sha256=cbb9e5400a51f0323f684423723817acf5f864ecf94deae7211b5029aea602f3',
          'X-Correlation-ID': 'test-thread-id',
          'X-Request-ID': 'test-thread-id',
          'User-Agent': 'axios/1.13.2',
          'Content-Length': '633',
          'Accept-Encoding': 'gzip, compress, deflate, br'
        },
        agents: {
          http: undefined,
          https: undefined
        },
        auth: undefined,
        family: undefined,
        beforeRedirect: [Function: dispatchBeforeRedirect],
        beforeRedirects: {
          proxy: [Function: beforeRedirect]
        },
        http2Options: undefined,
        hostname: 'localhost',
        port: '8001',
        agent: undefined,
        nativeProtocols: {
          'http:': {
            _connectionListener: [Function: connectionListener],
            METHODS: [Array],
            STATUS_CODES: [Object],
            Agent: [Function],
            ClientRequest: [Function: ClientRequest],
            IncomingMessage: [Function: IncomingMessage],
            OutgoingMessage: [Function: OutgoingMessage],
            Server: [Function: Server],
            ServerResponse: [Function: ServerResponse],
            createServer: [Function: createServer],
            validateHeaderName: [Function],
            validateHeaderValue: [Function],
            get: [Function: get],
            request: [Function: request],
            setMaxIdleHTTPParsers: [Function: setMaxIdleHTTPParsers],
            maxHeaderSize: [Getter],
            globalAgent: [Getter/Setter],
            WebSocket: [Getter],
            CloseEvent: [Getter],
            MessageEvent: [Getter]
          },
          'https:': {
            Agent: [Function: Agent],
            globalAgent: [Agent],
            Server: [Function: Server],
            createServer: [Function: createServer],
            get: [Function: get],
            request: [Function: request]
          }
        },
        pathname: '/educator/turn'
      },
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 633,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *2],
      _currentUrl: 'http://localhost:8001/educator/turn',
      _timeout: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kChunkedBuffer)]: [],
    [Symbol(kChunkedLength)]: 0,
    [Symbol(kSocket)]: <ref *1> Socket {
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'localhost',
      _closeAfterHandlingError: false,
      _events: {
        close: [Function: onClose],
        error: [Function: bound onceWrapper] {
          listener: [Function: freeSocketErrorListener]
        },
        prefinish: undefined,
        finish: undefined,
        drain: undefined,
        data: undefined,
        end: [Function: onReadableStreamEnd],
        readable: undefined,
        connect: undefined,
        free: [Function: onFree],
        timeout: [
          [Function: onTimeout],
          [Function (anonymous)]
        ],
        agentRemove: [Function: onRemove]
      },
      _readableState: ReadableState {
        highWaterMark: 16384,
        buffer: [],
        bufferIndex: 0,
        length: 0,
        pipes: [],
        awaitDrainWriters: null,
        [Symbol(kState)]: 60303620
      },
      _writableState: WritableState {
        highWaterMark: 16384,
        length: 0,
        corked: 0,
        onwrite: [Function: bound onwrite],
        writelen: 0,
        bufferedIndex: 0,
        pendingcb: 0,
        [Symbol(kState)]: 17563908,
        [Symbol(kBufferedValue)]: null,
        [Symbol(kWriteCbValue)]: null
      },
      allowHalfOpen: false,
      _maxListeners: undefined,
      _eventsCount: 6,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: null,
      _server: null,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [
        '::1:8001'
      ],
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: TCP {
        reading: true,
        onconnection: null,
        [Symbol(owner_symbol)]: [Circular *1]
      },
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 6682,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 2504,
        [Symbol(triggerId)]: 2502,
        [Symbol(kAsyncContextFrame)]: undefined
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: true,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0
    },
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [
        'Accept',
        'application/json, text/plain, */*'
      ],
      'content-type': [
        'Content-Type',
        'application/json'
      ],
      'x-signature': [
        'X-Signature',
        'sha256=cbb9e5400a51f0323f684423723817acf5f864ecf94deae7211b5029aea602f3'
      ],
      'x-correlation-id': [
        'X-Correlation-ID',
        'test-thread-id'
      ],
      'x-request-id': [
        'X-Request-ID',
        'test-thread-id'
      ],
      'user-agent': [
        'User-Agent',
        'axios/1.13.2'
      ],
      'content-length': [
        'Content-Length',
        '633'
      ],
      'accept-encoding': [
        'Accept-Encoding',
        'gzip, compress, deflate, br'
      ],
      host: [
        'Host',
        'localhost:8001'
      ]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 500,
    statusText: 'Internal Server Error',
    headers: Object [AxiosHeaders] {
      date: 'Thu, 25 Dec 2025 18:39:43 GMT',
      server: 'uvicorn',
      'content-length': '76',
      'content-type': 'application/json',
      'x-request-id': 'test-thread-id',
      'x-response-time': '0.012s'
    },
    config: {
      transitional: {
        silentJSONParsing: true,
        forcedJSONParsing: true,
        clarifyTimeoutError: false
      },
      adapter: [
        'xhr',
        'http',
        'fetch'
      ],
      transformRequest: [
        [Function: transformRequest]
      ],
      transformResponse: [
        [Function: transformResponse]
      ],
      timeout: 30000,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: {
        FormData: [Function: FormData] {
          LINE_BREAK: '\r\n',
          DEFAULT_CONTENT_TYPE: 'application/octet-stream'
        },
        Blob: [class Blob]
      },
      validateStatus: [Function: validateStatus],
      headers: Object [AxiosHeaders] {
        Accept: 'application/json, text/plain, */*',
        'Content-Type': 'application/json',
        'X-Signature': 'sha256=cbb9e5400a51f0323f684423723817acf5f864ecf94deae7211b5029aea602f3',
        'X-Correlation-ID': 'test-thread-id',
        'X-Request-ID': 'test-thread-id',
        'User-Agent': 'axios/1.13.2',
        'Content-Length': '633',
        'Accept-Encoding': 'gzip, compress, deflate, br'
      },
      cancelToken: CancelToken {
        promise: Promise {
          CanceledError {
            message: 'canceled',
            name: 'CanceledError',
            code: 'ERR_CANCELED'
          },
          then: [Function (anonymous)]
        },
        _listeners: [],
        reason: CanceledError {
          message: 'canceled',
          name: 'CanceledError',
          code: 'ERR_CANCELED'
        }
      },
      method: 'post',
      url: 'http://localhost:8001/educator/turn',
      data: '{"promptMessage":{"text":"What is the main idea of this article?","actorRole":"LEARNER","threadId":"test-thread-id","readingSessionId":"99f6833e-a87d-4084-ab78-0fa1e0dd35c4","clientTs":"2025-12-25T18:39:44.029Z","metadata":{"uiMode":"DURING","contentId":"553122c6-a697-4dff-90a5-bca1ad0181aa","assetLayer":"L1","readingIntent":"analytical","tenantId":"633cb093-ccbd-4534-afc4-b97774f63894","userId":"633cb093-ccbd-4534-afc4-b97774f63894","pedState":{},"lastTurns":[],"contentSlice":"Article content","memoriesTopK":6,"contextPlan":{"prefixVersion":"CANONICAL_PREFIX_V1","lastTurnsWindow":6,"memoriesTopK":6,"contentSliceChars":15}}}}',
      allowAbsoluteUrls: true
    },
    request: <ref *2> ClientRequest {
      _events: [Object: null prototype] {
        abort: [Function (anonymous)],
        aborted: [Function (anonymous)],
        connect: [Function (anonymous)],
        error: [Function (anonymous)],
        socket: [Function (anonymous)],
        timeout: [Function (anonymous)],
        finish: [Function: requestOnFinish]
      },
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: 633,
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      _header: 'POST /educator/turn HTTP/1.1\r\nAccept: application/json, text/plain, */*\r\nContent-Type: application/json\r\nX-Signature: sha256=cbb9e5400a51f0323f684423723817acf5f864ecf94deae7211b5029aea602f3\r\nX-Correlation-ID: test-thread-id\r\nX-Request-ID: test-thread-id\r\nUser-Agent: axios/1.13.2\r\nContent-Length: 633\r\nAccept-Encoding: gzip, compress, deflate, br\r\nHost: localhost:8001\r\nConnection: keep-alive\r\n\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: Agent {
        _events: [Object: null prototype] {
          free: [Function (anonymous)],
          newListener: [Function: maybeEnableKeylog]
        },
        _eventsCount: 2,
        _maxListeners: undefined,
        options: [Object: null prototype] {
          keepAlive: true,
          scheduling: 'lifo',
          timeout: 5000,
          proxyEnv: undefined,
          noDelay: true,
          path: null
        },
        defaultPort: 80,
        protocol: 'http:',
        requests: [Object: null prototype] {},
        sockets: [Object: null prototype] {},
        freeSockets: [Object: null prototype] {
          'localhost:8001:': [
            [Socket]
          ]
        },
        keepAliveMsecs: 1000,
        keepAlive: true,
        maxSockets: Infinity,
        maxFreeSockets: 256,
        scheduling: 'lifo',
        maxTotalSockets: Infinity,
        totalSocketCount: 1,
        agentKeepAliveTimeoutBuffer: 1000,
        [Symbol(shapeMode)]: false,
        [Symbol(kCapture)]: false
      },
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/educator/turn',
      _ended: true,
      res: IncomingMessage {
        _events: {
          close: undefined,
          error: [Function: handleStreamError],
          data: [Function: handleStreamData],
          end: [
            [Function: responseOnEnd],
            [Function: handleStreamEnd]
          ],
          readable: undefined,
          aborted: [Function: handlerStreamAborted]
        },
        _readableState: ReadableState {
          highWaterMark: 16384,
          buffer: [],
          bufferIndex: 0,
          length: 0,
          pipes: [],
          awaitDrainWriters: null,
          [Symbol(kState)]: 194779004
        },
        _maxListeners: undefined,
        socket: null,
        httpVersionMajor: 1,
        httpVersionMinor: 1,
        httpVersion: '1.1',
        complete: true,
        rawHeaders: [
          'date',
          'Thu, 25 Dec 2025 18:39:43 GMT',
          'server',
          'uvicorn',
          'content-length',
          '76',
          'content-type',
          'application/json',
          'x-request-id',
          'test-thread-id',
          'x-response-time',
          '0.012s'
        ],
        rawTrailers: [],
        joinDuplicateHeaders: undefined,
        aborted: false,
        upgrade: false,
        url: '',
        method: null,
        statusCode: 500,
        statusMessage: 'Internal Server Error',
        client: <ref *1> Socket {
          connecting: false,
          _hadError: false,
          _parent: null,
          _host: 'localhost',
          _closeAfterHandlingError: false,
          _events: {
            close: [Function: onClose],
            error: [Function],
            prefinish: undefined,
            finish: undefined,
            drain: undefined,
            data: undefined,
            end: [Function: onReadableStreamEnd],
            readable: undefined,
            connect: undefined,
            free: [Function: onFree],
            timeout: [Array],
            agentRemove: [Function: onRemove]
          },
          _readableState: ReadableState {
            highWaterMark: 16384,
            buffer: [],
            bufferIndex: 0,
            length: 0,
            pipes: [],
            awaitDrainWriters: null,
            [Symbol(kState)]: 60303620
          },
          _writableState: WritableState {
            highWaterMark: 16384,
            length: 0,
            corked: 0,
            onwrite: [Function: bound onwrite],
            writelen: 0,
            bufferedIndex: 0,
            pendingcb: 0,
            [Symbol(kState)]: 17563908,
            [Symbol(kBufferedValue)]: null,
            [Symbol(kWriteCbValue)]: null
          },
          allowHalfOpen: false,
          _maxListeners: undefined,
          _eventsCount: 6,
          _sockname: null,
          _pendingData: null,
          _pendingEncoding: '',
          server: null,
          _server: null,
          timeout: 5000,
          parser: null,
          _httpMessage: null,
          autoSelectFamilyAttemptedAddresses: [
            '::1:8001'
          ],
          [Symbol(async_id_symbol)]: -1,
          [Symbol(kHandle)]: TCP {
            reading: true,
            onconnection: null,
            [Symbol(owner_symbol)]: [Circular *1]
          },
          [Symbol(lastWriteQueueSize)]: 0,
          [Symbol(timeout)]: Timeout {
            _idleTimeout: 5000,
            _idlePrev: [TimersList],
            _idleNext: [Timeout],
            _idleStart: 6682,
            _onTimeout: [Function: bound ],
            _timerArgs: undefined,
            _repeat: null,
            _destroyed: false,
            [Symbol(refed)]: false,
            [Symbol(kHasPrimitive)]: false,
            [Symbol(asyncId)]: 2504,
            [Symbol(triggerId)]: 2502,
            [Symbol(kAsyncContextFrame)]: undefined
          },
          [Symbol(kBuffer)]: null,
          [Symbol(kBufferCb)]: null,
          [Symbol(kBufferGen)]: null,
          [Symbol(shapeMode)]: true,
          [Symbol(kCapture)]: false,
          [Symbol(kSetNoDelay)]: true,
          [Symbol(kSetKeepAlive)]: true,
          [Symbol(kSetKeepAliveInitialDelay)]: 1,
          [Symbol(kBytesRead)]: 0,
          [Symbol(kBytesWritten)]: 0
        },
        _consuming: false,
        _dumped: false,
        req: [Circular *2],
        _eventsCount: 4,
        responseUrl: 'http://localhost:8001/educator/turn',
        redirects: [],
        [Symbol(shapeMode)]: true,
        [Symbol(kCapture)]: false,
        [Symbol(kHeaders)]: {
          date: 'Thu, 25 Dec 2025 18:39:43 GMT',
          server: 'uvicorn',
          'content-length': '76',
          'content-type': 'application/json',
          'x-request-id': 'test-thread-id',
          'x-response-time': '0.012s'
        },
        [Symbol(kHeadersCount)]: 12,
        [Symbol(kTrailers)]: null,
        [Symbol(kTrailersCount)]: 0
      },
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: false,
      host: 'localhost',
      protocol: 'http:',
      _redirectable: Writable {
        _events: {
          close: undefined,
          error: [Function: handleRequestError],
          prefinish: undefined,
          finish: undefined,
          drain: undefined,
          response: [Function: handleResponse],
          socket: [
            [Function: handleRequestSocket],
            [Function: destroyOnTimeout]
          ],
          timeout: undefined,
          abort: undefined
        },
        _writableState: WritableState {
          highWaterMark: 16384,
          length: 0,
          corked: 0,
          onwrite: [Function: bound onwrite],
          writelen: 0,
          bufferedIndex: 0,
          pendingcb: 0,
          [Symbol(kState)]: 17580812,
          [Symbol(kBufferedValue)]: null
        },
        _maxListeners: undefined,
        _options: {
          maxRedirects: 21,
          maxBodyLength: Infinity,
          protocol: 'http:',
          path: '/educator/turn',
          method: 'POST',
          headers: [Object: null prototype] {
            Accept: 'application/json, text/plain, */*',
            'Content-Type': 'application/json',
            'X-Signature': 'sha256=cbb9e5400a51f0323f684423723817acf5f864ecf94deae7211b5029aea602f3',
            'X-Correlation-ID': 'test-thread-id',
            'X-Request-ID': 'test-thread-id',
            'User-Agent': 'axios/1.13.2',
            'Content-Length': '633',
            'Accept-Encoding': 'gzip, compress, deflate, br'
          },
          agents: {
            http: undefined,
            https: undefined
          },
          auth: undefined,
          family: undefined,
          beforeRedirect: [Function: dispatchBeforeRedirect],
          beforeRedirects: {
            proxy: [Function: beforeRedirect]
          },
          http2Options: undefined,
          hostname: 'localhost',
          port: '8001',
          agent: undefined,
          nativeProtocols: {
            'http:': [Object],
            'https:': [Object]
          },
          pathname: '/educator/turn'
        },
        _ended: true,
        _ending: true,
        _redirectCount: 0,
        _redirects: [],
        _requestBodyLength: 633,
        _requestBodyBuffers: [],
        _eventsCount: 3,
        _onNativeResponse: [Function (anonymous)],
        _currentRequest: [Circular *2],
        _currentUrl: 'http://localhost:8001/educator/turn',
        _timeout: null,
        [Symbol(shapeMode)]: true,
        [Symbol(kCapture)]: false
      },
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kChunkedBuffer)]: [],
      [Symbol(kChunkedLength)]: 0,
      [Symbol(kSocket)]: <ref *1> Socket {
        connecting: false,
        _hadError: false,
        _parent: null,
        _host: 'localhost',
        _closeAfterHandlingError: false,
        _events: {
          close: [Function: onClose],
          error: [Function: bound onceWrapper] {
            listener: [Function: freeSocketErrorListener]
          },
          prefinish: undefined,
          finish: undefined,
          drain: undefined,
          data: undefined,
          end: [Function: onReadableStreamEnd],
          readable: undefined,
          connect: undefined,
          free: [Function: onFree],
          timeout: [
            [Function: onTimeout],
            [Function (anonymous)]
          ],
          agentRemove: [Function: onRemove]
        },
        _readableState: ReadableState {
          highWaterMark: 16384,
          buffer: [],
          bufferIndex: 0,
          length: 0,
          pipes: [],
          awaitDrainWriters: null,
          [Symbol(kState)]: 60303620
        },
        _writableState: WritableState {
          highWaterMark: 16384,
          length: 0,
          corked: 0,
          onwrite: [Function: bound onwrite],
          writelen: 0,
          bufferedIndex: 0,
          pendingcb: 0,
          [Symbol(kState)]: 17563908,
          [Symbol(kBufferedValue)]: null,
          [Symbol(kWriteCbValue)]: null
        },
        allowHalfOpen: false,
        _maxListeners: undefined,
        _eventsCount: 6,
        _sockname: null,
        _pendingData: null,
        _pendingEncoding: '',
        server: null,
        _server: null,
        timeout: 5000,
        parser: null,
        _httpMessage: null,
        autoSelectFamilyAttemptedAddresses: [
          '::1:8001'
        ],
        [Symbol(async_id_symbol)]: -1,
        [Symbol(kHandle)]: TCP {
          reading: true,
          onconnection: null,
          [Symbol(owner_symbol)]: [Circular *1]
        },
        [Symbol(lastWriteQueueSize)]: 0,
        [Symbol(timeout)]: Timeout {
          _idleTimeout: 5000,
          _idlePrev: [TimersList],
          _idleNext: [Timeout],
          _idleStart: 6682,
          _onTimeout: [Function: bound ],
          _timerArgs: undefined,
          _repeat: null,
          _destroyed: false,
          [Symbol(refed)]: false,
          [Symbol(kHasPrimitive)]: false,
          [Symbol(asyncId)]: 2504,
          [Symbol(triggerId)]: 2502,
          [Symbol(kAsyncContextFrame)]: undefined
        },
        [Symbol(kBuffer)]: null,
        [Symbol(kBufferCb)]: null,
        [Symbol(kBufferGen)]: null,
        [Symbol(shapeMode)]: true,
        [Symbol(kCapture)]: false,
        [Symbol(kSetNoDelay)]: true,
        [Symbol(kSetKeepAlive)]: true,
        [Symbol(kSetKeepAliveInitialDelay)]: 1,
        [Symbol(kBytesRead)]: 0,
        [Symbol(kBytesWritten)]: 0
      },
      [Symbol(kOutHeaders)]: [Object: null prototype] {
        accept: [
          'Accept',
          'application/json, text/plain, */*'
        ],
        'content-type': [
          'Content-Type',
          'application/json'
        ],
        'x-signature': [
          'X-Signature',
          'sha256=cbb9e5400a51f0323f684423723817acf5f864ecf94deae7211b5029aea602f3'
        ],
        'x-correlation-id': [
          'X-Correlation-ID',
          'test-thread-id'
        ],
        'x-request-id': [
          'X-Request-ID',
          'test-thread-id'
        ],
        'user-agent': [
          'User-Agent',
          'axios/1.13.2'
        ],
        'content-length': [
          'Content-Length',
          '633'
        ],
        'accept-encoding': [
          'Accept-Encoding',
          'gzip, compress, deflate, br'
        ],
        host: [
          'Host',
          'localhost:8001'
        ]
      },
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: {
      detail: 'Failed to process educator turn: All connection attempts failed'
    }
  },
  status: 500
}
[Nest] 34600  - 25/12/2025, 15:39:44   ERROR [ExceptionsHandler] Error: Failed to communicate with AI Service
    at AiServiceClient.sendPrompt (C:\projects\aprendeai-app\services\api\src\ai-service\ai-service.client.ts:98:13)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at ReadingSessionsService.processPrompt (C:\projects\aprendeai-app\services\api\src\sessions\reading-sessions.service.ts:591:24)
FAIL test/integration/solo-sessions.integration.spec.ts (6.237 s)
  Sprint 2: Solo Sessions (Integration)
    GET /sessions/:id - Enhanced Response
      ‚àö should return session with content, messages, and quickReplies (43 ms)
      ‚àö should return empty messages and quickReplies for new session (18 ms)
      √ó should expose file.storageKey if content has file (25 ms)
      ‚àö should return 404 for non-existent session (24 ms)
      ‚àö should return 403 for session owned by another user (36 ms)
    POST /sessions/:id/prompt - Message Persistence
      √ó should create session event when sending prompt (92 ms)

  ‚óè Sprint 2: Solo Sessions (Integration) ‚Ä∫ GET /sessions/:id - Enhanced Response ‚Ä∫ should expose file.storageKey if content has file

    expected 200 "OK", got 500 "Internal Server Error"

      198 |         .get(`/api/v1/sessions/${testSessionId}`)
      199 |         .set("Authorization", `Bearer ${authToken}`)
    > 200 |         .expect(200);
          |          ^
      201 |
      202 |       expect(response.body.content.file).toBeDefined();
      203 |       expect(response.body.content.file.storageKey).toBe(

      at Object.<anonymous> (test/integration/solo-sessions.integration.spec.ts:200:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Sprint 2: Solo Sessions (Integration) ‚Ä∫ POST /sessions/:id/prompt - Message Persistence ‚Ä∫ should create session event when sending prompt

    expected 201 "Created", got 500 "Internal Server Error"

      311 |           },
      312 |         })
    > 313 |         .expect(201);
          |          ^
      314 |
      315 |       // Verify response has nextPrompt and quickReplies
      316 |       expect(response.body).toHaveProperty("nextPrompt");

      at Object.<anonymous> (test/integration/solo-sessions.integration.spec.ts:313:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

Test Suites: 1 failed, 1 total
Tests:       2 failed, 4 passed, 6 total
Snapshots:   0 total
Time:        6.431 s, estimated 12 s
Ran all test suites matching /test\\integration\\solo-sessions.integration.spec.ts/i.
Jest did not exit one second after the test run has completed.

'This usually means that there are asynchronous operations that weren't stopped in your tests. Consider running Jest with `--detectOpenHandles` to troubleshoot this issue.
[Nest] 34600  - 25/12/2025, 15:39:45   ERROR [QueueConsumerService] Failed to start consumer: Channel closed
