
> api@0.0.1 test:integration
> jest --config ./test/jest-integration.config.js --testPathPattern=family.spec

  console.log
    [FamilyService.create] BEFORE UPDATE: { userId: '774e2a70-34f4-40cf-9d71-682bedebd635', currentSettings: {} }

      at ../src/family/family.service.ts:50:15

  console.log
    [FamilyService.create] AFTER UPDATE - Set primaryFamilyId: bd5cfe2b-aa7e-4a7b-89a8-5483f352de22

      at ../src/family/family.service.ts:62:15

  console.log
    Inviting new user: newuser@family-test.com

      at FamilyService.inviteMember (../src/family/family.service.ts:164:16)

  console.log
    [FamilyService.create] BEFORE UPDATE: {
      userId: '774e2a70-34f4-40cf-9d71-682bedebd635',
      currentSettings: { primaryFamilyId: 'bd5cfe2b-aa7e-4a7b-89a8-5483f352de22' }
    }

      at ../src/family/family.service.ts:50:15

  console.log
    [FamilyService.create] AFTER UPDATE - Set primaryFamilyId: 80317c86-a82d-461f-8d80-bcdac3c6fa7d

      at ../src/family/family.service.ts:62:15

  console.log
    [FamilyService.create] BEFORE UPDATE: {
      userId: '774e2a70-34f4-40cf-9d71-682bedebd635',
      currentSettings: { primaryFamilyId: '80317c86-a82d-461f-8d80-bcdac3c6fa7d' }
    }

      at ../src/family/family.service.ts:50:15

  console.log
    [FamilyService.create] AFTER UPDATE - Set primaryFamilyId: bc463a56-6bb9-4495-a984-d91d01645e34

      at ../src/family/family.service.ts:62:15

FAIL test/integration/family.spec.ts (6.237 s)
  Family Plan (Integration)
    Authentication Setup
      √ should register and login owner user (199 ms)
    POST /families
      √ should create family with current user as owner (49 ms)
      √ should create owner membership record (2 ms)
      √ should return family with members array (17 ms)
    GET /families
      √ should list all families user belongs to (13 ms)
    POST /families/:id/invite
      √ should add existing user as GUARDIAN (100 ms)
      √ should create placeholder user for new email (26 ms)
      √ should reject duplicate invitations (18 ms)
      √ should only allow owner to invite members (134 ms)
    POST /families/:id/transfer-ownership
      √ should transfer ownership to existing member (28 ms)
      √ should prevent non-owner from transferring (10 ms)
    POST /families/:id/primary
      √ should set family as primary for user (15 ms)
      √ should only allow family members to set as primary (134 ms)
    GET /families/:id/billing-hierarchy (NOT IMPLEMENTED)
      ○ skipped should resolve to primary family
      ○ skipped should fall back to user scope if no families
    DELETE /families/:id
      √ should delete family and all members (14 ms)
      √ should only allow owner to delete family (63 ms)
      √ should return 404 if family does not exist (7 ms)
    Multi-Family Scenarios
      √ should create second family (18 ms)
      √ should list both families (10 ms)
      √ should switch primary family (10 ms)
      × should resolve billing to new primary family (4 ms)

  ● Family Plan (Integration) › Multi-Family Scenarios › should resolve billing to new primary family

    expected 200 "OK", got 404 "Not Found"

      482 |         .get(apiUrl(ROUTES.FAMILY.BILLING_HIERARCHY(secondFamilyId)))
      483 |         .set('Authorization', `Bearer ${authToken}`)
    > 484 |         .expect(200);
          |          ^
      485 |
      486 |       expect(response.body.scopeId).toBe(secondFamilyId);
      487 |     });

      at Object.<anonymous> (integration/family.spec.ts:484:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

Test Suites: 1 failed, 1 total
Tests:       1 failed, 2 skipped, 19 passed, 22 total
Snapshots:   0 total
Time:        6.451 s, estimated 17 s
Ran all test suites matching /family.spec/i.
