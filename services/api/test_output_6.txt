
> api@0.0.1 test
> jest institutions.integration.spec.ts

FAIL test/integration/institutions.integration.spec.ts (6.405 s)
  Institutional Registration (Integration)
    Setup: Create Admin User and Institution
      √ should register admin user (192 ms)
      √ should create institution (16 ms)
    POST /institutions/:id/invites - Invite Flow
      √ should create institution invite (30 ms)
      × should register user with invite token (75 ms)
      × should mark invite as used (2 ms)
    POST /institutions/:id/domains - Domain Flow
      √ should add domain with auto-approve (15 ms)
      √ should auto-approve registration for domain email (76 ms)
    POST /institutions/:id/pending - Manual Approval Flow
      √ should create pending approval instead of user (71 ms)
      √ should list pending approvals (14 ms)
      √ should approve pending user (32 ms)
    DELETE /institutions/:id/invites/:inviteId - Cancel Invite
      √ should cancel invitation (16 ms)
    GET /institutions/:id/invites - List Invites
      × should list all invites for institution (11 ms)
    GET /institutions/:id/domains - List Domains
      √ should list all domains for institution (11 ms)

  ● Institutional Registration (Integration) › POST /institutions/:id/invites - Invite Flow › should register user with invite token

    TypeError: Cannot read properties of null (reading 'role')

      154 |
      155 |       expect(member).toBeDefined();
    > 156 |       expect(member.role).toBe('TEACHER');
          |                     ^
      157 |       expect(member.status).toBe('ACTIVE');
      158 |     });
      159 |

      at Object.<anonymous> (test/integration/institutions.integration.spec.ts:156:21)

  ● Institutional Registration (Integration) › POST /institutions/:id/invites - Invite Flow › should mark invite as used

    expect(received).not.toBeNull()

    Received: null

      163 |       });
      164 |
    > 165 |       expect(invite.usedAt).not.toBeNull();
          |                                 ^
      166 |     });
      167 |   });
      168 |

      at Object.<anonymous> (test/integration/institutions.integration.spec.ts:165:33)

  ● Institutional Registration (Integration) › GET /institutions/:id/invites - List Invites › should list all invites for institution

    expect(received).not.toBeNull()

    Received: null

      343 |       const teacherInvite = response.body.find(i => i.email === 'teacher@inst-test.com');
      344 |       expect(teacherInvite).toBeDefined();
    > 345 |       expect(teacherInvite.usedAt).not.toBeNull();
          |                                        ^
      346 |     });
      347 |   });
      348 |

      at Object.<anonymous> (test/integration/institutions.integration.spec.ts:345:40)

Test Suites: 1 failed, 1 total
Tests:       3 failed, 10 passed, 13 total
Snapshots:   0 total
Time:        6.63 s, estimated 9 s
Ran all test suites matching /institutions.integration.spec.ts/i.
