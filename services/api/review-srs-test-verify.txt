FAIL test/integration/review-srs.spec.ts (7.997 s)
  Review & SRS Integration Tests
    GET /review/queue - Queue Retrieval
      × should return empty queue when no due items (29 ms)
      × should return due vocabulary items (11 ms)
      × should NOT return future items (8 ms)
      × should respect daily review cap (43 ms)
    POST /review/attempt - SRS Transitions
      × should transition NEW + OK -> D1 (24 ms)
      × should transition with FAIL -> D1 (reset) (17 ms)
      × should update due date correctly for D30 (17 ms)
      × should record attempt in history (11 ms)
    SRS Edge Cases
      × should keep MASTERED on OK (10 ms)
      × should regress MASTERED on FAIL (7 ms)

  ● Review & SRS Integration Tests › GET /review/queue - Queue Retrieval › should return empty queue when no due items

    expected 200 "OK", got 404 "Not Found"

      101 |         .get(apiUrl('review/queue'))
      102 |         .set('Authorization', authToken)
    > 103 |         .expect(200);
          |          ^
      104 |       
      105 |       expect(response.body).toEqual([]);
      106 |     });

      at Object.<anonymous> (integration/review-srs.spec.ts:103:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Review & SRS Integration Tests › GET /review/queue - Queue Retrieval › should return due vocabulary items

    expected 200 "OK", got 404 "Not Found"

      122 |         .get(apiUrl('review/queue'))
      123 |         .set('Authorization', authToken)
    > 124 |         .expect(200);
          |          ^
      125 |       
      126 |       expect(response.body.length).toBeGreaterThan(0);
      127 |       expect(response.body[0].word).toBe('test');

      at Object.<anonymous> (integration/review-srs.spec.ts:124:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Review & SRS Integration Tests › GET /review/queue - Queue Retrieval › should NOT return future items

    expected 200 "OK", got 404 "Not Found"

      144 |         .get(apiUrl('review/queue'))
      145 |         .set('Authorization', authToken)
    > 146 |         .expect(200);
          |          ^
      147 |       
      148 |       expect(response.body).toEqual([]);
      149 |     });

      at Object.<anonymous> (integration/review-srs.spec.ts:146:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Review & SRS Integration Tests › GET /review/queue - Queue Retrieval › should respect daily review cap

    expected 200 "OK", got 404 "Not Found"

      171 |         .get(apiUrl('review/queue'))
      172 |         .set('Authorization', authToken)
    > 173 |         .expect(200);
          |          ^
      174 |       
      175 |       expect(response.body.length).toBeLessThanOrEqual(20);
      176 |     });

      at Object.<anonymous> (integration/review-srs.spec.ts:173:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Review & SRS Integration Tests › POST /review/attempt - SRS Transitions › should transition NEW + OK -> D1

    expected 200 "OK", got 404 "Not Found"

      206 |           result: 'OK',
      207 |         })
    > 208 |         .expect(200);
          |          ^
      209 |       
      210 |       expect(response.body.srsStage).toBe('D1');
      211 |       expect(response.body.dueAt).toBeDefined();

      at Object.<anonymous> (integration/review-srs.spec.ts:208:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Review & SRS Integration Tests › POST /review/attempt - SRS Transitions › should transition with FAIL -> D1 (reset)

    expected 200 "OK", got 404 "Not Found"

      226 |           result: 'FAIL',
      227 |         })
    > 228 |         .expect(200);
          |          ^
      229 |       
      230 |       expect(response.body.srsStage).toBe('D1');
      231 |       expect(response.body.lapseCount).toBeGreaterThan(0);

      at Object.<anonymous> (integration/review-srs.spec.ts:228:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Review & SRS Integration Tests › POST /review/attempt - SRS Transitions › should update due date correctly for D30

    expected 200 "OK", got 404 "Not Found"

      248 |           result: 'OK',  // D14 + OK -> D30
      249 |         })
    > 250 |         .expect(200);
          |          ^
      251 |       
      252 |       expect(response.body.srsStage).toBe('D30');
      253 |       

      at Object.<anonymous> (integration/review-srs.spec.ts:250:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Review & SRS Integration Tests › POST /review/attempt - SRS Transitions › should record attempt in history

    expected 200 "OK", got 404 "Not Found"

      268 |           result: 'OK',
      269 |         })
    > 270 |         .expect(200);
          |          ^
      271 |       
      272 |       // TODO: Update schema - vocabItemId doesn't exist in VocabAttempt where clause
      273 |       // const attempts = await prisma.vocabAttempt.findMany({

      at Object.<anonymous> (integration/review-srs.spec.ts:270:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Review & SRS Integration Tests › SRS Edge Cases › should keep MASTERED on OK

    expected 200 "OK", got 404 "Not Found"

      306 |           result: 'OK',
      307 |         })
    > 308 |         .expect(200);
          |          ^
      309 |       
      310 |       expect(response.body.srsStage).toBe('MASTERED');
      311 |     });

      at Object.<anonymous> (integration/review-srs.spec.ts:308:10)
      ----
      at Test._assertStatus (../node_modules/supertest/lib/test.js:252:14)
      at ../node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (../node_modules/supertest/lib/test.js:285:13)
      at Test.assert (../node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (../node_modules/supertest/lib/test.js:120:14)

  ● Review & SRS Integration Tests › SRS Edge Cases › should regress MASTERED on FAIL

    PrismaClientKnownRequestError: 
    Invalid `prisma.userVocabulary.create()` invocation in
    C:\projects\aprendeai-app\services\api\test\integration\review-srs.spec.ts:287:49

      284 let vocabId: string;
      285 
      286 beforeEach(async () => {
    → 287   const vocab = await prisma.userVocabulary.create(
    Unique constraint failed on the fields: (`user_id`,`word`,`language`)

      285 |     
      286 |     beforeEach(async () => {
    > 287 |       const vocab = await prisma.userVocabulary.create({
          |                     ^
      288 |         data: {
      289 |           userId: testUserId,
      290 |           contentId: testContentId,

      at $n.handleRequestError (../node_modules/@prisma/client/runtime/library.js:121:7315)
      at $n.handleAndLogRequestError (../node_modules/@prisma/client/runtime/library.js:121:6623)
      at $n.request (../node_modules/@prisma/client/runtime/library.js:121:6307)
      at l (../node_modules/@prisma/client/runtime/library.js:130:9633)
      at Object.<anonymous> (integration/review-srs.spec.ts:287:21)

Test Suites: 1 failed, 1 total
Tests:       10 failed, 10 total
Snapshots:   0 total
Time:        8.192 s
Ran all test suites matching /test\\integration\\review-srs.spec.ts/i.
