datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ========================================
// Enums
// ========================================

enum UserRole {
  ADMIN // Full system admin access
  SUPPORT // View dashboards, logs, impersonation
  OPS // Dashboards, flags, limits, queues
  INSTITUTION_ADMIN // Manages own institution
  TEACHER
  STUDENT
  COMMON_USER
}

enum ScopeType {
  GLOBAL
  INSTITUTION
  USER
}

enum Environment {
  DEV
  STAGING
  PROD
}

enum InstitutionType {
  SCHOOL
  UNIVERSITY
  COURSE
  OTHER
}

enum ContentType {
  NEWS
  ARXIV
  SCHOOL_MATERIAL
  PDF
  IMAGE
  DOCX
  ARTICLE
}

enum Language {
  PT_BR
  EN
  KO
}

enum LibraryStatus {
  SAVED
  IN_PROGRESS
  COMPLETED
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
}

enum LessonStatus {
  LOCKED
  AVAILABLE
  IN_PROGRESS
  COMPLETED
}

enum DailyGoalType {
  MINUTES
  LESSONS
}

// ========================================
// Core Models
// ========================================

model Institution {
  id        String          @id @default(uuid())
  name      String
  type      InstitutionType
  city      String?
  state     String?
  country   String?
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")

  users       User[]
  classes     Class[]
  contents    Content[]
  assessments Assessment[]

  @@map("institutions")
}

model User {
  id                 String       @id @default(uuid())
  institutionId      String?      @map("institution_id")
  institution        Institution? @relation(fields: [institutionId], references: [id])
  name               String
  email              String       @unique
  passwordHash       String       @map("password_hash")
  role               UserRole
  schoolingLevel     String       @map("schooling_level")
  age                Int?
  sex                String?
  preferredLanguages Json         @default("[]") @map("preferred_languages")
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")

  // Relations
  enrollments        ClassStudent[]
  createdContents    Content[]         @relation("ContentCreator")
  ownedContents      Content[]         @relation("ContentOwner")
  libraryItems       UserLibraryItem[]
  readingSessions    ReadingSession[]
  assessmentAttempts AssessmentAttempt[]
  dailyGoals         DailyGoal[]
  dailyActivities    DailyActivity[]
  streak             Streak?
  cornellNotes       CornellNote[]     // Legacy
  cornellNotesEntries CornellNotes[]   @relation("UserCornellNotes")
  highlights         Highlight[]       @relation("UserHighlights")
  vocabularyEntries  UserVocabulary[]
  assignedBadges     UserBadge[]

  // Admin Console
  roleAssignments UserRoleAssignment[] @relation("UserRoles")
  lastLoginAt     DateTime?            @map("last_login_at")
  status          String               @default("ACTIVE")

  @@map("users")
}

model Class {
  id            String      @id @default(uuid())
  institutionId String      @map("institution_id")
  institution   Institution @relation(fields: [institutionId], references: [id])
  name          String
  gradeLevel    String      @map("grade_level")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  students ClassStudent[]

  @@map("classes")
}

model ClassStudent {
  classId   String @map("class_id")
  studentId String @map("student_id")
  class     Class  @relation(fields: [classId], references: [id])
  student   User   @relation(fields: [studentId], references: [id])

  @@id([classId, studentId])
  @@map("class_students")
}

model Course {
  id          String   @id @default(uuid())
  title       String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  lessons Lesson[]

  @@map("courses")
}

model Lesson {
  id               String   @id @default(uuid())
  courseId         String   @map("course_id")
  course           Course   @relation(fields: [courseId], references: [id])
  title            String
  orderIndex       Int      @map("order_index")
  estimatedMinutes Int      @map("estimated_minutes")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  contentId String?  @map("content_id")
  content   Content? @relation(fields: [contentId], references: [id])

  progress LessonProgress[]

  @@map("lessons")
}

model LessonProgress {
  id          String       @id @default(uuid())
  userId      String       @map("user_id")
  lessonId    String       @map("lesson_id")
  lesson      Lesson       @relation(fields: [lessonId], references: [id])
  status      LessonStatus @default(AVAILABLE)
  progressPct Int          @default(0) @map("progress_pct")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  @@unique([userId, lessonId])
  @@map("lesson_progress")
}

model Content {
  id               String       @id @default(uuid())
  institutionId    String?      @map("institution_id")
  institution      Institution? @relation(fields: [institutionId], references: [id])
  type             ContentType
  sourceId         String?      @map("source_id")
  title            String
  sourceUrl        String?      @map("source_url")
  originalLanguage Language     @map("original_language")
  rawText          String       @map("raw_text") @db.Text
  metadata         Json?
  
  // Cornell Reader fields
  ownerUserId      String?      @map("owner_user_id")
  ownerUser        User?        @relation("ContentOwner", fields: [ownerUserId], references: [id])
  scopeType        SubscriptionScope?
  scopeId          String?      @map("scope_id")
  fileId           String?      @map("file_id")
  file             File?        @relation(fields: [fileId], references: [id])
  languageGuess    String?      @map("language_guess")
  
  createdBy        String?      @map("created_by")
  creator          User?        @relation("ContentCreator", fields: [createdBy], references: [id])
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")
  
  // Cornell Reader relations
  cornellNotes     CornellNotes[]
  highlights       Highlight[]
  extractions      ContentExtraction[]
  
  versions        ContentVersion[]
  libraryItems    UserLibraryItem[]
  readingSessions ReadingSession[]
  assessments     Assessment[]
  lessons         Lesson[]

  @@map("contents")
}

model ContentVersion {
  id                   String   @id @default(uuid())
  contentId            String   @map("content_id")
  content              Content  @relation(fields: [contentId], references: [id])
  targetLanguage       Language @map("target_language")
  schoolingLevelTarget String   @map("schooling_level_target")
  simplifiedText       String   @map("simplified_text") @db.Text
  summary              String?  @db.Text
  vocabularyGlossary   Json?    @map("vocabulary_glossary")
  createdAt            DateTime @default(now()) @map("created_at")

  libraryItems    UserLibraryItem[]
  readingSessions ReadingSession[]
  assessments     Assessment[]

  @@map("content_versions")
}

model UserLibraryItem {
  id               String          @id @default(uuid())
  userId           String          @map("user_id")
  user             User            @relation(fields: [userId], references: [id])
  contentId        String          @map("content_id")
  content          Content         @relation(fields: [contentId], references: [id])
  contentVersionId String?         @map("content_version_id")
  contentVersion   ContentVersion? @relation(fields: [contentVersionId], references: [id])
  status           LibraryStatus   @default(SAVED)
  lastAccessedAt   DateTime        @default(now()) @map("last_accessed_at")
  createdAt        DateTime        @default(now()) @map("created_at")

  @@map("user_library_items")
}

model ReadingSession {
  id               String          @id @default(uuid())
  userId           String          @map("user_id")
  user             User            @relation(fields: [userId], references: [id])
  contentId        String          @map("content_id")
  content          Content         @relation(fields: [contentId], references: [id])
  contentVersionId String?         @map("content_version_id")
  contentVersion   ContentVersion? @relation(fields: [contentVersionId], references: [id])
  startedAt        DateTime        @default(now()) @map("started_at")
  finishedAt       DateTime?       @map("finished_at")

  cornellNotes CornellNote[]

  @@map("reading_sessions")
}

model CornellNote {
  id               String         @id @default(uuid())
  userId           String         @map("user_id")
  user             User           @relation(fields: [userId], references: [id])
  readingSessionId String         @map("reading_session_id")
  readingSession   ReadingSession @relation(fields: [readingSessionId], references: [id])
  mainNotes        Json           @map("main_notes")
  cueColumn        String?        @map("cue_column") @db.Text
  summary          String?        @db.Text
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")

  @@map("legacy_cornell_notes")
}

model Assessment {
  id                   String          @id @default(uuid())
  contentId            String          @map("content_id")
  content              Content         @relation(fields: [contentId], references: [id])
  contentVersionId     String?         @map("content_version_id")
  contentVersion       ContentVersion? @relation(fields: [contentVersionId], references: [id])
  institutionId        String?         @map("institution_id")
  institution          Institution?    @relation(fields: [institutionId], references: [id])
  schoolingLevelTarget String          @map("schooling_level_target")
  createdAt            DateTime        @default(now()) @map("created_at")
  updatedAt            DateTime        @updatedAt @map("updated_at")

  questions AssessmentQuestion[]
  attempts  AssessmentAttempt[]

  @@map("assessments")
}

model AssessmentQuestion {
  id            String       @id @default(uuid())
  assessmentId  String       @map("assessment_id")
  assessment    Assessment   @relation(fields: [assessmentId], references: [id])
  questionType  QuestionType @map("question_type")
  questionText  String       @map("question_text") @db.Text
  options       Json?
  correctAnswer Json         @map("correct_answer")
  skills        String[]     @default([])

  answers AssessmentAnswer[]

  @@map("assessment_questions")
}

model AssessmentAttempt {
  id           String     @id @default(uuid())
  assessmentId String     @map("assessment_id")
  assessment   Assessment @relation(fields: [assessmentId], references: [id])
  userId       String     @map("user_id")
  user         User       @relation(fields: [userId], references: [id])
  startedAt    DateTime   @default(now()) @map("started_at")
  finishedAt   DateTime?  @map("finished_at")
  scoreRaw     Float?     @map("score_raw")
  scorePercent Float?     @map("score_percent")

  answers AssessmentAnswer[]

  @@map("assessment_attempts")
}

model AssessmentAnswer {
  id                  String             @id @default(uuid())
  assessmentAttemptId String             @map("assessment_attempt_id")
  assessmentAttempt   AssessmentAttempt  @relation(fields: [assessmentAttemptId], references: [id])
  questionId          String             @map("question_id")
  question            AssessmentQuestion @relation(fields: [questionId], references: [id])
  userAnswer          Json               @map("user_answer")
  isCorrect           Boolean            @map("is_correct")
  timeSpentSeconds    Int?               @map("time_spent_seconds")

  @@map("assessment_answers")
}

// ========================================
// Gamification
// ========================================

model DailyGoal {
  id        String        @id @default(uuid())
  userId    String        @map("user_id")
  user      User          @relation(fields: [userId], references: [id])
  goalType  DailyGoalType @map("goal_type")
  goalValue Int           @map("goal_value")
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  @@map("daily_goals")
}

model DailyActivity {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  user             User     @relation(fields: [userId], references: [id])
  date             DateTime @db.Date
  minutesSpent     Int      @default(0) @map("minutes_spent")
  lessonsCompleted Int      @default(0) @map("lessons_completed")
  goalMet          Boolean  @default(false) @map("goal_met")
  createdAt        DateTime @default(now()) @map("created_at")

  @@unique([userId, date])
  @@map("daily_activities")
}

model Streak {
  userId          String    @id @map("user_id")
  user            User      @relation(fields: [userId], references: [id])
  currentStreak   Int       @default(0) @map("current_streak")
  bestStreak      Int       @default(0) @map("best_streak")
  lastGoalMetDate DateTime? @map("last_goal_met_date") @db.Date
  freezeTokens    Int       @default(1) @map("freeze_tokens")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("streaks")
}

model Badge {
  id          String  @id @default(uuid())
  code        String  @unique
  name        String
  description String
  imageUrl    String? @map("image_url")

  userBadges UserBadge[]

  @@map("badges")
}

model UserBadge {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id])
  badgeId   String   @map("badge_id")
  badge     Badge    @relation(fields: [badgeId], references: [id])
  awardedAt DateTime @default(now()) @map("awarded_at")

  @@unique([userId, badgeId])
  @@map("user_badges")
}

model UserVocabulary {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  user         User     @relation(fields: [userId], references: [id])
  word         String
  language     Language
  masteryScore Int      @default(0) @map("mastery_score")
  lastSeenAt   DateTime @default(now()) @map("last_seen_at")

  @@unique([userId, word, language])
  @@map("user_vocabularies")
}

// ========================================
// Admin Console - Phase 1: RBAC & Audit
// ========================================

model UserRoleAssignment {
  id        String     @id @default(uuid())
  userId    String     @map("user_id")
  user      User       @relation("UserRoles", fields: [userId], references: [id], onDelete: Cascade)
  role      UserRole
  scopeType ScopeType? @map("scope_type")
  scopeId   String?    @map("scope_id")
  createdAt DateTime   @default(now()) @map("created_at")
  createdBy String?    @map("created_by")

  @@unique([userId, role, scopeType, scopeId])
  @@index([userId])
  @@index([role])
  @@map("user_role_assignments")
}

model AuditLog {
  id           String    @id @default(uuid())
  actorUserId  String?   @map("actor_user_id")
  actorRole    UserRole? @map("actor_role")
  action       String
  resourceType String    @map("resource_type")
  resourceId   String?   @map("resource_id")
  requestId    String?   @map("request_id")
  ip           String?
  userAgent    String?   @map("user_agent")
  beforeJson   Json?     @map("before_json")
  afterJson    Json?     @map("after_json")
  reason       String?
  createdAt    DateTime  @default(now()) @map("created_at")

  @@index([actorUserId])
  @@index([action])
  @@index([resourceType])
  @@index([createdAt])
  @@index([requestId])
  @@map("audit_logs")
}

model FeatureFlag {
  id          String       @id @default(uuid())
  key         String       @unique
  name        String
  description String?
  enabled     Boolean      @default(false)
  environment Environment?
  scopeType   ScopeType?   @map("scope_type")
  scopeId     String?      @map("scope_id")
  createdBy   String?      @map("created_by")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  @@index([key])
  @@index([enabled])
  @@map("feature_flags")
}

model IntegrationSecret {
  id             String       @id @default(uuid())
  key            String       @unique
  name           String
  provider       String?
  encryptedValue String       @map("encrypted_value") @db.Text
  encryptedDek   String       @map("encrypted_dek")
  iv             String
  authTag        String       @map("auth_tag")
  keyId          String       @map("key_id") @default("v1")
  environment    Environment?
  lastRotatedAt  DateTime?    @map("last_rotated_at")
  createdBy      String?      @map("created_by")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  @@index([key])
  @@index([provider])
  @@map("integration_secrets")
}

model SystemMetric {
  id        String   @id @default(uuid())
  metric    String   // e.g., "api_latency", "api_requests", "errors"
  value     Float    // Numeric value (count, avg, sum)
  tags      Json?    // Additional metadata (endpoint, status, provider)
  timestamp DateTime @default(now())
  bucket    String   // Time bucket: "1m", "1h", "1d"

  @@index([metric, timestamp])
  @@index([bucket])
  @@map("system_metrics")
}

model ErrorLog {
  id         String   @id @default(uuid())
  message    String
  stack      String?  @db.Text
  endpoint   String?
  method     String?
  statusCode Int?     @map("status_code")
  userId     String?  @map("user_id")
  requestId  String?  @map("request_id")
  metadata   Json?    // Request body, headers, etc.
  timestamp  DateTime @default(now())
  resolved   Boolean  @default(false)

  @@index([timestamp])
  @@index([resolved])
  @@index([endpoint])
  @@map("error_logs")
}

model ProviderUsage {
  id         String   @id @default(uuid())
  provider   String   // "openai", "kci", "aws"
  operation  String   // "completion", "embedding", "search"
  tokens     Int?     // For LLM providers
  cost       Float?   // Estimated cost in USD
  latency    Int?     // Response time in ms
  statusCode Int?     @map("status_code")
  userId     String?  @map("user_id")
  metadata   Json?    // Model, temperature, etc.
  timestamp  DateTime @default(now())

  @@index([provider, timestamp])
  @@index([userId])
  @@map("provider_usage")
}

model BackgroundJob {
  id          String    @id @default(uuid())
  jobName     String    @map("job_name")
  status      JobStatus
  startedAt   DateTime  @map("started_at")
  completedAt DateTime? @map("completed_at")
  duration    Int?      // Duration in ms
  error       String?   @db.Text
  metadata    Json?

  @@index([jobName, status])
  @@index([startedAt])
  @@map("background_jobs")
}

enum JobStatus {
  RUNNING
  COMPLETED
  FAILED
}

model AppConfig {
  id          String      @id @default(uuid())
  key         String      @unique // e.g., "openai.api_key", "app.max_upload_size"
  value       String      @db.Text // JSON or simple value
  type        ConfigType  // STRING, NUMBER, BOOLEAN, JSON, SECRET_REF
  category    String      // "provider", "app", "feature"
  environment Environment? // DEV, STAGING, PROD, null = all
  description String?
  metadata    Json?       // Validation rules, UI hints
  createdBy   String?     @map("created_by")
  updatedBy   String?     @map("updated_by")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  @@index([key])
  @@index([category])
  @@index([environment])
  @@map("app_configs")
}

enum ConfigType {
  STRING
  NUMBER
  BOOLEAN
  JSON
  SECRET_REF
}

// ============================================
// BILLING SYSTEM (SaaS Monetization)
// ============================================

model Plan {
  id            String         @id @default(uuid())
  code          String         @unique // FREE, PRO, INSTITUTION
  name          String
  description   String?
  isActive      Boolean        @default(true) @map("is_active")
  entitlements  Json           // {features: {...}, limits: {...}}
  monthlyPrice  Float?         @map("monthly_price")
  yearlyPrice   Float?         @map("yearly_price")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  
  subscriptions Subscription[]
  
  @@index([code])
  @@index([isActive])
  @@map("plans")
}

model Subscription {
  id                      String              @id @default(uuid())
  scopeType               SubscriptionScope   @map("scope_type")
  scopeId                 String              @map("scope_id")
  planId                  String              @map("plan_id")
  plan                    Plan                @relation(fields: [planId], references: [id])
  status                  SubscriptionStatus
  source                  SubscriptionSource
  currentPeriodStart      DateTime?           @map("current_period_start")
  currentPeriodEnd        DateTime?           @map("current_period_end")
  cancelAtPeriodEnd       Boolean             @default(false) @map("cancel_at_period_end")
  providerCode            String?             @map("provider_code")
  providerCustomerId      String?             @map("provider_customer_id")
  providerSubscriptionId  String?             @map("provider_subscription_id")
  providerPriceId         String?             @map("provider_price_id")
  createdAt               DateTime            @default(now()) @map("created_at")
  updatedAt               DateTime            @updatedAt @map("updated_at")
  
  @@unique([scopeType, scopeId, status], name: "unique_active_subscription", map: "subscriptions_scope_status_unique")
  @@index([scopeType, scopeId])
  @@index([planId])
  @@index([status])
  @@map("subscriptions")
}

model EntitlementOverride {
  id          String            @id @default(uuid())
  scopeType   SubscriptionScope @map("scope_type")
  scopeId     String            @map("scope_id")
  overrides   Json
  reason      String
  updatedBy   String            @map("updated_by")
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")
  
  @@unique([scopeType, scopeId])
  @@map("entitlement_overrides")
}

model UsageEvent {
  id            String            @id @default(uuid())
  environment   Environment
  occurredAt    DateTime          @map("occurred_at")
  scopeType     SubscriptionScope @map("scope_type")
  scopeId       String            @map("scope_id")
  providerCode  String?           @map("provider_code")
  endpoint      String?
  metric        String
  quantity      Float
  approxCostUsd Float?            @map("approx_cost_usd")
  requestId     String?           @map("request_id")
  userId        String?           @map("user_id")
  metadata      Json?
  createdAt     DateTime          @default(now()) @map("created_at")
  
  @@index([scopeType, scopeId, metric, occurredAt])
  @@index([occurredAt])
  @@index([metric])
  @@map("usage_events")
}

model BillingEvent {
  id              String    @id @default(uuid())
  providerCode    String    @map("provider_code")
  providerEventId String    @unique @map("provider_event_id")
  eventType       String    @map("event_type")
  payload         Json
  processedAt     DateTime? @map("processed_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  
  @@index([providerCode])
  @@index([processedAt])
  @@map("billing_events")
}

enum SubscriptionScope {
  USER
  INSTITUTION
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  TRIALING
  PAST_DUE
  CANCELED
}

enum SubscriptionSource {
  INTERNAL
  PAYMENT_PROVIDER
}

// ==========================================
// Cornell Reader Models
// ==========================================
model File {
  id               String    @id @default(uuid())
  storageProvider  String
  storageKey       String
  mimeType         String
  sizeBytes        BigInt
  checksumSha256   String?
  originalFilename String?
  createdAt        DateTime  @default(now())
  contents         Content[]
  @@index([storageProvider, storageKey])
  @@map("files")
}
model CornellNotes {
  id           String   @id @default(uuid())
  contentId    String
  content      Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  userId       String
  user         User     @relation("UserCornellNotes", fields: [userId], references: [id])
  cuesJson     Json     @default("[]")
  notesJson    Json     @default("[]")
  summaryText  String   @default("")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now())
  @@unique([contentId, userId])
  @@index([contentId])
  @@index([userId])
  @@map("cornell_notes")
}
enum HighlightKind {
  TEXT
  AREA
}
enum TargetType {
  PDF
  IMAGE
  DOCX
}
model Highlight {
  id           String        @id @default(uuid())
  contentId    String
  content      Content       @relation(fields: [contentId], references: [id], onDelete: Cascade)
  userId       String
  user         User          @relation("UserHighlights", fields: [userId], references: [id])
  kind         HighlightKind
  targetType   TargetType
  pageNumber   Int?
  anchorJson   Json
  colorKey     String        @default("yellow")
  commentText  String?
  tagsJson     Json          @default("[]")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @default(now())
  @@index([contentId])
  @@index([userId])
  @@map("highlights")
}
enum ExtractionStatus {
  PENDING
  RUNNING
  DONE
  FAILED
}
model ContentExtraction {
  id              String           @id @default(uuid())
  contentId       String
  content         Content          @relation(fields: [contentId], references: [id], onDelete: Cascade)
  status          ExtractionStatus @default(PENDING)
  extractedTextRef String?
  metadataJson    Json?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @default(now())
  @@map("content_extractions")
}
