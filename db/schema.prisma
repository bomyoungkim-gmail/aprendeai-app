datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [pgvector(map: "vector")]
}

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

enum UserRole {
  ADMIN_INSTITUTION
  TEACHER
  STUDENT
  COMMON_USER
}

enum InstitutionType {
  SCHOOL
  UNIVERSITY
  COURSE
  OTHER
}

enum ContentType {
  NEWS
  ARXIV
  SCHOOL_MATERIAL
}

enum Language {
  PT_BR
  EN
  KO
}

enum LibraryStatus {
  SAVED
  IN_PROGRESS
  COMPLETED
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
}

model Institution {
  id          String   @id @default(uuid())
  name        String
  type        InstitutionType
  city        String?
  state       String?
  country     String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users       User[]
  classes     Class[]
  contents    Content[]
  assessments Assessment[]

  @@map("institutions")
}

model User {
  id                String   @id @default(uuid())
  institutionId     String?  @map("institution_id")
  institution       Institution? @relation(fields: [institutionId], references: [id])
  name              String
  email             String   @unique
  passwordHash      String   @map("password_hash")
  role              UserRole
  schoolingLevel    String   @map("schooling_level") // e.g. "5_EF", "1_EM", "ADULT"
  age               Int?
  sex               String?
  preferredLanguages Json     @default("[]") @map("preferred_languages") // ["pt-BR", "en"]
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  enrollments       ClassStudent[]
  createdContents   Content[]
  libraryItems      UserLibraryItem[]
  readingSessions   ReadingSession[]
  assessmentAttempts AssessmentAttempt[]

  @@map("users")
}

model Class {
  id            String   @id @default(uuid())
  institutionId String   @map("institution_id")
  institution   Institution @relation(fields: [institutionId], references: [id])
  name          String
  gradeLevel    String   @map("grade_level")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  students      ClassStudent[]

  @@map("classes")
}

model ClassStudent {
  classId   String @map("class_id")
  studentId String @map("student_id")
  class     Class  @relation(fields: [classId], references: [id])
  student   User   @relation(fields: [studentId], references: [id])

  @@id([classId, studentId])
  @@map("class_students")
}

model Content {
  id              String      @id @default(uuid())
  institutionId   String?     @map("institution_id")
  institution     Institution? @relation(fields: [institutionId], references: [id])
  type            ContentType
  sourceId        String?     @map("source_id") // External ID (arxiv, etc)
  title           String
  originalLanguage Language   @map("original_language")
  rawText         String      @map("raw_text") @db.Text
  metadata        Json?
  createdBy       String?     @map("created_by") // if teacher created
  creator         User?       @relation(fields: [createdBy], references: [id])
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  versions        ContentVersion[]
  libraryItems    UserLibraryItem[]
  readingSessions ReadingSession[]
  assessments     Assessment[]

  @@map("contents")
}

model ContentVersion {
  id                  String   @id @default(uuid())
  contentId           String   @map("content_id")
  content             Content  @relation(fields: [contentId], references: [id])
  targetLanguage      Language @map("target_language")
  schoolingLevelTarget String  @map("schooling_level_target")
  simplifiedText      String   @map("simplified_text") @db.Text
  summary             String?  @db.Text
  vocabularyGlossary  Json?    @map("vocabulary_glossary")
  createdAt           DateTime @default(now()) @map("created_at")

  libraryItems     UserLibraryItem[]
  readingSessions  ReadingSession[]
  assessments      Assessment[]

  @@map("content_versions")
}

model UserLibraryItem {
  id               String          @id @default(uuid())
  userId           String          @map("user_id")
  user             User            @relation(fields: [userId], references: [id])
  contentId        String          @map("content_id")
  content          Content         @relation(fields: [contentId], references: [id])
  contentVersionId String?         @map("content_version_id")
  contentVersion   ContentVersion? @relation(fields: [contentVersionId], references: [id])
  status           LibraryStatus   @default(SAVED)
  lastAccessedAt   DateTime        @default(now()) @map("last_accessed_at")
  createdAt        DateTime        @default(now()) @map("created_at")

  @@map("user_library_items")
}

model ReadingSession {
  id               String          @id @default(uuid())
  userId           String          @map("user_id")
  user             User            @relation(fields: [userId], references: [id])
  contentId        String          @map("content_id")
  content          Content         @relation(fields: [contentId], references: [id])
  contentVersionId String?         @map("content_version_id")
  contentVersion   ContentVersion? @relation(fields: [contentVersionId], references: [id])
  startedAt        DateTime        @default(now()) @map("started_at")
  finishedAt       DateTime?       @map("finished_at")

  cornellNotes     CornellNote[]

  @@map("reading_sessions")
}

model CornellNote {
  id               String         @id @default(uuid())
  readingSessionId String         @map("reading_session_id")
  readingSession   ReadingSession @relation(fields: [readingSessionId], references: [id])
  mainNotes        Json           @map("main_notes") // Slate/Lexical JSON
  cueColumn        String?        @map("cue_column") @db.Text
  summary          String?        @db.Text
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")

  @@map("cornell_notes")
}

model Assessment {
  id                   String          @id @default(uuid())
  contentId            String          @map("content_id")
  content              Content         @relation(fields: [contentId], references: [id])
  contentVersionId     String?         @map("content_version_id")
  contentVersion       ContentVersion? @relation(fields: [contentVersionId], references: [id])
  institutionId        String?         @map("institution_id")
  institution          Institution?    @relation(fields: [institutionId], references: [id])
  schoolingLevelTarget String          @map("schooling_level_target")
  createdAt            DateTime        @default(now()) @map("created_at")
  updatedAt            DateTime        @updatedAt @map("updated_at")

  questions            AssessmentQuestion[]
  attempts             AssessmentAttempt[]

  @@map("assessments")
}

model AssessmentQuestion {
  id            String       @id @default(uuid())
  assessmentId  String       @map("assessment_id")
  assessment    Assessment   @relation(fields: [assessmentId], references: [id])
  questionType  QuestionType @map("question_type")
  questionText  String       @map("question_text") @db.Text
  options       Json?        // List of options
  correctAnswer Json         @map("correct_answer") // Index or text
  
  answers       AssessmentAnswer[]

  @@map("assessment_questions")
}

model AssessmentAttempt {
  id           String     @id @default(uuid())
  assessmentId String     @map("assessment_id")
  assessment   Assessment @relation(fields: [assessmentId], references: [id])
  userId       String     @map("user_id")
  user         User       @relation(fields: [userId], references: [id])
  startedAt    DateTime   @default(now()) @map("started_at")
  finishedAt   DateTime?  @map("finished_at")
  scoreRaw     Float?     @map("score_raw")
  scorePercent Float?     @map("score_percent")

  answers      AssessmentAnswer[]

  @@map("assessment_attempts")
}

model AssessmentAnswer {
  id                  String            @id @default(uuid())
  assessmentAttemptId String            @map("assessment_attempt_id")
  assessmentAttempt   AssessmentAttempt @relation(fields: [assessmentAttemptId], references: [id])
  questionId          String            @map("question_id")
  question            AssessmentQuestion @relation(fields: [questionId], references: [id])
  userAnswer          Json              @map("user_answer")
  isCorrect           Boolean           @map("is_correct")
  timeSpentSeconds    Int?              @map("time_spent_seconds")

  @@map("assessment_answers")
}
