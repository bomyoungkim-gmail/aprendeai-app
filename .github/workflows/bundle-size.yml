name: Bundle Size Tracker

on:
  pull_request:
    paths:
      - 'frontend/**'
  push:
    branches:
      - main

jobs:
  bundle-size:
    name: Track Bundle Size
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for comparison
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build production bundle
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Analyze bundle size
        run: |
          echo "## ðŸ“¦ Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get bundle sizes
          TOTAL_SIZE=$(du -sh .next/static | cut -f1)
          JS_SIZE=$(find .next/static/chunks -name "*.js" -type f -exec du -ch {} + | grep total | cut -f1)
          CSS_SIZE=$(find .next/static/css -name "*.css" -type f -exec du -ch {} + | grep total | cut -f1)
          
          echo "| Metric | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Static | $TOTAL_SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "| JavaScript | $JS_SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "| CSS | $CSS_SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # List largest chunks
          echo "### ðŸ” Largest Chunks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find .next/static/chunks -name "*.js" -type f -exec du -h {} + | sort -rh | head -10
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        shell: bash
      
      - name: Compare with main branch (PR only)
        if: github.event_name == 'pull_request'
        run: |
          # Checkout main branch
          git fetch origin main
          git checkout origin/main
          
          # Build main branch
          npm ci
          npm run build
          
          # Get main branch size
          MAIN_SIZE=$(du -s .next/static | cut -f1)
          
          # Checkout PR branch
          git checkout ${{ github.sha }}
          npm ci
          npm run build
          
          # Get PR branch size
          PR_SIZE=$(du -s .next/static | cut -f1)
          
          # Calculate difference
          DIFF=$((PR_SIZE - MAIN_SIZE))
          DIFF_PCT=$(awk "BEGIN {printf \"%.2f\", ($DIFF / $MAIN_SIZE) * 100}")
          
          echo "## ðŸ“Š Size Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | Size (KB) | Change |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| main | $MAIN_SIZE | - |" >> $GITHUB_STEP_SUMMARY
          echo "| PR | $PR_SIZE | ${DIFF_PCT}% |" >> $GITHUB_STEP_SUMMARY
          
          # Fail if bundle grew by more than 5%
          if (( $(echo "$DIFF_PCT > 5" | bc -l) )); then
            echo "::error::Bundle size increased by ${DIFF_PCT}% (limit: 5%)"
            exit 1
          fi
        shell: bash
      
      - name: Upload bundle stats
        uses: actions/upload-artifact@v3
        with:
          name: bundle-stats
          path: frontend/.next/static
          retention-days: 30
